<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SpringConfig å¾®æœåŠ¡ | é™¤éä¸–ç•Œé¢ å€’</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/Welcome/img/logo.svg">
    <meta name="description" content="èƒèŸ¹ä¸èƒ½å‰¥æˆ‘çš„å£³ï¼Œç¬”è®°æœ¬ä¸å¯èƒ½åœ¨å†™æˆ‘ï¼Œæˆ‘ä¸å¯èƒ½è½åœ¨æ«å¶ä¸Šé›ªèŠ±ä¸Šï¼Œè€Œä½ ä¸å¯èƒ½æƒ³æˆ‘ ...">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/Welcome/assets/css/0.styles.dc2e030a.css" as="style"><link rel="preload" href="/Welcome/assets/js/app.516fe79a.js" as="script"><link rel="preload" href="/Welcome/assets/js/8.d7055a2e.js" as="script"><link rel="preload" href="/Welcome/assets/js/1.ed48a7ee.js" as="script"><link rel="preload" href="/Welcome/assets/js/2.9a3f7cc9.js" as="script"><link rel="preload" href="/Welcome/assets/js/45.2c55d04e.js" as="script"><link rel="prefetch" href="/Welcome/assets/js/10.4c48ef06.js"><link rel="prefetch" href="/Welcome/assets/js/11.b879bea0.js"><link rel="prefetch" href="/Welcome/assets/js/12.fb12f646.js"><link rel="prefetch" href="/Welcome/assets/js/13.cbffec13.js"><link rel="prefetch" href="/Welcome/assets/js/14.b6f5f3af.js"><link rel="prefetch" href="/Welcome/assets/js/15.a2131606.js"><link rel="prefetch" href="/Welcome/assets/js/16.7c225af7.js"><link rel="prefetch" href="/Welcome/assets/js/17.40d10b01.js"><link rel="prefetch" href="/Welcome/assets/js/18.82c76934.js"><link rel="prefetch" href="/Welcome/assets/js/19.e7b2182d.js"><link rel="prefetch" href="/Welcome/assets/js/20.c46f9d92.js"><link rel="prefetch" href="/Welcome/assets/js/21.ea337a55.js"><link rel="prefetch" href="/Welcome/assets/js/22.547bbcbf.js"><link rel="prefetch" href="/Welcome/assets/js/23.ead5e6a4.js"><link rel="prefetch" href="/Welcome/assets/js/24.9e0e72ad.js"><link rel="prefetch" href="/Welcome/assets/js/25.fa8f4d05.js"><link rel="prefetch" href="/Welcome/assets/js/26.1bf3f67c.js"><link rel="prefetch" href="/Welcome/assets/js/27.ce57d01c.js"><link rel="prefetch" href="/Welcome/assets/js/28.cb29c565.js"><link rel="prefetch" href="/Welcome/assets/js/29.6907ddfb.js"><link rel="prefetch" href="/Welcome/assets/js/30.0be5fc4c.js"><link rel="prefetch" href="/Welcome/assets/js/31.6bde0d5c.js"><link rel="prefetch" href="/Welcome/assets/js/32.34f5889a.js"><link rel="prefetch" href="/Welcome/assets/js/33.2ca0ef80.js"><link rel="prefetch" href="/Welcome/assets/js/34.1717fdcc.js"><link rel="prefetch" href="/Welcome/assets/js/35.61737fc1.js"><link rel="prefetch" href="/Welcome/assets/js/36.7894ed75.js"><link rel="prefetch" href="/Welcome/assets/js/37.d90e4b65.js"><link rel="prefetch" href="/Welcome/assets/js/38.d1659e09.js"><link rel="prefetch" href="/Welcome/assets/js/39.caf6790b.js"><link rel="prefetch" href="/Welcome/assets/js/4.ffe2048e.js"><link rel="prefetch" href="/Welcome/assets/js/40.2504a486.js"><link rel="prefetch" href="/Welcome/assets/js/41.e7130bc9.js"><link rel="prefetch" href="/Welcome/assets/js/42.f7f7482f.js"><link rel="prefetch" href="/Welcome/assets/js/43.ac1c5fa2.js"><link rel="prefetch" href="/Welcome/assets/js/44.ef3652d5.js"><link rel="prefetch" href="/Welcome/assets/js/46.c4a65d3f.js"><link rel="prefetch" href="/Welcome/assets/js/47.8638023b.js"><link rel="prefetch" href="/Welcome/assets/js/48.72ce0eb1.js"><link rel="prefetch" href="/Welcome/assets/js/49.7cd3e27c.js"><link rel="prefetch" href="/Welcome/assets/js/5.2488397c.js"><link rel="prefetch" href="/Welcome/assets/js/50.a03b85bf.js"><link rel="prefetch" href="/Welcome/assets/js/51.589a3c46.js"><link rel="prefetch" href="/Welcome/assets/js/52.981c99fd.js"><link rel="prefetch" href="/Welcome/assets/js/53.fde74635.js"><link rel="prefetch" href="/Welcome/assets/js/54.2e2de828.js"><link rel="prefetch" href="/Welcome/assets/js/55.852d6024.js"><link rel="prefetch" href="/Welcome/assets/js/56.564b7e6b.js"><link rel="prefetch" href="/Welcome/assets/js/57.d15d395d.js"><link rel="prefetch" href="/Welcome/assets/js/58.ebd73e0e.js"><link rel="prefetch" href="/Welcome/assets/js/59.bea36105.js"><link rel="prefetch" href="/Welcome/assets/js/6.c8f2a0bc.js"><link rel="prefetch" href="/Welcome/assets/js/60.57e264e0.js"><link rel="prefetch" href="/Welcome/assets/js/61.81888b14.js"><link rel="prefetch" href="/Welcome/assets/js/62.d702fe6e.js"><link rel="prefetch" href="/Welcome/assets/js/63.1a728d38.js"><link rel="prefetch" href="/Welcome/assets/js/64.615fdf3a.js"><link rel="prefetch" href="/Welcome/assets/js/65.9bdbf700.js"><link rel="prefetch" href="/Welcome/assets/js/66.f4fbf76c.js"><link rel="prefetch" href="/Welcome/assets/js/67.6a2b7047.js"><link rel="prefetch" href="/Welcome/assets/js/68.4cde8bed.js"><link rel="prefetch" href="/Welcome/assets/js/69.08639d21.js"><link rel="prefetch" href="/Welcome/assets/js/7.72ca8d8f.js"><link rel="prefetch" href="/Welcome/assets/js/70.7fad46c9.js"><link rel="prefetch" href="/Welcome/assets/js/71.b87426aa.js"><link rel="prefetch" href="/Welcome/assets/js/72.7cbdc58c.js"><link rel="prefetch" href="/Welcome/assets/js/73.44891a19.js"><link rel="prefetch" href="/Welcome/assets/js/74.9fdab749.js"><link rel="prefetch" href="/Welcome/assets/js/75.d1888288.js"><link rel="prefetch" href="/Welcome/assets/js/76.3613c476.js"><link rel="prefetch" href="/Welcome/assets/js/77.c6781ffc.js"><link rel="prefetch" href="/Welcome/assets/js/78.4ce73b88.js"><link rel="prefetch" href="/Welcome/assets/js/79.d12ac054.js"><link rel="prefetch" href="/Welcome/assets/js/80.6738b1b4.js"><link rel="prefetch" href="/Welcome/assets/js/81.4373868b.js"><link rel="prefetch" href="/Welcome/assets/js/82.39b65938.js"><link rel="prefetch" href="/Welcome/assets/js/83.3a50d1b3.js"><link rel="prefetch" href="/Welcome/assets/js/84.bf35700b.js"><link rel="prefetch" href="/Welcome/assets/js/85.f76275c9.js"><link rel="prefetch" href="/Welcome/assets/js/86.485da767.js"><link rel="prefetch" href="/Welcome/assets/js/87.d19016fa.js"><link rel="prefetch" href="/Welcome/assets/js/9.73227006.js">
    <link rel="stylesheet" href="/Welcome/assets/css/0.styles.dc2e030a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="theme-container" class="theme-container post-container no-sidebar" data-v-60b9a85e><header class="navbar invert" data-v-60b9a85e><a href="/Welcome/" class="home-link router-link-active"><span class="site-name"> $ cd /home/ </span></a> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/Welcome/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path d="M489.2 287.9h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6V146.2c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-6-8-4.6-11.7-4.6v-38c8.3-2 17.1-3.4 25.7-3.4 10.9 0 20.9 4.3 31.4 4.3 4.6 0 27.7-1.1 27.7-8v-60c0-2.6-2-4.6-4.6-4.6-5.1 0-15.1 4.3-24 4.3-9.7 0-20.9-4.3-32.6-4.3-8 0-16 1.1-23.7 2.9v-4.9c5.4-2.6 9.1-8.3 9.1-14.3 0-20.7-31.4-20.8-31.4 0 0 6 3.7 11.7 9.1 14.3v111.7c-3.7 0-11.7-1.4-11.7 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32H128v-32c0-2.6-2-4.6-4.6-4.6H96c-2.6 0-4.6 2-4.6 4.6v178.3H54.8v-32c0-2.6-2-4.6-4.6-4.6H22.8c-2.6 0-4.6 2-4.6 4.6V512h182.9v-96c0-72.6 109.7-72.6 109.7 0v96h182.9V292.5c.1-2.6-1.9-4.6-4.5-4.6zm-288.1-4.5c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64zm146.4 0c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64z"/></svg>
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/Welcome/tags/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>
  æ—¶é—´è½´ ğŸ·ï¸
</a></div><div class="nav-item"><a href="/Welcome/links/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path d="M305.45 462.59c7.391 7.298 6.188 20.097-3 25.004-77.714 41.802-176.726 29.91-242.344-35.709-65.602-65.603-77.51-164.523-35.692-242.331 4.891-9.095 17.69-10.298 25.003-3l116.812 116.813 27.394-27.394c-.688-2.61-1.594-5.001-1.594-7.814a32.004 32.004 0 1132.004 32.005c-2.797 0-5.204-.891-7.798-1.594l-27.41 27.41zm206.526-159.523a16.103 16.103 0 01-16.002 17.003H463.86a15.97 15.97 0 01-15.892-15.002C440.467 175.549 336.453 70.534 207.03 63.533a15.845 15.845 0 01-15.002-15.908V16.027A16.094 16.094 0 01209.03.024C372.255 8.62 503.475 139.841 511.976 303.067zm-96.012-.297a16.21 16.21 0 01-16.112 17.3h-32.207a16.069 16.069 0 01-15.893-14.705c-6.907-77.011-68.118-138.91-144.924-145.224a15.94 15.94 0 01-14.8-15.893v-32.114a16.134 16.134 0 0117.3-16.096c110.123 8.501 198.228 96.607 206.636 206.732z"/></svg>
  é“¾æ¥ ğŸŒ
</a></div><div class="nav-item"><a href="/Welcome/docs/aboutMe/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="0 0 24 24" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path fill="none" d="M0 0h24v24H0z"/><path d="M21 18H6a1 1 0 000 2h15v2H6a3 3 0 01-3-3V4a2 2 0 012-2h16v16zm-5-9V7H8v2h8z"/></svg>
  ä¸¾æ¯ â¤
</a></div> <div class="nav-item"><a class="nav-link ov-parent ov-hover" style="cursor: pointer"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="0 0 24 24" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg>
      æœç´¢
    </a></div></nav></div></header> <div class="sidebar-mask" data-v-60b9a85e></div> <aside class="sidebar" data-v-60b9a85e><div class="personal-info-wrapper" data-v-60b9a85e><div class="mobile-hero-avatar" data-v-60b9a85e><img src="https://cdn.jsdelivr.net/gh/LuJunandapai/ApaiImage@main/KaiYu-PicGo/202405241010613.png" alt="hero" data-v-60b9a85e></div> <p class="mobile-heading" data-v-60b9a85e>
          æ«å¶å’Œé›ªèŠ±
        </p> <div class="sns-wrapper" data-v-60b9a85e><a href="https://github.com/LuJunandapai" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" width="0" height="0" viewBox="0 0 0 0" fill="currentColor" class="icon-stack ov-icon" style="font-size:1.2em;"><!----> <svg aria-hidden="true" width="19.2" height="19.2" viewBox="-59.52 -43.52 599.04 599.04" fill="currentColor" class="icon-sns ov-icon ov-inverse" style="font-size:1.2em;"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg></svg></a><a href="https://www.twitter.com/Lu_isApai" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" width="0" height="0" viewBox="0 0 0 0" fill="currentColor" class="icon-stack ov-icon" style="font-size:1.2em;"><!----> <svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="icon-sns ov-icon ov-inverse" style="font-size:1.2em;"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></svg></a><a href="https://www.facebook.com/" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" width="0" height="0" viewBox="0 0 0 0" fill="currentColor" class="icon-stack ov-icon" style="font-size:1.2em;"><!----> <svg aria-hidden="true" width="19.2" height="19.2" viewBox="-139.52 -43.52 599.04 599.04" fill="currentColor" class="icon-sns ov-icon ov-inverse" style="font-size:1.2em;"><path d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"/></svg></svg></a><a href="https://www.linkedin.com/in/" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" width="0" height="0" viewBox="0 0 0 0" fill="currentColor" class="icon-stack ov-icon" style="font-size:1.2em;"><!----> <svg aria-hidden="true" width="19.2" height="19.2" viewBox="-75.52 -43.52 599.04 599.04" fill="currentColor" class="icon-sns ov-icon ov-inverse" style="font-size:1.2em;"><path d="M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 01107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z"/></svg></svg></a><a href="https://www.zhihu.com/people/" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" width="0" height="0" viewBox="0 0 0 0" fill="currentColor" class="icon-stack ov-icon" style="font-size:1.2em;"><!----> <svg aria-hidden="true" width="19.2" height="19.2" viewBox="0 0 24 24" fill="currentColor" class="icon-sns ov-icon ov-inverse" style="font-size:1.2em;"><path fill="none" d="M0 0h24v24H0z"/><path d="M12.344 17.963l-1.688 1.074-2.131-3.35c-.44 1.402-1.172 2.665-2.139 3.825-.402.483-.82.918-1.301 1.375-.155.147-.775.717-.878.82l-1.414-1.414c.139-.139.787-.735.915-.856.43-.408.795-.79 1.142-1.206 1.266-1.518 2.03-3.21 2.137-5.231H3v-2h4V7h-.868c-.689 1.266-1.558 2.222-2.618 2.857L2.486 8.143c1.395-.838 2.425-2.604 3.038-5.36l1.952.434c-.14.633-.303 1.227-.489 1.783H11.5v2H9v4h2.5v2H9.185l3.159 4.963zm3.838-.07L17.298 17H19V7h-4v10h.736l.446.893zM13 5h8v14h-3l-2.5 2-1-2H13V5z"/></svg></svg></a><a href="mailto:lu_yuelian@163.com" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" width="0" height="0" viewBox="0 0 0 0" fill="currentColor" class="icon-stack ov-icon" style="font-size:1.2em;"><!----> <svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="icon-sns ov-icon ov-inverse" style="font-size:1.2em;"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></svg></a>  <a href="/rss.xml" target="_blank" rel="noopener noreferrer"><svg aria-hidden="true" width="0" height="0" viewBox="0 0 0 0" fill="currentColor" class="icon-stack ov-icon" style="font-size:1.2em;"><!----> <svg aria-hidden="true" width="19.2" height="19.2" viewBox="-75.52 -43.52 599.04 599.04" fill="currentColor" class="icon-sns ov-icon ov-inverse" style="font-size:1.2em;"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></svg></a></div> <hr data-v-60b9a85e></div> <nav class="nav-links"><div class="nav-item"><a href="/Welcome/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path d="M489.2 287.9h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6V146.2c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32h-36.6v-32c0-6-8-4.6-11.7-4.6v-38c8.3-2 17.1-3.4 25.7-3.4 10.9 0 20.9 4.3 31.4 4.3 4.6 0 27.7-1.1 27.7-8v-60c0-2.6-2-4.6-4.6-4.6-5.1 0-15.1 4.3-24 4.3-9.7 0-20.9-4.3-32.6-4.3-8 0-16 1.1-23.7 2.9v-4.9c5.4-2.6 9.1-8.3 9.1-14.3 0-20.7-31.4-20.8-31.4 0 0 6 3.7 11.7 9.1 14.3v111.7c-3.7 0-11.7-1.4-11.7 4.6v32h-36.6v-32c0-2.6-2-4.6-4.6-4.6h-27.4c-2.6 0-4.6 2-4.6 4.6v32H128v-32c0-2.6-2-4.6-4.6-4.6H96c-2.6 0-4.6 2-4.6 4.6v178.3H54.8v-32c0-2.6-2-4.6-4.6-4.6H22.8c-2.6 0-4.6 2-4.6 4.6V512h182.9v-96c0-72.6 109.7-72.6 109.7 0v96h182.9V292.5c.1-2.6-1.9-4.6-4.5-4.6zm-288.1-4.5c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64zm146.4 0c0 2.6-2 4.6-4.6 4.6h-27.4c-2.6 0-4.6-2-4.6-4.6v-64c0-2.6 2-4.6 4.6-4.6h27.4c2.6 0 4.6 2 4.6 4.6v64z"/></svg>
  é¦–é¡µ
</a></div><div class="nav-item"><a href="/Welcome/tags/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg>
  æ—¶é—´è½´ ğŸ·ï¸
</a></div><div class="nav-item"><a href="/Welcome/links/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path d="M305.45 462.59c7.391 7.298 6.188 20.097-3 25.004-77.714 41.802-176.726 29.91-242.344-35.709-65.602-65.603-77.51-164.523-35.692-242.331 4.891-9.095 17.69-10.298 25.003-3l116.812 116.813 27.394-27.394c-.688-2.61-1.594-5.001-1.594-7.814a32.004 32.004 0 1132.004 32.005c-2.797 0-5.204-.891-7.798-1.594l-27.41 27.41zm206.526-159.523a16.103 16.103 0 01-16.002 17.003H463.86a15.97 15.97 0 01-15.892-15.002C440.467 175.549 336.453 70.534 207.03 63.533a15.845 15.845 0 01-15.002-15.908V16.027A16.094 16.094 0 01209.03.024C372.255 8.62 503.475 139.841 511.976 303.067zm-96.012-.297a16.21 16.21 0 01-16.112 17.3h-32.207a16.069 16.069 0 01-15.893-14.705c-6.907-77.011-68.118-138.91-144.924-145.224a15.94 15.94 0 01-14.8-15.893v-32.114a16.134 16.134 0 0117.3-16.096c110.123 8.501 198.228 96.607 206.636 206.732z"/></svg>
  é“¾æ¥ ğŸŒ
</a></div><div class="nav-item"><a href="/Welcome/docs/aboutMe/" class="nav-link ov-parent ov-hover"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="0 0 24 24" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path fill="none" d="M0 0h24v24H0z"/><path d="M21 18H6a1 1 0 000 2h15v2H6a3 3 0 01-3-3V4a2 2 0 012-2h16v16zm-5-9V7H8v2h8z"/></svg>
  ä¸¾æ¯ â¤
</a></div> <div class="nav-item"><a class="nav-link ov-parent ov-hover" style="cursor: pointer"><svg aria-hidden="true" width="19.2" height="19.2" viewBox="0 0 24 24" fill="currentColor" class="ov-icon ov-wrench ov-hover" style="font-size:1.2em;"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg>
      æœç´¢
    </a></div></nav> <!----> </aside> <div class="content" data-v-60b9a85e><div class="post-header style-img" style="background-image:url(https://files.codelife.cc/wallhaven/full/vq/wallhaven-vq5z7l.png);" data-v-2c97064e><div class="header-mask" style="background:rgba(40, 57, 101, .4);" data-v-2c97064e></div> <div class="header-content" data-v-2c97064e><div class="tags" data-v-2c97064e><span class="tag" data-v-2c97064e>
        Java
      </span><span class="tag" data-v-2c97064e>
        åç«¯æ¡†æ¶
      </span></div> <h1 class="title" data-v-2c97064e>
      SpringConfig å¾®æœåŠ¡
    </h1> <h3 class="subtitle" data-v-2c97064e>
      Spring Cloud ä½œä¸ºä¸€å¥—å¾®æœåŠ¡æ²»ç†çš„æ¡†æ¶ï¼Œå‡ ä¹è€ƒè™‘åˆ°äº†å¾®æœåŠ¡æ²»ç†çš„æ–¹æ–¹é¢é¢ã€‚
    </h3> <div class="icons" data-v-2c97064e><div class="icon" data-v-2c97064e><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-75.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon" style="font-size:1.2em;" data-v-2c97064e><path d="M313.6 304c-28.7 0-42.5 16-89.6 16-47.1 0-60.8-16-89.6-16C60.2 304 0 364.2 0 438.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-25.6c0-74.2-60.2-134.4-134.4-134.4zM400 464H48v-25.6c0-47.6 38.8-86.4 86.4-86.4 14.6 0 38.3 16 89.6 16 51.7 0 74.9-16 89.6-16 47.6 0 86.4 38.8 86.4 86.4V464zM224 288c79.5 0 144-64.5 144-144S303.5 0 224 0 80 64.5 80 144s64.5 144 144 144zm0-240c52.9 0 96 43.1 96 96s-43.1 96-96 96-96-43.1-96-96 43.1-96 96-96z"/></svg> <span data-v-2c97064e>Lu Da Zhuang</span></div> <div class="icon" data-v-2c97064e><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-75.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon" style="font-size:1.2em;" data-v-2c97064e><path d="M400 64h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zm-6 400H54c-3.3 0-6-2.7-6-6V160h352v298c0 3.3-2.7 6-6 6z"/></svg> <span data-v-2c97064e>2021-06-12</span></div> <div class="icon" data-v-2c97064e><svg aria-hidden="true" width="19.2" height="19.2" viewBox="0 0 24 24" fill="currentColor" class="ov-icon" style="font-size:1.2em;" data-v-2c97064e><path fill="none" d="M0 0h24v24H0z"/><path d="M17.618 5.968l1.453-1.453 1.414 1.414-1.453 1.453a9 9 0 11-1.414-1.414zM12 20a7 7 0 100-14 7 7 0 000 14zM11 8h2v6h-2V8zM8 1h8v2H8V1z"/></svg> <span data-v-2c97064e>124 min</span></div></div></div></div> <main class="page"><!----> <div class="theme-content content__default"><h2 id="é›†ç¾¤ä¸åˆ†å¸ƒå¼"><a href="#é›†ç¾¤ä¸åˆ†å¸ƒå¼" class="header-anchor">#</a> é›†ç¾¤ä¸åˆ†å¸ƒå¼</h2> <p>é›†ç¾¤:æŠŠä¸€ä¸ªé¡¹ç›®æ”¾åˆ°å¤šä¸ªå®¹å™¨(tomcat)ï¼Œä¸åŒçš„æœåŠ¡å™¨ä¸Šé¢è·‘
åˆ†å¸ƒå¼:æŠŠä¸€ä¸€ä¸ªé¡¹ç›®æ‹†åˆ†æˆå¤šä¸ªå¾®æœåŠ¡(é¡¹ç›®)ï¼Œæ¯ä¸ªé¡¹ç›®åœ¨ä¸åŒçš„æœåŠ¡å™¨ä¸Šé¢è·‘</p> <h2 id="boot-å’Œ-config-çš„åŒºåˆ«"><a href="#boot-å’Œ-config-çš„åŒºåˆ«" class="header-anchor">#</a> Boot å’Œ Config çš„åŒºåˆ«</h2> <blockquote><p>å¦‚æœæŸäº›æœåŠ¡çš„å¹¶å‘é‡éå¸¸é«˜ï¼Œå¦‚åŒåä¸€ï¼Œç”¨æˆ·ä¸‹å•é‡éå¸¸å¤§ï¼Œè¿™ç§æ—¶å€™é¡¹ç›®çš„æ¶æ„å°±è¦è€ƒè™‘é«˜å¹¶å‘çš„é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨å¾®æœåŠ¡æ¶æ„ã€‚</p></blockquote> <p>springboot:  å°±æ˜¯ä¸€ä¸ªå•ä½“åº”ç”¨ï¼ŒæŠŠæ‰€æœ‰çš„ä¸šåŠ¡éƒ½è€¦åˆåœ¨ä¸€èµ·ï¼Œä¸æ–¹é¢æ°´å¹³æ‰©å±•ï¼Œå³æ—¶æŠŠè¿™ä¸ªé¡¹ç›®ç”¨é›†ç¾¤çš„æ–¹å¼
æ¥éƒ¨ç½²ï¼Œä¹Ÿä¼šå­˜åœ¨è€¦åˆæ€§çš„é—®é¢˜ã€‚ä¸€æ—¦ä¿®æ”¹æŸä¸€å—ä¸šåŠ¡ï¼Œå…¨éƒ¨éƒ½è¦é‡æ–°å†éƒ¨ç½²</p> <p>springcloud:  å°±æ˜¯æŠŠä¸€ä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ï¼Œæ‹†åˆ†æˆnä¸ªå­æ¨¡å—ï¼Œæ¯ä¸ªå­æ¨¡å—ç›¸äº’ç‹¬ç«‹ï¼Œé™ä½äº†ä¸šåŠ¡é—´çš„è€¦åˆæ€§ï¼Œæ–¹ä¾¿ã€‚æ°´å¹³ä¸šåŠ¡æ‰©å±•ï¼Œä¸€æ—¦ä¿®æ”¹æŸä¸€å—ä¸šåŠ¡ï¼Œä¸å½±å“å…¶ä»–çš„æ¨¡å—</p> <h2 id="eureka-ä¸-nacos-çš„åŒºåˆ«"><a href="#eureka-ä¸-nacos-çš„åŒºåˆ«" class="header-anchor">#</a> Eureka ä¸ Nacos çš„åŒºåˆ«</h2> <p>Eureka ä¸ Nacos éƒ½ä½œä¸ºæ³¨å†Œä¸­å¿ƒ</p> <p>åŒºåˆ«:</p> <ul><li>Eureka  åªèƒ½ AP - é«˜å¯ç”¨æ€§</li> <li>zookeeper  ä»…ä»…æ”¯æŒ  CP - å¼ºä¸€è‡´æ€§</li> <li>Nacos å¯ä»¥ AP - é«˜å¯ç”¨æ€§ å’Œ CP - å¼ºä¸€è‡´æ€§</li> <li>Nacos å¯ä»¥ç”¨æ¥åšåˆ†ç»„ï¼Œä¸åŒçš„ç»„ä¹‹é—´ï¼Œå¾®æœåŠ¡ç›¸äº’ä¸èƒ½å‘ç°å¯¹æ–¹</li></ul> <p>CAP æ–¹æ¡ˆ:</p> <ul><li>C: consitence å¼ºä¸€è‡´æ€§:ä¸»è¦æ˜¯æŒ‡åœ¨é›†ç¾¤ç‰ˆçš„æ³¨å†Œä¸­å¿ƒä¸­ï¼Œæ¯ä¸ªæ³¨å†Œä¸­å¿ƒçš„å†…å®¹å¿…é¡»åŒæ­¥ä¹‹åæ‰èƒ½è®¿é—®ã€‚æ•°æ®çš„å®Œæ•´æ€§ä¸€-è‡´æ€§ï¼Œ å†å¦‚ï¼Œ
åœ¨é›†ç¾¤çŠ¶æ€ä¸‹ï¼Œå¦‚æœmasterå®•æœºäº†æˆ–è€…å…¶ä»–çš„å®•æœºäº†ï¼Œæ•´ä¸ªæ³¨å†Œä¸­å¿ƒè¿›å…¥ç˜«ç–¾çš„çŠ¶æ€ã€‚ç„¶åå†ä»æœºä¸­é€‰ä¸€ä¸ªå½“master</li> <li>A: Availability é«˜å¯ç”¨æ€§:ä¼˜å…ˆä¿è¯é«˜å¯ç”¨ï¼Œå…ˆä¿è¯æ•ˆç‡ï¼Œåœ¨é›†ç¾¤çŠ¶æ€ä¸‹ï¼Œåªè¦æœ‰ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒæ´»ç€ï¼Œæ•´ä¸ªå¾®æœåŠ¡ç…§å¸¸è¿è¡Œã€‚</li> <li>P: Partition tolerance åˆ†åŒºå®¹é”™æ€§ï¼Œè¿™ç§æ— æ³•é¿å…ï¼Œ-èˆ¬æ¥è¯´æŒ‡çš„æ˜¯ç¡¬ä»¶ç¯å¢ƒé—®é¢˜ã€‚</li></ul> <blockquote><p>æ‰€ä»¥å¦‚æœå¯¹æ•°æ®è¦æ±‚æ¯”è¾ƒé«˜ï¼Œåˆ™é€‰cp,ä½†å½±å“æ•ˆç‡
å¦‚æœå¯¹æ•°æ®è¦æ±‚ä¸æ˜¯é‚£ä¹ˆé«˜ï¼Œä½†æ˜¯è¿½æ±‚æ•ˆç‡ï¼Œç”¨ap</p></blockquote> <h2 id="springcloud-config-å¾®æœåŠ¡"><a href="#springcloud-config-å¾®æœåŠ¡" class="header-anchor">#</a> Springcloud Config å¾®æœåŠ¡</h2> <blockquote><p>å¾®æœåŠ¡æ¶æ„ï¼Œæ˜¯ä¸€ç§è½¯ä»¶æ¶æ„æ–¹å¼ã€‚å¾®æœåŠ¡çš„ä¸»è¦ç‰¹ç‚¹ä½“ç°åœ¨ç»„ä»¶åŒ–ã€æ¾è€¦åˆã€è‡ªæ²»å’Œå»ä¸­å¿ƒåŒ–ç­‰æ–¹é¢ã€‚å®ƒå°†åº”ç”¨æ„å»ºæˆä¸€ç³»åˆ—æŒ‰ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†æ¨¡å—çš„ã€å°çš„è‡ªæ²»æœåŠ¡ï¼Œé€šè¿‡åˆ†è§£å·¨å¤§å•ä½“å¼åº”ç”¨ä¸ºå¤šä¸ªæœåŠ¡æ–¹æ³•è§£å†³äº†å¤æ‚æ€§é—®é¢˜ã€‚æ¯ä¸ªæœåŠ¡è¿˜æä¾›äº†ä¸€ä¸ªä¸¥æ ¼çš„æ¨¡å—è¾¹ç•Œï¼Œç”šè‡³å…è®¸ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ç¼–å†™ä¸åŒçš„æœåŠ¡ã€‚</p></blockquote> <h3 id="æœåŠ¡è°ƒç”¨æ–¹å¼"><a href="#æœåŠ¡è°ƒç”¨æ–¹å¼" class="header-anchor">#</a> æœåŠ¡è°ƒç”¨æ–¹å¼</h3> <p>å¸¸è§çš„è¿œç¨‹è°ƒç”¨æ–¹å¼æœ‰ä»¥ä¸‹2ç§ï¼š</p> <ul><li><p>RPCï¼šRemote Produce Callè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œç±»ä¼¼çš„è¿˜æœ‰ ã€‚è‡ªå®šä¹‰æ•°æ®æ ¼å¼ï¼ŒåŸºäºåŸç”ŸTCPé€šä¿¡ï¼Œé€Ÿåº¦å¿«ï¼Œæ•ˆç‡é«˜ã€‚æ—©æœŸçš„webserviceï¼Œç°åœ¨çƒ­é—¨çš„dubbo ï¼ˆ12ä¸å†ç»´æŠ¤ã€17å¹´ç»´æŠ¤æƒäº¤ç»™apacheï¼‰ï¼Œéƒ½æ˜¯RPCçš„å…¸å‹ä»£è¡¨</p></li> <li><p>Httpï¼šhttpå…¶å®æ˜¯ä¸€ç§ç½‘ç»œä¼ è¾“åè®®ï¼ŒåŸºäºTCPï¼Œè§„å®šäº†æ•°æ®ä¼ è¾“çš„æ ¼å¼ã€‚ç°åœ¨å®¢æˆ·ç«¯æµè§ˆå™¨ä¸æœåŠ¡ç«¯é€šä¿¡åŸºæœ¬éƒ½æ˜¯é‡‡ç”¨Httpåè®®ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥è¿›è¡Œè¿œç¨‹æœåŠ¡è°ƒç”¨ã€‚ç¼ºç‚¹æ˜¯æ¶ˆæ¯å°è£…è‡ƒè‚¿ï¼Œä¼˜åŠ¿æ˜¯å¯¹æœåŠ¡çš„æä¾›å’Œè°ƒç”¨æ–¹æ²¡æœ‰ä»»ä½•æŠ€æœ¯é™å®šï¼Œè‡ªç”±çµæ´»ï¼Œæ›´ç¬¦åˆå¾®æœåŠ¡ç†å¿µã€‚ç°åœ¨çƒ­é—¨çš„Resté£æ ¼ï¼Œå°±å¯ä»¥é€šè¿‡httpåè®®æ¥å®ç°ã€‚</p></li></ul> <h3 id="httpå®¢æˆ·ç«¯å·¥å…·"><a href="#httpå®¢æˆ·ç«¯å·¥å…·" class="header-anchor">#</a> Httpå®¢æˆ·ç«¯å·¥å…·</h3> <p>æ—¢ç„¶å¾®æœåŠ¡é€‰æ‹©äº†Httpï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦è€ƒè™‘è‡ªå·±æ¥å®ç°å¯¹è¯·æ±‚å’Œå“åº”çš„å¤„ç†ã€‚ä¸è¿‡å¼€æºä¸–ç•Œå·²ç»æœ‰å¾ˆå¤šçš„httpå®¢æˆ·ç«¯å·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬åšè¿™äº›äº‹æƒ…ï¼ŒJava çš„ JDK ä¸­è‡ªå¸¦äº†ä¸ç½‘ç»œæœ‰å…³çš„ç±»ï¼ˆHttpURLConnectionï¼‰ï¼Œèƒ½å¤Ÿè®©ä½ åœ¨ Java ä»£ç ä¸­å‘å‡º HTTP è¯·æ±‚ï¼Œå¹¶è§£æ HTTP å“åº”ã€‚ä¸è¿‡ï¼Œç”±äºè¿™äº›åº•å±‚ç±»å’Œæ–¹æ³•çš„ä½¿ç”¨è¿‡äºç¹æ‚ç½—å—¦ï¼ˆå¹¶ä¸”æ‰§è¡Œæ•ˆç‡ä¸é«˜ï¼‰ï¼Œå› æ­¤ç›´æ¥ä½¿ç”¨å®ƒä»¬çš„æƒ…å†µå¹¶ä¸å¤šã€‚é€šå¸¸ï¼Œæˆ‘ä»¬æ˜¯ä½¿ç”¨å¯¹åº•å±‚ç±»å’Œæ–¹æ³•è¿›è¡Œäº†äºŒæ¬¡åŒ…è£…çš„å·¥å…·åŒ…ï¼ˆåº“ï¼‰ï¼Œå¸¸è§çš„æœ‰ apache åŸºé‡‘ä¼šçš„ httpclientï¼ˆä»¥åŠå®ƒçš„åè¾ˆã€ç«äº‰å¯¹æ‰‹ OkHTTPï¼‰</p> <ul><li>HttpClient</li> <li>OKHttp</li> <li>URLConnection</li></ul> <div class="language- extra-class"><pre class="language-text"><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.httpcomponents&lt;/groupId&gt;
    &lt;artifactId&gt;httpclient&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></div><p>Spring ä½“ç³»å¯¹ HttpURLConnectionã€httpclient å’Œ OkHTTP è¿›è¡Œäº† 2 æ¬¡åŒ…è£…ï¼Œæå‡ºäº† <strong>RestTemplate</strong> ç±»ï¼Œä»è€Œè¾¾åˆ°äº†å¦‚ä¸‹ç›®çš„ï¼š</p> <ol><li>å±è”½äº†åº•å±‚å®ç°ã€‚æ— è®ºåº•å±‚ä½¿ç”¨å®ƒä»¬ 3 ç§ä¸­çš„å“ªä¸ªï¼ŒRestTemplate å¯¹å¤–æš´éœ²çš„æ¥å£éƒ½æ˜¯ä¸€æ ·çš„ã€‚</li> <li>è¿›ä¸€æ­¥ç®€åŒ–äº†æ“ä½œï¼Œé™ä½äº†ä½¿ç”¨å¤æ‚åº¦ã€‚</li></ol> <div class="language- extra-class"><pre class="language-text"><code>ä½ çš„é¡¹ç›®åªè¦ç›´æ¥æˆ–é—´æ¥å¼•å…¥äº† spring-web åŒ…ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ RestTemplate ï¼ŒrestTemplateå†…éƒ¨å°è£…äº†HttpClient
</code></pre></div><h2 id="spring-çš„-resttemplate-è¿œç¨‹è¯·æ±‚"><a href="#spring-çš„-resttemplate-è¿œç¨‹è¯·æ±‚" class="header-anchor">#</a> Spring çš„ RestTemplate è¿œç¨‹è¯·æ±‚</h2> <p>RestTemplate æ˜¯ä» Spring3.0 å¼€å§‹æ”¯æŒçš„ä¸€ä¸ª HTTP è¯·æ±‚å·¥å…·ï¼Œå®ƒæä¾›äº†å¸¸è§çš„RESTè¯·æ±‚æ–¹æ¡ˆçš„æ¨¡ç‰ˆï¼Œä¾‹å¦‚ GET è¯·æ±‚ã€POST è¯·æ±‚ã€PUT è¯·æ±‚ã€DELETE è¯·æ±‚ä»¥åŠä¸€äº›é€šç”¨çš„è¯·æ±‚æ‰§è¡Œæ–¹æ³• exchange ä»¥åŠ executeã€‚RestTemplate ç»§æ‰¿InterceptingHttpAccessor å¹¶ä¸”å®ç°äº† RestOperations æ¥å£ï¼Œå…¶ä¸­ RestOperations æ¥å£å®šä¹‰äº†åŸºæœ¬çš„ RESTful æ“ä½œï¼Œè¿™äº›æ“ä½œåœ¨ RestTemplate ä¸­éƒ½å¾—åˆ°äº†å®ç°</p> <h3 id="å¸¸ç”¨æ–¹æ³•"><a href="#å¸¸ç”¨æ–¹æ³•" class="header-anchor">#</a> å¸¸ç”¨æ–¹æ³•</h3> <table><thead><tr><th>HTTP Method</th> <th>å¸¸ç”¨æ–¹æ³•</th> <th>æè¿°</th></tr></thead> <tbody><tr><td>GET</td> <td>getForObject</td> <td>å‘èµ· GET è¯·æ±‚å“åº”å¯¹è±¡</td></tr> <tr><td>GET</td> <td>getForEntity</td> <td>å‘èµ· GET è¯·æ±‚å“åº”ç»“æœã€åŒ…å«å“åº”å¯¹è±¡ã€è¯·æ±‚å¤´ã€çŠ¶æ€ç ç­‰ HTTP åè®®è¯¦ç»†å†…å®¹</td></tr> <tr><td>POST</td> <td>postForObject</td> <td>å‘èµ· POST è¯·æ±‚å“åº”å¯¹è±¡</td></tr> <tr><td>POST</td> <td>postForEntity</td> <td>å‘èµ· POST è¯·æ±‚å“åº”ç»“æœã€åŒ…å«å“åº”å¯¹è±¡ã€è¯·æ±‚å¤´ã€çŠ¶æ€ç ç­‰ HTTP åè®®è¯¦ç»†å†…å®¹</td></tr> <tr><td>DELETE</td> <td>delete</td> <td>å‘èµ· HTTP çš„ DELETE æ–¹æ³•è¯·æ±‚</td></tr> <tr><td>PUT</td> <td>put</td> <td>å‘èµ· HTTP çš„ PUT æ–¹æ³•è¯·æ±‚</td></tr></tbody></table> <h3 id="å¾®æœåŠ¡å‡†å¤‡"><a href="#å¾®æœåŠ¡å‡†å¤‡" class="header-anchor">#</a> å¾®æœåŠ¡å‡†å¤‡:</h3> <p>1.å¯åŠ¨ç±»</p> <blockquote><p>åˆ›å»º RestTemplate æ–¹æ³• å¹¶æ³¨å…¥åˆ°é…ç½®é‡Œä»¥ä¾›è°ƒç”¨</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModuleTowApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ModuleTowApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>    <span class="token comment">// è´Ÿè½½å‡è¡¡ ä¸æ·»åŠ è¿™ä¸ªæ³¨è§£ï¼Œä¸èƒ½ç›´æ¥ç”¨æœåŠ¡åè®¿é—®</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre></div><p>2.è¡¨ç°å±‚</p> <blockquote><p>è¡¨ç°å±‚ä½¿ç”¨@Autowiredæ³¨è§£è°ƒç”¨å…¶æ–¹æ³•</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>
</code></pre></div><h3 id="get-è¯·æ±‚"><a href="#get-è¯·æ±‚" class="header-anchor">#</a> Get  è¯·æ±‚</h3> <h4 id="_1-å ä½ç¬¦ä¼ å‚"><a href="#_1-å ä½ç¬¦ä¼ å‚" class="header-anchor">#</a> 1.å ä½ç¬¦ä¼ å‚</h4> <p>getForEntityï¼ˆï¼‰æ–¹æ³•ï¼šå¦‚æœå¼€å‘è€…éœ€è¦è·å–å“åº”å¤´çš„è¯ï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨ getForEntity æ¥å‘é€ HTTP è¯·æ±‚ï¼Œæ­¤æ—¶è¿”å›çš„å¯¹è±¡æ˜¯ä¸€ä¸ª ResponseEntity çš„å®ä¾‹ã€‚è¿™ä¸ªå®ä¾‹ä¸­åŒ…å«äº†å“åº”æ•°æ®ä»¥åŠå“åº”å¤´</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">///////////////////////è°ƒç”¨æ–¹</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/test1?name={1}&amp;id={2}&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StringBuffer</span> sb  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpStatus</span> status <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> body <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> headers<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;statusCode:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;body:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//////////////å“åº”æ–¹///////////////////////////</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">findUsers</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token operator">+</span> <span class="token string">&quot;:&quot;</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByExample</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ url ï¼Œurl ä¸­æœ‰ä¸€ä¸ªå ä½ç¬¦ {1} ,å¦‚æœæœ‰å¤šä¸ªå ä½ç¬¦åˆ†åˆ«ç”¨ {2} ã€ {3} â€¦ å»è¡¨ç¤ºï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯æ¥å£è¿”å›çš„æ•°æ®ç±»å‹ï¼Œæœ€åæ˜¯ä¸€ä¸ªå¯å˜é•¿åº¦çš„å‚æ•°ï¼Œç”¨æ¥ç»™å ä½ç¬¦å¡«å€¼</p></blockquote> <h4 id="_2-mapä¼ å‚"><a href="#_2-mapä¼ å‚" class="header-anchor">#</a> 2.mapä¼ å‚</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">///////////////////////è°ƒç”¨æ–¹ </span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/test2?id={id}&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> maps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    maps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> maps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StringBuffer</span> sb  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpStatus</span> status <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">User</span> body <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;statusCode:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;body:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//////////////////////è¢«è°ƒç”¨æ–¹</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span>  <span class="token class-name">String</span>  <span class="token function">getUserById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectByPrimaryKey</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_3-uriæ–¹å¼ä¼ å‚"><a href="#_3-uriæ–¹å¼ä¼ å‚" class="header-anchor">#</a> 3.urIæ–¹å¼ä¼ å‚</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">///////////////////////è°ƒç”¨æ–¹ </span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test3&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/test3?name=&quot;</span><span class="token operator">+</span> <span class="token class-name">URLEncoder</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">URI</span> uri <span class="token operator">=</span> URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">StringBuffer</span> sb  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpStatus</span> status <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> str  <span class="token operator">=</span> result<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;statusCode:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;body:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;br /&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><h4 id="_4-restä¼ å‚"><a href="#_4-restä¼ å‚" class="header-anchor">#</a> 4.restä¼ å‚</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">///////////////////////è°ƒç”¨æ–¹</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test4/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test4</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8080/test4/&quot;</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForEntity</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>è¯´æ˜ï¼š</p> <p>getForObject æ–¹æ³•å’Œ getForEntity æ–¹æ³•ç±»ä¼¼ï¼ŒgetForObject æ–¹æ³•ä¹Ÿæœ‰ä¸‰ä¸ªé‡è½½çš„æ–¹æ³•ï¼Œå‚æ•°å’Œ getForEntity ä¸€æ ·ï¼Œè¿™é‡Œä¸»è¦è¯´ä¸‹ getForObject å’Œ getForEntity çš„å·®å¼‚ï¼Œè¿™ä¸¤ä¸ªçš„å·®å¼‚ä¸»è¦ä½“ç°åœ¨è¿”å›å€¼çš„å·®å¼‚ä¸Šï¼Œ getForObject çš„è¿”å›å€¼å°±æ˜¯æœåŠ¡æä¾›è€…è¿”å›çš„æ•°æ®ï¼Œä½¿ç”¨ getForObject æ— æ³•è·å–åˆ°å“åº”å¤´</p></blockquote> <h3 id="post-è¯·æ±‚"><a href="#post-è¯·æ±‚" class="header-anchor">#</a> Post  è¯·æ±‚</h3> <p>æ ¹æ®ä¸Šå›¾å¯ä»¥çœ‹å‡ºPOSTè¯·æ±‚æ–¹å¼ä¸€å…±æä¾›äº†ä¸¤ä¸ªå‡½æ•° postForEntityã€postForObjectã€postForLocationã€‚æ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸‰ä¸ªé‡è½½æ–¹æ³•</p> <h4 id="postforentity"><a href="#postforentity" class="header-anchor">#</a> postForEntity</h4> <p>è¿™äº›å‡½æ•°ä¸­çš„å‚æ•°ç”¨æ³•å¤§éƒ¨åˆ†ä¸getForEntityä¸€è‡´ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æ–°å¢åŠ ï¼ˆå¯ä¸ºç©ºçš„è¯·æ±‚å¯¹è±¡ï¼‰requestå‚æ•°ï¼Œ è¯¥å‚æ•°å¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªHttpEntityå¯¹è±¡ã€‚å¦‚æœæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œrequestå†…å®¹ä¼šè¢«è§†ä½œå®Œæ•´çš„bodyæ¥å¤„ç†ï¼›è€Œå¦‚æœrequest æ˜¯ä¸€ä¸ªHttpEntityå¯¹è±¡ï¼Œ é‚£ä¹ˆå°±ä¼šè¢«å½“ä½œä¸€ä¸ªå®Œæˆçš„HTTPè¯·æ±‚å¯¹è±¡æ¥å¤„ç†ï¼Œ è¿™ä¸ª request ä¸­ä¸ä»…åŒ…å«äº†bodyçš„å†…å®¹ï¼Œ ä¹ŸåŒ…å«äº†headerçš„å†…å®¹</p> <h5 id="ä¼ é€’-key-value"><a href="#ä¼ é€’-key-value" class="header-anchor">#</a> ä¼ é€’ key-value</h5> <p>æ¡ˆä¾‹1ï¼šç»„åˆä¼ å‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//////////////å®¢æˆ·ç«¯ï¼šrequestæ˜¯ä¸€ä¸ªHttpEntityå¯¹è±¡</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;aaaaaaaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">MultiValueMap</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;é›·é”‹&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;ç”·&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> json <span class="token operator">=</span> 			        		    restTemplate<span class="token punctuation">.</span><span class="token function">postForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/test1&quot;</span><span class="token punctuation">,</span>entity<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">///////////////////æœåŠ¡ç«¯</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">MultiValueMap</span> map<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;sex&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="å•ä¸ª-å¯¹è±¡-ä¼ å‚"><a href="#å•ä¸ª-å¯¹è±¡-ä¼ å‚" class="header-anchor">#</a> å•ä¸ª å¯¹è±¡ ä¼ å‚</h5> <blockquote><p>å•ä¸ª å¯¹è±¡ ä¼ å‚</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//////////////å®¢æˆ·ç«¯ï¼šrequestæ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;å¼ ä¸‰ä¸°&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;1111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> json <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/test2&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">///////////////////æœåŠ¡ç«¯</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>è¯´æ˜ï¼š</p> <p>1.éœ€è¦ä½¿ç”¨ LinkedMultiValueMap ,ä¸èƒ½ä½¿ç”¨HashMapã€‚RestTemplateé»˜è®¤æä¾›çš„AllEncompassingFormHttpMessageConverterç»§æ‰¿äº†FormHttpMessageConverterè¿›è¡Œè§£æï¼›ä¼ é€’ç±»å‹ä¸ºHashMapï¼Œå¯ä»¥å‘ç°è¢«è§£ææˆäº†jsonå­—ç¬¦ä¸²ã€‚ç”¨çš„æ˜¯MappingJackson2HttpMessageConverterè¿›è¡Œè§£æ</p> <p>2.serverç«¯è¦æ¥æ”¶å‚æ•°éœ€è¦ç”¨@RequestBodyæ³¨è§£ï¼Œä¸ç„¶æ— æ³•æ¥æ”¶åˆ°å‚æ•°</p></blockquote> <h5 id="ä¼ é€’jsonå‚æ•°"><a href="#ä¼ é€’jsonå‚æ•°" class="header-anchor">#</a> ä¼ é€’JSONå‚æ•°</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">////////å®¢æˆ·ç«¯</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test3&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token class-name">String</span> token <span class="token operator">=</span> <span class="token string">&quot;aaaaa&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpHeaders</span> httpHeaders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpHeaders<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON_UTF8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    httpHeaders<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;å¼ ä¸‰ä¸°&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> users <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    users<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> jsons <span class="token operator">=</span> <span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">HttpEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token punctuation">(</span>jsons<span class="token punctuation">,</span>httpHeaders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForEntity</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/test3&quot;</span><span class="token punctuation">,</span>entity<span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">///////æœåŠ¡å™¨</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test3&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> str<span class="token punctuation">,</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>æ€»ç»“ï¼š</p> <p>1.jsonè½¬æ¢æ˜¯å€Ÿç”¨alibabaçš„ç¬¬ä¸‰æ–¹åŒ…fastjson</p> <p>2.serverç«¯è¦æ¥æ”¶å‚æ•°éœ€è¦ç”¨@RequestBodyæ³¨è§£ï¼Œä¸ç„¶æ— æ³•æ¥æ”¶åˆ°å‚æ•°</p> <p>3.POSTå‚æ•°åˆ°åº•æ˜¯key/valueè¿˜æ˜¯jsonï¼Œä¸»è¦çœ‹ç¬¬äºŒä¸ªå‚æ•°ï¼Œå¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯MultiValueMapï¼Œåˆ™æ˜¯ä»¥key/valueå½¢å¼ä¼ é€’ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œåˆ™æ˜¯ä»¥jsonå½¢å¼ä¼ é€’</p></blockquote> <h4 id="postforobject"><a href="#postforobject" class="header-anchor">#</a> postForObject</h4> <p>å‚æ•°å¯ä»¥æ˜¯Jsonå­—ç¬¦ä¸²ï¼ŒJavaBeanå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯mapï¼Œå…¶ä¸­æœ¬è´¨éƒ½æ˜¯ä½¿ç”¨äº†HttpEntityå¯¹è±¡ï¼Œåœ¨RestTemplateå†…éƒ¨æœ‰è¿™æ ·ä¸€æ®µæºç ï¼šç¨‹åºä¼šè‡ªåŠ¨åˆ¤æ–­ï¼Œå¦‚æœä¸æ˜¯HttpEntityå¯¹è±¡å°±æ‰‹åŠ¨æ·»åŠ ä¸€æ¬¡</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">HttpEntityRequestCallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Object</span> requestBody<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Type</span> responseType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">super</span><span class="token punctuation">(</span>responseType<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody <span class="token keyword">instanceof</span> <span class="token class-name">HttpEntity</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestEntity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> requestBody<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>requestBody <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>requestBody<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>requestEntity <span class="token operator">=</span> <span class="token class-name">HttpEntity</span><span class="token punctuation">.</span>EMPTY<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="ä¼ é€’-javabean"><a href="#ä¼ é€’-javabean" class="header-anchor">#</a> ä¼ é€’ javaBean</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">////////////////////å®¢æˆ·ç«¯</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/test1&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    user<span class="token punctuation">.</span><span class="token function">setUsername</span><span class="token punctuation">(</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpHeaders</span> headers  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;aaaaaaaaaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HttpEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpEntity</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/test2&quot;</span><span class="token punctuation">,</span> entity<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">///////////////æœåŠ¡ç«¯/////////////////</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="postforlocation"><a href="#postforlocation" class="header-anchor">#</a> postForLocation</h4> <p>postForLocationä¹Ÿæ˜¯æäº¤æ–°èµ„æºï¼Œæäº¤æˆåŠŸä¹‹åï¼Œè¿”å›æ–°èµ„æºçš„URIï¼ŒpostForLocationçš„å‚æ•°å’Œå‰é¢ä¸¤ç§çš„å‚æ•°åŸºæœ¬ä¸€è‡´ï¼Œåªä¸è¿‡è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸ºUriï¼Œè¿™ä¸ªåªéœ€è¦æœåŠ¡æä¾›è€…è¿”å›ä¸€ä¸ªUriå³å¯ï¼Œè¯¥Uriè¡¨ç¤ºæ–°èµ„æºçš„ä½ç½®</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//////////å®¢æˆ·ç«¯////////////////</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test3&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">MultiValueMap</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedMultiValueMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;1111&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    map<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;username&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;zhangsan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">URI</span> uri <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">postForLocation</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/test3&quot;</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> s <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">////////////æœåŠ¡ç«¯///////////////////</span>
<span class="token comment">// æ³¨æ„ç‚¹: è¯¥æ–¹æ³•éœ€è¦è¿”å›ä¸º è·³è½¬é‡å®šå‘ ä¸èƒ½ç›´æ¥åœ¨ç±»ä¸ŠåŠ ä¸Š@RestControllerzu'du</span>
<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test3&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;redirect:http://localhost:8080/loginPage?name=&quot;</span> <span class="token operator">+</span> user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/loginPage&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ResponseBody</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">loginPage</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;loginPage:&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>å½“ç„¶ä½ å¯ä»¥ä½¿ç”¨restfulé£æ ¼é’ˆå¯¹postè¯·æ±‚è¿›è¡Œä¼ å‚</p></blockquote> <h3 id="resttemplateåº•å±‚å®ç°åˆ‡æ¢"><a href="#resttemplateåº•å±‚å®ç°åˆ‡æ¢" class="header-anchor">#</a> RestTemplateåº•å±‚å®ç°åˆ‡æ¢</h3> <p>RestTemplate åº•å±‚å®ç°æœ€å¸¸ç”¨çš„æœ‰ä»¥ä¸‹ä¸‰ç§ï¼š</p> <ul><li><strong>SimpleClientHttpRequestFactory</strong> å°è£… JDK çš„ URLConnectionã€‚é»˜è®¤å®ç°</li> <li><strong>HttpComponentsClientHttpRequestFactory</strong> å°è£…ç¬¬ä¸‰æ–¹ç±»åº“ HttpClient</li> <li><strong>OkHttp3ClientHttpRequestFactory</strong> å°è£…å°è£…ç¬¬ä¸‰æ–¹ç±»åº“ OKHttp</li></ul> <p>HttpClient ä½¿ç”¨ç‡æ›´é«˜ï¼Œè€Œ OKHttp çš„æ‰§è¡Œæ•ˆç‡æœ€é«˜ã€‚</p> <p>æ‰€ä»¥ï¼Œåœ¨ä½ å°† RestTemplate é…ç½®æˆå•ä¾‹æ—¶ï¼Œä½ å¯ä»¥æŒ‡å®šå®ƒä½¿ç”¨ä½•ç§åº•å±‚åº“ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é»˜è®¤å®ç°URLConnection</span>
<span class="token comment">//  RestTemplate restTemplate = new RestTemplate(new SimpleClientHttpRequestFactory()); // ç­‰åŒé»˜è®¤å®ç°</span>
<span class="token comment">//  RestTemplate restTemplate = new RestTemplate(new HttpComponentsClientHttpRequestFactory()); // ä½¿ç”¨ HttpClient</span>
<span class="token comment">//  RestTemplate restTemplate = new RestTemplate(new OkHttp3ClientHttpRequestFactory()); // ä½¿ç”¨ OkHttp</span>
    <span class="token keyword">return</span> restTemplate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>åœ¨å®é™…çš„åº”ç”¨ä¸­ï¼Œåªéœ€è¦é€‰æ‹©ä¸Šé¢çš„ä»£ç ä¸­çš„å…¶ä¸­ä¸€ç§ RestTemplate Bean å³å¯ã€‚å½“ç„¶ï¼Œæ— è®º RestTemplate åº•å±‚ä½¿ç”¨ä½•ç§ç½‘ç»œåº“ï¼Œæˆ‘ä»¬å¯¹äºå®ƒçš„ä½¿ç”¨æ–¹å¼éƒ½æ˜¯ç»Ÿä¸€çš„ã€‚</p> <h2 id="eureka-æ³¨å†Œä¸­å¿ƒ-ç»„ä»¶"><a href="#eureka-æ³¨å†Œä¸­å¿ƒ-ç»„ä»¶" class="header-anchor">#</a> |-- Eureka æ³¨å†Œä¸­å¿ƒ ç»„ä»¶</h2> <h3 id="åŸºç¡€æ¶æ„"><a href="#åŸºç¡€æ¶æ„" class="header-anchor">#</a> åŸºç¡€æ¶æ„</h3> <blockquote><p>Eurekaæ¶æ„ä¸­çš„ä¸‰ä¸ªæ ¸å¿ƒè§’è‰²ï¼š</p></blockquote> <ul><li><p>æœåŠ¡æ³¨å†Œä¸­å¿ƒ</p> <p>Eurekaçš„æœåŠ¡ç«¯åº”ç”¨ï¼Œæä¾›æœåŠ¡æ³¨å†Œå’Œå‘ç°åŠŸèƒ½ï¼Œå°±æ˜¯åˆšåˆšæˆ‘ä»¬å»ºç«‹çš„woniu-eurekaã€‚</p></li> <li><p>æœåŠ¡æä¾›è€…</p> <p>æä¾›æœåŠ¡çš„åº”ç”¨ï¼Œå¯ä»¥æ˜¯SpringBootåº”ç”¨ï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒä»»æ„æŠ€æœ¯å®ç°ï¼Œåªè¦å¯¹å¤–æä¾›çš„æ˜¯Resté£æ ¼æœåŠ¡å³å¯ã€‚æœ¬ä¾‹ä¸­å°±æ˜¯æˆ‘ä»¬å®ç°çš„woniu-service-providerã€‚</p></li> <li><p>æœåŠ¡æ¶ˆè´¹è€…</p> <p>æ¶ˆè´¹åº”ç”¨ä»æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡åˆ—è¡¨ï¼Œä»è€Œå¾—çŸ¥æ¯ä¸ªæœåŠ¡æ–¹çš„ä¿¡æ¯ï¼ŒçŸ¥é“å»å“ªé‡Œè°ƒç”¨æœåŠ¡æ–¹ã€‚æœ¬ä¾‹ä¸­å°±æ˜¯æˆ‘ä»¬å®ç°çš„woniu-service-consumerã€‚</p></li></ul> <h3 id="eurekaserver-å®¢æˆ·ç«¯-æœåŠ¡ä¸­å¿ƒ"><a href="#eurekaserver-å®¢æˆ·ç«¯-æœåŠ¡ä¸­å¿ƒ" class="header-anchor">#</a> EurekaServer å®¢æˆ·ç«¯ æœåŠ¡ä¸­å¿ƒ</h3> <h4 id="pom-ä¾èµ–"><a href="#pom-ä¾èµ–" class="header-anchor">#</a> pom ä¾èµ–</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>2.3.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--EurekaServerä¾èµ–çš„ç‰ˆæœ¬ å¯å†™å…¥çˆ¶ç±»çš„pom--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Hoxton.SR9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--web å•ä¸ªæœåŠ¡ä¸­å¿ƒéœ€è¦é…ç½®web--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    
    <span class="token comment">&lt;!--eurekaçš„æ³¨å†Œä¸­å¿ƒä¾èµ– è¿˜éœ€é…ç½®ç‰ˆæœ¬&lt;properties&gt;å’Œ&lt;dependencyManagement&gt;--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--Springcloud ç®¡ç† å¯å†™å…¥çˆ¶ç±»çš„pom--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="application-yml"><a href="#application-yml" class="header-anchor">#</a> application.yml</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment">## æ³¨æ„: æœåŠ¡å ä¸èƒ½ä¸º'_'ä¸‹åˆ’çº¿ å¦åˆ™åœ¨è¡¨ç°å±‚è°ƒç”¨ä¼šå‡ºé—®é¢˜ ä¸­åˆ’çº¿åˆ™æ²¡é—®é¢˜ </span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> EurekaServer

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span> <span class="token comment">## ç«¯å£</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">## EurekaServerçš„åœ°å€ï¼Œå¦‚æœæ˜¯é›†ç¾¤ï¼Œéœ€è¦åŠ ä¸Šå…¶å®ƒServerçš„åœ°å€ã€‚</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>/eureka
    <span class="token comment">## ä¸æŠŠè‡ªå·±æ³¨å†Œåˆ°eurekaæœåŠ¡åˆ—è¡¨</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## æ‹‰å–eurekaæœåŠ¡ä¿¡æ¯</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment">## è®¾ç½® IP</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token comment">## å®¢æˆ·ç«¯åœ¨æ³¨å†Œæ—¶ä½¿ç”¨è‡ªå·±çš„IPè€Œä¸æ˜¯ä¸»æœºå</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## å®ä¾‹id</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
    
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token comment">## å…³é—­è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼ˆé»˜è®¤ä¸ºæ‰“å¼€ï¼‰</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token comment">## æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆç¼ºçœä¸º60*1000msï¼‰</span>
    <span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">1000</span>
</code></pre></div><h4 id="å¯åŠ¨ç±»"><a href="#å¯åŠ¨ç±»" class="header-anchor">#</a> å¯åŠ¨ç±»</h4> <p>å¦‚æœå¯åŠ¨ç±»æŠ¥é”™ å¦‚æœªæŠ¥é”™åˆ™æ— è§†</p> <blockquote><p>Failed to configure a DataSource: 'url' attribute is not specified and no embedde</p> <p><strong>urlæ‰¾ä¸åˆ° åˆ™åœ¨å¯åŠ¨ç±»æ³¨è§£è¦æŒ‡å®š:</strong></p> <p>@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>eureka<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">EnableEurekaServer</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableEurekaServer</span> <span class="token comment">// å£°æ˜å½“å‰springbootåº”ç”¨æ˜¯ä¸€ä¸ªeurekaæœåŠ¡ä¸­å¿ƒ</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="eurekaserver-æœåŠ¡ç«¯-æä¾›ç«¯å£"><a href="#eurekaserver-æœåŠ¡ç«¯-æä¾›ç«¯å£" class="header-anchor">#</a> EurekaServer æœåŠ¡ç«¯ æä¾›ç«¯å£</h3> <blockquote><p>å°†ä¼šè®©æœåŠ¡ç«¯çš„IPå’Œç«¯å£è‡ªåŠ¨æ³¨å†Œåˆ° æ³¨å†Œä¸­å¿ƒ ä»¥ä¾›ä»–äººè°ƒç”¨</p></blockquote> <h4 id="pom-ä¾èµ–-2"><a href="#pom-ä¾èµ–-2" class="header-anchor">#</a> pom ä¾èµ–</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--EurekaServer-è‡ªåŠ¨æ³¨å†Œ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
    	<span class="token comment">## æ³¨æ„: æœåŠ¡å ä¸èƒ½ä¸º'_'ä¸‹åˆ’çº¿ å¦åˆ™åœ¨è¡¨ç°å±‚è°ƒç”¨ä¼šå‡ºé—®é¢˜ ä¸­åˆ’çº¿åˆ™æ²¡é—®é¢˜ </span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Moduleone

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
            <span class="token comment">## æ³¨å†Œä¸­å¿ƒçš„åœ°å€ å¦‚æœæ³¨å†Œé›†ç¾¤å¯å¯ä»¥å†™å…¥å¤šä¸ªæ³¨å†Œä¸­å¿ƒçš„åœ°å€ , éš”å¼€</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
    <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token comment">## å¿ƒè·³ç›‘æµ‹è¶…è¿‡è®¾å®šæ—¶é—´åˆ™æ³¨å†Œä¸­å¿ƒä¼šåˆ é™¤è¯¥æœåŠ¡æ–¹</span>
        <span class="token key atrule">lease-expiration-duration-in-seconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token comment">## æœåŠ¡æ–¹å¿ƒè·³ç›‘æµ‹æ ¹æ®æ—¶é—´å‘é€å¿ƒè·³</span>
        <span class="token key atrule">lease-renewal-interval-in-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token comment">## è®¾ç½® IP</span>
        <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 127.0.0.1
        <span class="token comment">#å®¢æˆ·ç«¯åœ¨æ³¨å†Œæ—¶ä½¿ç”¨è‡ªå·±çš„IPè€Œä¸æ˜¯ä¸»æœºå</span>
        <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment">#å®ä¾‹id</span>
        <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
</code></pre></div><h4 id="å¯åŠ¨ç±»-2"><a href="#å¯åŠ¨ç±»-2" class="header-anchor">#</a> å¯åŠ¨ç±»</h4> <blockquote><p>é€šè¿‡æ·»åŠ <code>@EnableDiscoveryClient</code>æ¥å¼€å¯Eurekaå®¢æˆ·ç«¯åŠŸèƒ½</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token comment">// å¼€å¯Eurekaå®¢æˆ·ç«¯åŠŸèƒ½</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> woniuServiceProviderApplication <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>woniuServiceApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="eurekaserver-è°ƒç”¨æ–¹-ä½¿ç”¨ç«¯å£"><a href="#eurekaserver-è°ƒç”¨æ–¹-ä½¿ç”¨ç«¯å£" class="header-anchor">#</a> EurekaServer è°ƒç”¨æ–¹ ä½¿ç”¨ç«¯å£</h3> <h4 id="pom-ä¾èµ–-3"><a href="#pom-ä¾èµ–-3" class="header-anchor">#</a> pom ä¾èµ–</h4> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--EurekaServer-è‡ªåŠ¨æ³¨å†Œ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="application-yml-2"><a href="#application-yml-2" class="header-anchor">#</a> application.yml</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Module_tow

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
        	<span class="token comment">## æ³¨å†Œä¸­å¿ƒçš„åœ°å€ å¦‚æœæ³¨å†Œé›†ç¾¤å¯å¯ä»¥å†™å…¥å¤šä¸ªæ³¨å†Œä¸­å¿ƒçš„åœ°å€ , éš”å¼€</span>
            <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>10086/eureka
        <span class="token comment">## æ¯éš”5ç§’å‘æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡</span>
        <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token key atrule">instance</span><span class="token punctuation">:</span>
        <span class="token comment">## è®¾ç½® IP</span>
        <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 127.0.0.1
        <span class="token comment">## æ³¨å†Œæ—¶ä½¿ç”¨è‡ªå·±çš„IPè€Œä¸æ˜¯ä¸»æœºå</span>
        <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment">## å®ä¾‹id</span>
        <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>  
</code></pre></div><h4 id="å¯åŠ¨ç±»-3"><a href="#å¯åŠ¨ç±»-3" class="header-anchor">#</a> å¯åŠ¨ç±»</h4> <blockquote><p>é€šè¿‡æ·»åŠ <code>@EnableDiscoveryClient</code>æ¥å¼€å¯Eurekaå®¢æˆ·ç«¯åŠŸèƒ½</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token comment">// å¼€å¯Eurekaå®¢æˆ·ç«¯åŠŸèƒ½</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> 
<span class="token keyword">public</span> <span class="token keyword">class</span> woniuServiceProviderApplication <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>woniuServiceApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="è¡¨ç°å±‚-è°ƒç”¨"><a href="#è¡¨ç°å±‚-è°ƒç”¨" class="header-anchor">#</a> è¡¨ç°å±‚-è°ƒç”¨</h4> <p>ä½¿ç”¨ è´Ÿè½½å‡è¡¡ å¯ç›´æ¥è°ƒç”¨ æœåŠ¡å</p> <p>æ³¨æ„: æœåŠ¡å ä¸èƒ½ä¸º'_'ä¸‹åˆ’çº¿ å¦åˆ™åœ¨è¡¨ç°å±‚è°ƒç”¨ä¼šå‡ºé—®é¢˜ ä¸­åˆ’çº¿åˆ™æ²¡é—®é¢˜</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ServiceInstance</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">DiscoveryClient</span><span class="token punctuation">;</span>

<span class="token comment">// eurekaå®¢æˆ·ç«¯ï¼Œå¯ä»¥è·å–åˆ°eurekaä¸­æœåŠ¡çš„ä¿¡æ¯ æ³¨æ„å¯¼åŒ…</span>
<span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span> 

<span class="token comment">// æ ¹æ®æœåŠ¡åç§°ï¼Œè·å–æœåŠ¡å®ä¾‹ã€‚æœ‰å¯èƒ½æ˜¯é›†ç¾¤ï¼Œæ‰€ä»¥æ˜¯serviceå®ä¾‹é›†åˆ</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">&quot;Module_one&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å› ä¸ºåªæœ‰ä¸€ä¸ªService-providerã€‚æ‰€ä»¥è·å–ç¬¬ä¸€ä¸ªå®ä¾‹</span>
<span class="token class-name">ServiceInstance</span> instance <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// è·å–ipå’Œç«¯å£ä¿¡æ¯ï¼Œæ‹¼æ¥æˆæœåŠ¡åœ°å€</span>
<span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://&quot;</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/financing/findall?id={id}&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// è·å– æœåŠ¡ç«¯çš„IP åœ°å€</span>
instance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// è·å– æœåŠ¡ç«¯çš„ç«¯å£   </span>
instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    
<span class="token comment">// ä½¿ç”¨ è´Ÿè½½å‡è¡¡ å¯ç›´æ¥è°ƒç”¨ æœåŠ¡å </span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/porttest&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">porttest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// String url = &quot;http://æœåŠ¡å/financing/getPort&quot;;</span>
   <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://Moduleone/financing/getPort&quot;</span><span class="token punctuation">;</span>
   <span class="token class-name">String</span> forObject <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">return</span> forObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="eureka-server-é«˜å¯ç”¨æ€§"><a href="#eureka-server-é«˜å¯ç”¨æ€§" class="header-anchor">#</a> Eureka Server é«˜å¯ç”¨æ€§</h2> <p>Eureka Serverå³æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨åˆšæ‰çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªEurekaServerï¼Œäº‹å®ä¸ŠEurekaServerä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œå½¢æˆé«˜å¯ç”¨çš„Eurekaä¸­å¿ƒã€‚</p> <blockquote><p>æœåŠ¡åŒæ­¥</p></blockquote> <p>å¤šä¸ªEureka Serverä¹‹é—´ä¹Ÿä¼šäº’ç›¸æ³¨å†Œä¸ºæœåŠ¡ï¼Œå½“æœåŠ¡æä¾›è€…æ³¨å†Œåˆ°Eureka Serveré›†ç¾¤ä¸­çš„æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¼šæŠŠæœåŠ¡çš„ä¿¡æ¯åŒæ­¥ç»™é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œä»è€Œå®ç°<strong>æ•°æ®åŒæ­¥</strong>ã€‚å› æ­¤ï¼Œæ— è®ºå®¢æˆ·ç«¯è®¿é—®åˆ°Eureka Serveré›†ç¾¤ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œéƒ½å¯ä»¥è·å–åˆ°å®Œæ•´çš„æœåŠ¡åˆ—è¡¨ä¿¡æ¯ã€‚</p> <h3 id="eureka-server-é›†ç¾¤é…ç½®"><a href="#eureka-server-é›†ç¾¤é…ç½®" class="header-anchor">#</a> Eureka Server é›†ç¾¤é…ç½®</h3> <blockquote><p>10086-æ³¨å†Œä¸­å¿ƒ è°ƒç”¨  10087-æ³¨å†Œä¸­å¿ƒ çš„åœ°å€</p> <p>åä¹‹ 10087-æ³¨å†Œä¸­å¿ƒ è°ƒç”¨  10086-æ³¨å†Œä¸­å¿ƒ çš„åœ°å€</p> <p>å½¢æˆç›¸äº’è°ƒç”¨çš„å…³ç³»  å†…å®¹éƒ½å°†å…±äº« å³ä½¿å…¶ä¸­ä¸€ä¸ªå®•æœºä¹Ÿä¸ä¼šå½±å“è¿è¡Œ</p></blockquote> <p><strong>æ³¨æ„ç‚¹:</strong></p> <ul><li><p>ç¬¬ä¸€ä¸ªæ³¨å†Œä¸­å¿ƒåœ¨å¯åŠ¨æ—¶ä¼šæŠ¥é”™ æ‰¾ä¸åˆ°10087 æ˜¯æ­£å¸¸çš„ ä¼šæ¯è¿‡ä¸€æ®µæ—¶é—´å†æ¬¡è¿æ¥</p></li> <li><p>æ³¨å†Œä¸­å¿ƒçš„é…ç½® éœ€å¼€å¯è‡ªåŠ¨æ³¨å†Œ</p></li> <li><p>æœåŠ¡ç«¯çš„é…ç½®åœ¨è®¾ç½®æ³¨å†Œä¸­å¿ƒçš„åœ°å€éœ€å†™å…¥ä½¿ç”¨çš„æ³¨å†Œä¸­å¿ƒçš„åœ°å€ ä»¥ , é€—å·éš”å¼€</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span> <span class="token comment">## EurekaServeråœ°å€,å¤šä¸ªåœ°å€ä»¥','éš”å¼€</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka<span class="token punctuation">,</span>http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10087/eureka
</code></pre></div></li></ul> <h4 id="ä¸€-application-yml"><a href="#ä¸€-application-yml" class="header-anchor">#</a> ä¸€.  application.yml</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> EurekaServer

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10086</span> <span class="token comment">## ç«¯å£</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">## EurekaServeré›†ç¾¤ è°ƒç”¨ 10087ã€‚</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10087/eureka
    <span class="token comment">## ä¸æŠŠè‡ªå·±æ³¨å†Œåˆ°eurekaæœåŠ¡åˆ—è¡¨</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## æ‹‰å–eurekaæœåŠ¡ä¿¡æ¯</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment">## è®¾ç½® IP</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token comment">## å®¢æˆ·ç«¯åœ¨æ³¨å†Œæ—¶ä½¿ç”¨è‡ªå·±çš„IPè€Œä¸æ˜¯ä¸»æœºå</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## å®ä¾‹id</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
</code></pre></div><h4 id="äºŒ-application-yml"><a href="#äºŒ-application-yml" class="header-anchor">#</a> äºŒ.  application.yml</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> EurekaServer

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10087</span> <span class="token comment">## ç«¯å£</span>

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">## EurekaServeré›†ç¾¤ è°ƒç”¨ 10087ã€‚</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
    <span class="token comment">## ä¸æŠŠè‡ªå·±æ³¨å†Œåˆ°eurekaæœåŠ¡åˆ—è¡¨</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## æ‹‰å–eurekaæœåŠ¡ä¿¡æ¯</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment">## è®¾ç½® IP</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token comment">## å®¢æˆ·ç«¯åœ¨æ³¨å†Œæ—¶ä½¿ç”¨è‡ªå·±çš„IPè€Œä¸æ˜¯ä¸»æœºå</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## å®ä¾‹id</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>
</code></pre></div><h3 id="è·å–æœåŠ¡åˆ—è¡¨"><a href="#è·å–æœåŠ¡åˆ—è¡¨" class="header-anchor">#</a> è·å–æœåŠ¡åˆ—è¡¨</h3> <p>å½“æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨æ—¶ï¼Œä¼šæ£€æµ‹<code>eureka.client.fetch-registry=true</code>å‚æ•°çš„å€¼ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™ä¼šæ‹‰å–Eureka ServeræœåŠ¡çš„åˆ—è¡¨åªè¯»å¤‡ä»½ï¼Œç„¶åç¼“å­˜åœ¨æœ¬åœ°ã€‚å¹¶ä¸”<code>æ¯éš”30ç§’</code>ä¼šé‡æ–°è·å–å¹¶æ›´æ–°æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‚æ•°æ¥ä¿®æ”¹ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
</code></pre></div><p>ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¿®æ”¹è¿™ä¸ªå€¼ã€‚
ä½†æ˜¯ä¸ºäº†å¼€å‘ç¯å¢ƒä¸‹ï¼Œèƒ½å¤Ÿå¿«é€Ÿå¾—åˆ°æœåŠ¡çš„æœ€æ–°çŠ¶æ€ï¼Œæˆ‘ä»¬å¯ä»¥å°†å…¶è®¾ç½®å°ä¸€ç‚¹ã€‚</p> <h3 id="å¤±æ•ˆå‰”é™¤å’Œè‡ªæˆ‘ä¿æŠ¤"><a href="#å¤±æ•ˆå‰”é™¤å’Œè‡ªæˆ‘ä¿æŠ¤" class="header-anchor">#</a> å¤±æ•ˆå‰”é™¤å’Œè‡ªæˆ‘ä¿æŠ¤</h3> <blockquote><p>æœåŠ¡ä¸‹çº¿</p></blockquote> <p>å½“æœåŠ¡è¿›è¡Œæ­£å¸¸å…³é—­æ“ä½œæ—¶ï¼Œå®ƒä¼šè§¦å‘ä¸€ä¸ªæœåŠ¡ä¸‹çº¿çš„RESTè¯·æ±‚ç»™Eureka Serverï¼Œå‘Šè¯‰æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼šâ€œæˆ‘è¦ä¸‹çº¿äº†â€ã€‚æœåŠ¡ä¸­å¿ƒæ¥å—åˆ°è¯·æ±‚ä¹‹åï¼Œå°†è¯¥æœåŠ¡ç½®ä¸ºä¸‹çº¿çŠ¶æ€ã€‚</p> <blockquote><p>å¤±æ•ˆå‰”é™¤</p></blockquote> <p>æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬çš„æœåŠ¡æä¾›æ–¹å¹¶ä¸ä¸€å®šä¼šæ­£å¸¸ä¸‹çº¿ï¼Œå¯èƒ½å› ä¸ºå†…å­˜æº¢å‡ºã€ç½‘ç»œæ•…éšœç­‰åŸå› å¯¼è‡´æœåŠ¡æ— æ³•æ­£å¸¸å·¥ä½œã€‚Eureka Serveréœ€è¦å°†è¿™æ ·çš„æœåŠ¡å‰”é™¤å‡ºæœåŠ¡åˆ—è¡¨ã€‚å› æ­¤å®ƒä¼šå¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”60ç§’å¯¹æ‰€æœ‰å¤±æ•ˆçš„æœåŠ¡ï¼ˆè¶…è¿‡90ç§’æœªå“åº”ï¼‰è¿›è¡Œå‰”é™¤ã€‚</p> <p>å¯ä»¥é€šè¿‡<code>eureka.server.eviction-interval-timer-in-ms</code>å‚æ•°å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œç”Ÿäº§ç¯å¢ƒä¸è¦ä¿®æ”¹ã€‚</p> <p>è¿™ä¸ªä¼šå¯¹æˆ‘ä»¬å¼€å‘å¸¦æ¥æå¤§çš„ä¸å˜ï¼Œä½ å¯¹æœåŠ¡é‡å¯ï¼Œéš”äº†60ç§’Eurekaæ‰ååº”è¿‡æ¥ã€‚å¼€å‘é˜¶æ®µå¯ä»¥é€‚å½“è°ƒæ•´ï¼Œæ¯”å¦‚ï¼š10ç§’</p> <blockquote><p>è‡ªæˆ‘ä¿æŠ¤</p></blockquote> <p>æˆ‘ä»¬å…³åœä¸€ä¸ªæœåŠ¡ï¼Œå°±ä¼šåœ¨Eurekaé¢æ¿çœ‹åˆ°ä¸€æ¡è­¦å‘Šï¼š</p> <p>è¿™æ˜¯è§¦å‘äº†Eurekaçš„è‡ªæˆ‘ä¿æŠ¤æœºåˆ¶ã€‚å½“ä¸€ä¸ªæœåŠ¡æœªæŒ‰æ—¶è¿›è¡Œå¿ƒè·³ç»­çº¦æ—¶ï¼ŒEurekaä¼šç»Ÿè®¡æœ€è¿‘15åˆ†é’Ÿå¿ƒè·³å¤±è´¥çš„æœåŠ¡å®ä¾‹çš„æ¯”ä¾‹æ˜¯å¦è¶…è¿‡äº†85%ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œå› ä¸ºç½‘ç»œå»¶è¿Ÿç­‰åŸå› ï¼Œå¿ƒè·³å¤±è´¥å®ä¾‹çš„æ¯”ä¾‹å¾ˆæœ‰å¯èƒ½è¶…æ ‡ï¼Œä½†æ˜¯æ­¤æ—¶å°±æŠŠæœåŠ¡å‰”é™¤åˆ—è¡¨å¹¶ä¸å¦¥å½“ï¼Œå› ä¸ºæœåŠ¡å¯èƒ½æ²¡æœ‰å®•æœºã€‚Eurekaå°±ä¼šæŠŠå½“å‰å®ä¾‹çš„æ³¨å†Œä¿¡æ¯ä¿æŠ¤èµ·æ¥ï¼Œä¸äºˆå‰”é™¤ã€‚ç”Ÿäº§ç¯å¢ƒä¸‹è¿™å¾ˆæœ‰æ•ˆï¼Œä¿è¯äº†å¤§å¤šæ•°æœåŠ¡ä¾ç„¶å¯ç”¨ã€‚</p> <p>ä½†æ˜¯è¿™ç»™æˆ‘ä»¬çš„å¼€å‘å¸¦æ¥äº†éº»çƒ¦ï¼Œ å› æ­¤å¼€å‘é˜¶æ®µæˆ‘ä»¬éƒ½ä¼šå…³é—­è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼šï¼ˆwoniu-eurekaï¼‰</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">enable-self-preservation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment">## å…³é—­è‡ªæˆ‘ä¿æŠ¤æ¨¡å¼ï¼ˆç¼ºçœä¸ºæ‰“å¼€ï¼‰</span>
    <span class="token key atrule">eviction-interval-timer-in-ms</span><span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token comment">## æ‰«æå¤±æ•ˆæœåŠ¡çš„é—´éš”æ—¶é—´ï¼ˆç¼ºçœä¸º60*1000msï¼‰</span>
</code></pre></div><h2 id="ribbon-è´Ÿè½½å‡è¡¡-ç»„ä»¶"><a href="#ribbon-è´Ÿè½½å‡è¡¡-ç»„ä»¶" class="header-anchor">#</a> Ribbon  è´Ÿè½½å‡è¡¡ ç»„ä»¶</h2> <h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="header-anchor">#</a> ç®€ä»‹</h3> <p><strong>å®ƒæ˜¯ä¸€ä¸ªè´Ÿè½½å‡è¡¡ç»„ä»¶</strong>ï¼Œåœ¨åˆšæ‰çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯åŠ¨äº†ä¸€ä¸ªwoniu-service-providerï¼Œç„¶åé€šè¿‡DiscoveryClientæ¥è·å–æœåŠ¡å®ä¾‹ä¿¡æ¯ï¼Œç„¶åè·å–ipå’Œç«¯å£æ¥è®¿é—®ã€‚</p> <p>ä½†æ˜¯å®é™…ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šå¼€å¯å¾ˆå¤šä¸ªwoniu-service-providerçš„é›†ç¾¤ã€‚æ­¤æ—¶æˆ‘ä»¬è·å–çš„æœåŠ¡åˆ—è¡¨ä¸­å°±ä¼šæœ‰å¤šä¸ªï¼Œåˆ°åº•è¯¥è®¿é—®å“ªä¸€ä¸ªå‘¢ï¼Ÿ</p> <p>ä¸€èˆ¬è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±éœ€è¦ç¼–å†™è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œåœ¨å¤šä¸ªå®ä¾‹åˆ—è¡¨ä¸­è¿›è¡Œé€‰æ‹©ã€‚
ä¸è¿‡Eurekaä¸­å·²ç»å¸®æˆ‘ä»¬é›†æˆäº†è´Ÿè½½å‡è¡¡ç»„ä»¶ï¼šRibbonï¼Œç®€å•ä¿®æ”¹ä»£ç å³å¯ä½¿ç”¨ã€‚</p> <p>ä»€ä¹ˆæ˜¯Ribbonï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1525619257397.png" alt="1525619257397"></p> <p>åœ¨ä½ æ²¡æœ‰æ„è¯†åˆ° Ribbon å­˜åœ¨çš„æ—¶å€™ï¼ŒRibbon å°±å·²ç»å¯ä»¥åœ¨ä½ çš„é¡¹ç›®ä¸­ï¼ˆé…åˆ RestTemplateï¼‰èµ·ä½œç”¨äº†ã€‚ä¸ºä½ çš„ RestTemplate çš„ @Bean åŠ ä¸Š <strong>@LoadBalanced</strong> æ³¨è§£ï¼š
@LoadBalanced æ³¨è§£èƒŒåå°±æ˜¯ Spring AOP åŠ¨æ€ä»£ç†çš„æ€æƒ³ã€‚</p> <h3 id="å¼€å¯è´Ÿè½½å‡è¡¡"><a href="#å¼€å¯è´Ÿè½½å‡è¡¡" class="header-anchor">#</a> å¼€å¯è´Ÿè½½å‡è¡¡</h3> <ul><li>è°ƒç”¨æ–¹</li></ul> <p>å› ä¸ºEurekaä¸­å·²ç»é›†æˆäº†Ribbonï¼Œæ‰€ä»¥æˆ‘ä»¬æ— éœ€å¼•å…¥æ–°çš„ä¾èµ–ï¼Œç›´æ¥ä¿®æ”¹ä»£ç ã€‚
woniu-service-consumerçš„å¼•å¯¼ç±»ï¼Œåœ¨RestTemplateçš„é…ç½®æ–¹æ³•ä¸Šæ·»åŠ <code>@LoadBalanced</code>æ³¨è§£</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>    <span class="token comment">// è´Ÿè½½å‡è¡¡ ä¸æ·»åŠ è¿™ä¸ªæ³¨è§£ï¼Œä¸èƒ½ç›´æ¥ç”¨æœåŠ¡åè®¿é—®</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>åœ¨è¡¨ç°å±‚å¯ä»¥ç›´æ¥ä½¿ç”¨ æœåŠ¡å è°ƒç”¨</strong></p> <ul><li>æ³¨æ„: æœåŠ¡å ä¸èƒ½ ä¸º '  _ '  ä¸‹åˆ’çº¿ å¦åˆ™ä¼šå‡ºé—®é¢˜ ä¸­åˆ’çº¿åˆ™æ²¡é—®é¢˜</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/porttest&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">porttest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// String url = &quot;http://æœåŠ¡å/financing/getPort&quot;;</span>
    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">&quot;http://Moduleone/financing/getPort&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> forObject <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> forObject<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#è´Ÿè½½å‡è¡¡ç­–ç•¥" class="header-anchor">#</a> è´Ÿè½½å‡è¡¡ç­–ç•¥</h3> <p>Ribboné»˜è®¤çš„è´Ÿè½½å‡è¡¡ç­–ç•¥æ˜¯ç®€å•çš„è½®è¯¢ï¼Œæˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼š</p> <p>ç¼–å†™æµ‹è¯•ç±»ï¼Œåœ¨åˆšæ‰çš„æºç ä¸­æˆ‘ä»¬çœ‹åˆ°æ‹¦æˆªä¸­æ˜¯ä½¿ç”¨RibbonLoadBalanceClientæ¥è¿›è¡Œè´Ÿè½½å‡è¡¡çš„ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªchooseæ–¹æ³•ï¼Œæ‰¾åˆ°chooseæ–¹æ³•çš„æ¥å£æ–¹æ³•ï¼Œæ˜¯è¿™æ ·ä»‹ç»çš„ï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1525622320277-1658206507070.png" alt="1525622320277"></p> <p>SpringBootä¹Ÿå¸®æˆ‘ä»¬æä¾›äº†ä¿®æ”¹è´Ÿè½½å‡è¡¡è§„åˆ™çš„é…ç½®å…¥å£ï¼Œåœ¨woniu-service-consumerçš„application.ymlä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š</p> <p><strong>è°ƒç”¨æ–¹æ·»åŠ  è´Ÿè½½å‡è¡¡ çš„é…ç½®</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>consumer
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
<span class="token key atrule">service-provider</span><span class="token punctuation">:</span>  <span class="token comment">## å†’å·å·¦ä¾§ä¸º: æœåŠ¡å æ³¨æ„å¤§å°å†™</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  	<span class="token comment">## è´Ÿè½½å‡è¡¡ç­–ç•¥: éšæœºç­–ç•¥ å¯è¿›è¡Œè®¾ç½®</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule
</code></pre></div><p>æ ¼å¼æ˜¯ï¼š<code>{æœåŠ¡åç§°}.ribbon.NFLoadBalancerRuleClassName</code>ï¼Œå€¼å°±æ˜¯IRuleçš„å®ç°ç±»ã€‚</p> <h3 id="è´Ÿè½½å‡è¡¡-å†…ç½®ç­–ç•¥"><a href="#è´Ÿè½½å‡è¡¡-å†…ç½®ç­–ç•¥" class="header-anchor">#</a> è´Ÿè½½å‡è¡¡ å†…ç½®ç­–ç•¥</h3> <p>Ribbon å†…ç½®äº† 8 ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼ˆå…¶å®æ˜¯ 7 ç§ï¼‰ï¼Œå®ƒä»¬éƒ½ç›´æ¥æˆ–é—´æ¥å®ç°äº† <strong>IRule</strong> æ¥å£ï¼š</p> <ul><li><p>RandomRule	éšæœºç­–ç•¥	éšæœºé€‰æ‹© Server</p></li> <li><p>RoundRobinRule	è½®è¯¢ç­–ç•¥ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰	æŒ‰é¡ºåºå¾ªç¯é€‰æ‹© Server</p></li> <li><p>RetryRule	é‡è¯•ç­–ç•¥	åœ¨ä¸€ä¸ªé…ç½®æ—¶é—´æ®µå†…å½“é€‰æ‹© Server ä¸æˆåŠŸï¼Œåˆ™ä¸€ç›´å°è¯•é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ Server</p></li> <li><p>BestAvailableRule	è¿™ç§ç­–ç•¥ä¸‹ï¼ŒRibbon ä¼šè§‚æµ‹ã€ç»Ÿè®¡ç›®æ ‡æœåŠ¡çš„å„ä¸ªå®ä¾‹çš„è¿è¡ŒçŠ¶å†µã€å¹¶å‘é‡ã€‚</p> <p>å½“å†æ¬¡å‘èµ·å¯¹ç›®æ ‡æœåŠ¡çš„è®¿é—®æ—¶ï¼ŒRibbon ä¼šå…ˆè¿‡æ»¤æ‰å› ä¸ºå¤šæ¬¡è®¿é—®æ•…éšœè€Œè¢«æ ‡è®°ä¸º Error çš„ å®ä¾‹ã€‚ç„¶åé€‰æ‹©ä¸€ä¸ªå¹¶å‘é‡ï¼ˆActiveRequestCountï¼‰æœ€å°çš„å®ä¾‹å‘èµ·è®¿é—®ã€‚ä¿—è¯è¯´å°±æ˜¯ï¼šå…ˆå»æ‰ä¸èƒ½å¹²æ´»çš„ï¼Œç„¶ååœ¨èƒ½å¹²æ´»çš„é‡Œé¢æ‰¾ä¸€ä¸ªæœ€é—²çš„ã€‚</p></li> <li><p>AvailabilityFilteringRule	å¯ç”¨è¿‡æ»¤ç­–ç•¥	è¿‡æ»¤æ‰ä¸€ç›´è¿æ¥å¤±è´¥å¹¶è¢«æ ‡è®°ä¸º circuit tripped çš„ Serverï¼Œè¿‡æ»¤æ‰é‚£äº›é«˜å¹¶å‘è¿æ¥çš„ Serverï¼ˆactive connections è¶…è¿‡é…ç½®çš„ç½‘å€¼ï¼‰</p></li> <li><p>WeightedResponseTimeRule å“åº”æ—¶é—´åŠ æƒç­–ç•¥	æ ¹æ® Server çš„å“åº”æ—¶é—´åˆ†é…æƒé‡ã€‚å“åº”æ—¶é—´è¶Šé•¿ï¼Œæƒé‡è¶Šä½ï¼Œè¢«é€‰æ‹©åˆ°çš„æ¦‚ç‡å°±è¶Šä½ï¼›å“åº”æ—¶é—´è¶ŠçŸ­ï¼Œæƒé‡è¶Šé«˜ï¼Œè¢«é€‰æ‹©åˆ°çš„æ¦‚ç‡å°±è¶Šé«˜ã€‚è¿™ä¸ªç­–ç•¥å¾ˆè´´åˆ‡ï¼Œç»¼åˆäº†å„ç§å› ç´ ï¼Œå¦‚ï¼šç½‘ç»œã€ç£ç›˜ã€IOç­‰ï¼Œè¿™äº›å› ç´ ç›´æ¥å½±å“ç€å“åº”æ—¶é—´</p></li> <li><p>ZoneAvoidanceRule	åŒºåŸŸæƒè¡¡ç­–ç•¥	ç»¼åˆåˆ¤æ–­ Server æ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œ Server çš„å¯ç”¨æ€§è½®è¯¢é€‰æ‹© Serverï¼Œå¹¶ä¸”åˆ¤å®šä¸€ä¸ª AWS Zone çš„è¿è¡Œæ€§èƒ½æ˜¯å¦å¯ç”¨ï¼Œå‰”é™¤ä¸å¯ç”¨çš„ Zone ä¸­çš„æ‰€æœ‰ Server</p></li></ul> <h3 id="ribbon-çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•"><a href="#ribbon-çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•" class="header-anchor">#</a> Ribbon çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•</h3> <p>ç†è®ºä¸Šï¼ŒRibbon æ˜¯æœ‰è¶…æ—¶è®¾ç½®ï¼Œä»¥åŠè¶…æ—¶ä¹‹åçš„é‡è¯•åŠŸèƒ½çš„ã€‚ä½†æ˜¯ï¼Œåœ¨ RestTemplate å’Œ Ribbon ç»“åˆçš„æ–¹æ¡ˆä¸­ï¼ŒRibbon çš„è¶…æ—¶è®¾ç½®å’Œé‡è¯•è®¾ç½®çš„é…ç½®æ–¹å¼ä¸€ç›´åœ¨å˜åŠ¨ï¼Œå› æ­¤æœ‰å¾ˆå¤šã€é…ç½®æ— æ•ˆã€çš„ç°è±¡ï¼Œååˆ†è¯¡å¼‚ã€‚</p> <p>è€ƒè™‘åˆ°æˆ‘ä»¬åœ¨åç»­çš„é¡¹ç›®ä¸­ä¸ä¼šä½¿ç”¨ RestTemplate å’Œ Ribbon æ•´åˆï¼Œè€Œæ˜¯ä½¿ç”¨ OpenFeign ï¼Œå› æ­¤ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è§£é‡Šäº†ã€‚</p> <h3 id="ribbon-çš„é¥¥é¥¿åŠ è½½"><a href="#ribbon-çš„é¥¥é¥¿åŠ è½½" class="header-anchor">#</a> Ribbon çš„é¥¥é¥¿åŠ è½½</h3> <p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡æ¶ˆè´¹æ–¹è°ƒç”¨æœåŠ¡æä¾›æ–¹æ¥å£çš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚ä¼šæ…¢ä¸€äº›ï¼Œç”šè‡³ä¼šè¶…æ—¶ï¼Œè€Œä¹‹åçš„è°ƒç”¨å°±æ²¡æœ‰é—®é¢˜äº†ã€‚</p> <p>è¿™æ˜¯å› ä¸º Ribbon è¿›è¡Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„ Client å¹¶ä¸æ˜¯åœ¨æœåŠ¡å¯åŠ¨çš„æ—¶å€™å°±åˆå§‹åŒ–å¥½çš„ï¼Œè€Œæ˜¯åœ¨è°ƒç”¨çš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºç›¸åº”çš„ Clientï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡è°ƒç”¨çš„è€—æ—¶ä¸ä»…ä»…åŒ…å«å‘é€HTTPè¯·æ±‚çš„æ—¶é—´ï¼Œè¿˜åŒ…å«äº†åˆ›å»º RibbonClient çš„æ—¶é—´ï¼Œè¿™æ ·ä¸€æ¥å¦‚æœåˆ›å»ºæ—¶é—´é€Ÿåº¦è¾ƒæ…¢ï¼ŒåŒæ—¶è®¾ç½®çš„è¶…æ—¶æ—¶é—´åˆæ¯”è¾ƒçŸ­çš„è¯ï¼Œå¾ˆå®¹æ˜“å°±ä¼šå‡ºç°ä¸Šé¢æ‰€æè¿°çš„ç°è±¡ã€‚</p> <p>ä½ å¯ä»¥é€šè¿‡å¯ç”¨ Ribbon çš„é¥¥é¥¿åŠ è½½ï¼ˆå³ï¼Œç«‹å³åŠ è½½ï¼‰æ¨¡å¼ï¼Œå¹¶æŒ‡å®šåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°±è¦åŠ è½½çš„æœåŠ¡ï¼š</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment">## å¼€å¯é¥¥é¥¿åŠ è½½</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span> woniu<span class="token punctuation">-</span>service<span class="token punctuation">-</span>provider(æœåŠ¡å)<span class="token punctuation">,</span> xxx        <span class="token comment">## éœ€è¦é¥¥é¥¿åŠ è½½çš„æœåŠ¡</span>
</code></pre></div><h2 id="hystrix-ç»„ä»¶"><a href="#hystrix-ç»„ä»¶" class="header-anchor">#</a> Hystrix ç»„ä»¶</h2> <p>Hystixæ˜¯Netflixå¼€æºçš„ä¸€ä¸ªå»¶è¿Ÿå’Œå®¹é”™åº“ï¼Œç”¨äºéš”ç¦»è®¿é—®è¿œç¨‹æœåŠ¡ã€ç¬¬ä¸‰æ–¹åº“ï¼Œé˜²æ­¢å‡ºç°çº§è”å¤±è´¥ã€‚</p> <p>æœåŠ¡å™¨æ”¯æŒçš„çº¿ç¨‹å’Œå¹¶å‘æ•°æœ‰é™ï¼Œè¯·æ±‚ä¸€ç›´é˜»å¡ï¼Œä¼šå¯¼è‡´æœåŠ¡å™¨èµ„æºè€—å°½ï¼Œä»è€Œå¯¼è‡´æ‰€æœ‰å…¶å®ƒæœåŠ¡éƒ½ä¸å¯ç”¨ï¼Œå½¢æˆé›ªå´©æ•ˆåº”ã€‚</p> <p>Hystixè§£å†³é›ªå´©é—®é¢˜çš„æ‰‹æ®µæœ‰ä¸¤ä¸ªï¼š</p> <ul><li>çº¿ç¨‹éš”ç¦»(çº¿ç¨‹æ± éš”ç¦»ã€ä¿¡å·é‡éš”ç¦»)</li> <li>æœåŠ¡ç†”æ–­</li></ul> <h3 id="hystrixç†”æ–­-æœåŠ¡é™çº§"><a href="#hystrixç†”æ–­-æœåŠ¡é™çº§" class="header-anchor">#</a> Hystrixç†”æ–­ æœåŠ¡é™çº§</h3> <h4 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="header-anchor">#</a> å¼•å…¥ä¾èµ–</h4> <p>é¦–å…ˆåœ¨woniu-service-consumerçš„pom.xmlä¸­å¼•å…¥Hystrixä¾èµ–ï¼š</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Hystrixç†”æ–­ æœåŠ¡é™çº§--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="å¼€å¯hystrixç†”æ–­"><a href="#å¼€å¯hystrixç†”æ–­" class="header-anchor">#</a> å¼€å¯Hystrixç†”æ–­</h4> <ul><li>è°ƒç”¨æ–¹</li></ul> <blockquote><p>åœ¨æœåŠ¡<strong>è°ƒç”¨æ–¹</strong>å…¥å£å¯åŠ¨ç±»ä¸Šé¢åŠ ä¸Š @EnableHystrixæˆ– @EnableCircuitBreaker æ³¨è§£ï¼Œè¡¨ç¤ºæ¿€æ´»ç†”æ–­å™¨çš„é»˜è®¤é…ç½®,@EnableHystrixæ³¨è§£æ˜¯ @EnableCircuitBreaker çš„è¯­ä¹‰åŒ–ï¼Œå®ƒä»¬çš„å…³ç³»ç±»ä¼¼äº @Serviceå’Œ @Component ã€‚</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span> 
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token comment">// å¼€å¯ Eurekaå®¢æˆ·ç«¯</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span> <span class="token comment">// å¼€å¯Hystrixç†”æ–­</span>
<span class="token comment">//@SpringCloudApplication // ä¸Šé¢çš„ç»„åˆæ³¨è§£</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> woniuServiceConsumerApplication <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ConsumerApp</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç±»ä¸Šçš„æ³¨è§£è¶Šæ¥è¶Šå¤šï¼Œåœ¨å¾®æœåŠ¡ä¸­ï¼Œç»å¸¸ä¼šå¼•å…¥ä¸Šé¢çš„ä¸‰ä¸ªæ³¨è§£ï¼Œäºæ˜¯Springå°±æä¾›äº†ä¸€ä¸ªç»„åˆæ³¨è§£ï¼š@SpringCloudApplication</p> <p>å…¶ä½œç”¨åŒ…å«äº†</p> <ul><li>@SpringBootApplication</li> <li>@EnableDiscoveryClient // å¼€å¯ Eurekaå®¢æˆ·ç«¯</li> <li>@EnableCircuitBreaker // å¼€å¯Hystrixç†”æ–­</li></ul> <h3 id="ç¼–å†™é™çº§é€»è¾‘"><a href="#ç¼–å†™é™çº§é€»è¾‘" class="header-anchor">#</a> ç¼–å†™é™çº§é€»è¾‘</h3> <blockquote><p>å½“ç›®æ ‡æœåŠ¡çš„è°ƒç”¨å‡ºç°æ•…éšœï¼Œæˆ‘ä»¬å¸Œæœ›å¿«é€Ÿå¤±è´¥ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªå‹å¥½æç¤ºã€‚å› æ­¤éœ€è¦æå‰ç¼–å†™å¥½å¤±è´¥æ—¶çš„é™çº§å¤„ç†é€»è¾‘ï¼Œè¦ä½¿ç”¨HystixCommondæ¥å®Œæˆï¼š</p></blockquote> <p>æ³¨æ„: é™çº§é€»è¾‘æ–¹æ³•å¿…é¡»è·Ÿæ­£å¸¸é€»è¾‘æ–¹æ³•ä¿è¯ï¼š<strong>ç›¸åŒçš„å‚æ•°åˆ—è¡¨å’Œè¿”å›å€¼å£°æ˜</strong>ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;consumer/user&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token comment">// æŒ‡å®šæœåŠ¡æŸ¥è¯¢å¼‚å¸¸æ—¶è°ƒç”¨çš„æ–¹æ³•</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;queryUserByIdFallBack&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://service-provider/user/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryUserByIdFallBack</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;è¯·æ±‚ç¹å¿™ï¼Œè¯·ç¨åå†è¯•ï¼&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="é»˜è®¤-fallback"><a href="#é»˜è®¤-fallback" class="header-anchor">#</a> é»˜è®¤ FallBack</h3> <blockquote><p>å¦‚æœæœ‰å¾ˆå¤šè¿™æ ·çš„ä¸šåŠ¡æ–¹æ³•è®¿é—®ä¸äº†æœåŠ¡å™¨éƒ½éœ€è¦é™çº§æ—¶ï¼Œé‚£å²‚ä¸æ˜¯è¦å†™å¾ˆå¤šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠ  @DefaultProperties(defaultFallback = &quot;fallBackMethod&quot;) // æŒ‡å®šä¸€ä¸ªç±»çš„å…¨å±€é™çº§æ–¹æ³•    Fallbacké…ç½®åŠ åœ¨ç±»ä¸Šï¼Œå®ç°é»˜è®¤fallbackï¼š</p> <p>åœ¨æ­¤ç±»çš„æ‰€æœ‰çš„æ–¹æ³•ä¸Š åŠ ä¸Šäº†æ³¨è§£  @HystrixCommand // æ ‡è®°è¯¥æ–¹æ³•éœ€è¦é™çº§ å‡ºç°å¼‚å¸¸æ—¶ éƒ½ä¼šè°ƒç”¨ @DefaultProperties æŒ‡å®šçš„æ–¹æ³•</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;consumer/user&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">&quot;fallBackMethod&quot;</span><span class="token punctuation">)</span> <span class="token comment">// æŒ‡å®šä¸€ä¸ªç±»çš„å…¨å±€é™çº§æ–¹æ³•</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token annotation punctuation">@HystrixCommand</span> <span class="token comment">// æ ‡è®°è¯¥æ–¹æ³•éœ€è¦é™çº§</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">queryUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">&quot;http://service-provider/user/&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * é™çº§æ–¹æ³•
     * è¿”å›å€¼è¦å’Œè¢«é™çº§çš„æ–¹æ³•çš„è¿”å›å€¼ä¸€è‡´
     * é™çº§æ–¹æ³•ä¸éœ€è¦å‚æ•°
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">fallBackMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;è¯·æ±‚ç¹å¿™ï¼Œè¯·ç¨åå†è¯•ï¼&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¯´æ˜ï¼š</p> <ul><li>@DefaultProperties(defaultFallback = &quot;defaultFallBack&quot;)ï¼šåœ¨ç±»ä¸ŠæŒ‡æ˜ç»Ÿä¸€çš„å¤±è´¥é™çº§æ–¹æ³•</li> <li>@HystrixCommandï¼šåœ¨æ–¹æ³•ä¸Šç›´æ¥ä½¿ç”¨è¯¥æ³¨è§£ï¼Œä½¿ç”¨é»˜è®¤çš„é™çº§æ–¹æ³•ã€‚</li> <li>defaultFallbackï¼šé»˜è®¤é™çº§æ–¹æ³•ï¼Œä¸ç”¨ä»»ä½•å‚æ•°ï¼Œä»¥åŒ¹é…æ›´å¤šæ–¹æ³•ï¼Œä½†æ˜¯è¿”å›å€¼ä¸€å®šä¸€è‡´</li></ul> <h3 id="hystrix-è¶…æ—¶é…ç½®"><a href="#hystrix-è¶…æ—¶é…ç½®" class="header-anchor">#</a> Hystrix è¶…æ—¶é…ç½®</h3> <p>Hystrix çš„å…¨å±€é…ç½®ä¹Ÿç§°ä¸ºé»˜è®¤é…ç½®ï¼Œå®ƒä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é€šè¿‡ <strong>hystrix.command.default.*</strong> æ¥è¿›è¡Œé…ç½®ï¼ˆå†æ¬¡å¼ºè°ƒï¼ŒHystrix æ˜¯ç”¨äºæœåŠ¡çš„è°ƒç”¨æ–¹ï¼Œæ‰€ä»¥è¿™é‡Œçš„é…ç½®è‡ªç„¶ä¹Ÿæ˜¯é…ç½®åœ¨æœåŠ¡çš„è°ƒç”¨æ–¹è¿™è¾¹ï¼‰</p> <p>åœ¨ä¹‹å‰çš„æ¡ˆä¾‹ä¸­ï¼Œè¯·æ±‚åœ¨è¶…è¿‡1ç§’åéƒ½ä¼šè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œè¿™æ˜¯å› ä¸ºHystixçš„é»˜è®¤è¶…æ—¶æ—¶é•¿ä¸º1ç§’ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®ä¿®æ”¹è¿™ä¸ªå€¼ï¼š</p> <p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds</code>æ¥è®¾ç½®Hystrixè¶…æ—¶æ—¶é—´ã€‚è¯¥é…ç½®æ²¡æœ‰æç¤ºã€‚</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>  <span class="token comment">#ä¹Ÿå¯ä»¥æŠŠdefault æ”¹æˆæŸä¸ªæœåŠ¡åï¼Œé’ˆå¯¹æŸä¸ªæœåŠ¡ã€‚</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>   <span class="token comment">#å…¶å®æ˜¯å¯¹æ¯ä¸€æ¬¡httpè¯·æ±‚ï¼Œå°±å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œhystrixå†…éƒ¨æœ‰ä¸€ä¸ªçº¿ç¨‹æ± ã€‚</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">6000</span> <span class="token comment">## è®¾ç½®hystrixçš„è¶…æ—¶æ—¶é—´ä¸º6000ms </span>
          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> THREAD    <span class="token comment">##é»˜è®¤æ˜¯é‡‡ç”¨çº¿ç¨‹æ± éš”ç¦»æŠ€æœ¯   å¯ä»¥çœç•¥</span>
             æ³¨æ„ï¼šé…åˆæµ‹è¯•ï¼Œè¦æ”¹é€ æœåŠ¡æä¾›è€…ï¼Œæ‰“å¼€æµè§ˆå™¨ F12 çœ‹çœ‹æ—¶é—´
</code></pre></div><p>æ— è®ºæˆ‘ä»¬çš„ä½¿ç”¨çš„æ˜¯ RestTemplate è¿˜æ˜¯ OpenFeignï¼Œå®ƒä»¬éƒ½ä¼šæ˜¯ä½¿ç”¨åˆ° Ribbon çš„è´Ÿè½½å‡è¡¡ï¼ˆå’Œè¶…æ—¶é‡è¯•ï¼‰èƒ½åŠ›ã€‚è€Œ Ribbon ä¹Ÿä¼šç›‘ç®¡è¯·æ±‚è¶…æ—¶é—®é¢˜ã€‚æ‰€ä»¥ï¼Œç†è®ºä¸Šï¼ŒHystrix çš„è¶…æ—¶æ—¶é•¿çš„åˆ¤æ–­æ ‡å‡†åº”è¯¥å¤§äº Ribbon çš„è¶…æ—¶é‡è¯•çš„æ€»è€—æ—¶ï¼Œå¦åˆ™ï¼Œä¼šå‡ºç° Ribbon è¿˜åœ¨ã€åŠªåŠ›ã€ï¼Œä½†æ˜¯ Hystrix å†³å®šã€æ”¾å¼ƒã€çš„æƒ…å†µã€‚å½“ç„¶ï¼Œè¿™æ ·ä¹Ÿä¸æ˜¯ä¸è¡Œï¼Œåªæ˜¯æœ‰äº›ä¸ç§‘å­¦ã€‚</p> <p>è¦æ³¨æ„ï¼šä¹Ÿå°±æ˜¯è¯´ï¼Œhystrixè§¦å‘ç†”æ–­ä¸ribbonçš„é‡è¯•åœ¨æœºåˆ¶ä¸Šæ²¡å…³ç³»ï¼Œribbonè¯¥é‡è¯•è¿˜æ˜¯ä¼šé‡è¯•ï¼Œå¦‚æœæœ‰é‡è¯•ï¼Œè¿˜ä¼šä½¿å¾—è¢«è°ƒç”¨ç³»ç»Ÿåšæ— ç”¨ä¸”é‡å¤çš„ä¸šåŠ¡</p> <p>é™¤äº†åˆç†çš„å‚æ•°å€¼è®¾ç½®ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥ç›´æ¥å…³é—­æ‰ Hystrix çš„è¶…æ—¶åˆ¤æ–­ï¼Œå®Œå…¨ç”± Ribbon æ¥è¯„åˆ¤ã€ä¸ŠæŠ¥ï¼ˆç»™ Hystrixï¼‰è¶…æ—¶ä¸å¦</p> <p><strong>æ”¹é€ æœåŠ¡æä¾›è€…</strong></p> <p>æ”¹é€ æœåŠ¡æä¾›è€…çš„UserControlleræ¥å£ï¼Œéšæœºä¼‘çœ ä¸€æ®µæ—¶é—´</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">queryUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">queryUserById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å½“6s ä¸èƒ½æ­£å¸¸è¯·æ±‚æœåŠ¡æä¾›è€…ï¼Œå…¶å®å…ˆè§¦å‘ç†”æ–­ï¼Œç„¶åå†é™çº§</p> <h3 id="æœåŠ¡ç†”æ–­æœºåˆ¶"><a href="#æœåŠ¡ç†”æ–­æœºåˆ¶" class="header-anchor">#</a> æœåŠ¡ç†”æ–­æœºåˆ¶</h3> <p>ç†”æ–­å™¨ï¼Œä¹Ÿå«æ–­è·¯å™¨ï¼Œå…¶è‹±æ–‡å•è¯ä¸ºï¼šCircuit Breaker</p> <p><strong>æ³¨æ„:  ç†”æ–­å¼€å¯åªé’ˆå¯¹äº å‡ºç°å¼‚å¸¸çš„æ–¹æ³• å…¶ä»–æ–¹æ³•åˆ™ä¸å—å½±å“ é™¤éåœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®</strong></p> <p>ç†”æ–­çŠ¶æ€æœº3ä¸ªçŠ¶æ€ï¼š</p> <ul><li>Closedï¼šå…³é—­çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½æ­£å¸¸è®¿é—®ã€‚</li> <li>Openï¼šæ‰“å¼€çŠ¶æ€ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½ä¼šè¢«é™çº§ã€‚Hystrixä¼šå¯¹è¯·æ±‚æƒ…å†µè®¡æ•°ï¼Œå½“ä¸€å®šæ—¶é—´å†…å¤±è´¥è¯·æ±‚ç™¾åˆ†æ¯”è¾¾åˆ°é˜ˆå€¼ï¼Œåˆ™è§¦å‘ç†”æ–­ï¼Œæ–­è·¯å™¨ä¼šå®Œå…¨æ‰“å¼€ã€‚é»˜è®¤å¤±è´¥æ¯”ä¾‹çš„é˜ˆå€¼æ˜¯50%ï¼Œè¯·æ±‚æ¬¡æ•°æœ€å°‘ä¸ä½äº20æ¬¡ã€‚é»˜è®¤æ˜¯ äº”ç§’ä¹‹å†…è¯·æ±‚20æ¬¡ å¦‚æœæœ‰10æ¬¡å¤±è´¥ï¼ˆ50%ï¼‰ï¼Œåˆ™æ–­å¼€</li> <li>Half Openï¼šåŠå¼€çŠ¶æ€ï¼ŒopençŠ¶æ€ä¸æ˜¯æ°¸ä¹…çš„ï¼Œæ‰“å¼€åä¼šè¿›å…¥ä¼‘çœ æ—¶é—´ï¼ˆé»˜è®¤æ˜¯5Sï¼‰ã€‚éšåæ–­è·¯å™¨ä¼šè‡ªåŠ¨è¿›å…¥åŠå¼€çŠ¶æ€ã€‚æ­¤æ—¶ä¼šé‡Šæ”¾éƒ¨åˆ†è¯·æ±‚é€šè¿‡ï¼Œè‹¥è¿™äº›è¯·æ±‚éƒ½æ˜¯å¥åº·çš„ï¼Œåˆ™ä¼šå®Œå…¨å…³é—­æ–­è·¯å™¨ï¼Œå¦åˆ™ç»§ç»­ä¿æŒæ‰“å¼€ï¼Œå†æ¬¡è¿›è¡Œä¼‘çœ è®¡æ—¶</li></ul> <h4 id="ç†”æ–­ç­–ç•¥é…ç½®"><a href="#ç†”æ–­ç­–ç•¥é…ç½®" class="header-anchor">#</a> ç†”æ–­ç­–ç•¥é…ç½®</h4> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">hystrix.command.default.circuitBreaker.requestVolumeThreshold</span><span class="token punctuation">=</span><span class="token attr-value">10</span>
<span class="token attr-name">hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds</span><span class="token punctuation">=</span><span class="token attr-value">10000</span>
<span class="token attr-name">hystrix.command.default.circuitBreaker.errorThresholdPercentage</span><span class="token punctuation">=</span><span class="token attr-value">50</span>
</code></pre></div><div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
            <span class="token key atrule">execution</span><span class="token punctuation">:</span>
                <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
                    <span class="token key atrule">thread</span><span class="token punctuation">:</span>
                    	<span class="token comment">## Hystrix è¶…æ—¶é…ç½®</span>
                        <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">6000</span>
            <span class="token key atrule">circuitBreaker</span><span class="token punctuation">:</span>
            	<span class="token comment">## 20 æ¬¡è¯·æ±‚</span>
                <span class="token key atrule">requestVolumeThreshold</span><span class="token punctuation">:</span> <span class="token number">20</span>
                <span class="token comment">## å¾…æœº 10ç§’è¿›å…¥åŠå¼€çŠ¶æ€</span>
                <span class="token key atrule">sleepWindowInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">10000</span>
                <span class="token comment">## 20 æ¬¡è¯·æ±‚ æœ‰50%çš„è¯·æ±‚ å‡ºç°å¼‚å¸¸åˆ™é™çº§</span>
                <span class="token key atrule">errorThresholdPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
                <span class="token comment">#forceOpen: true    #æ˜¯å¦å¼ºåˆ¶å¼€å¯ç†”æ–­ï¼ˆè·³é—¸ï¼‰ï¼Œé»˜è®¤falseï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™æ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«æ‹’ç»ï¼Œç›´æ¥æ‰§è¡Œfallbacké™çº§æ–¹æ³•</span>
</code></pre></div><p>è§£è¯»ï¼š</p> <ul><li>requestVolumeThresholdï¼šè§¦å‘ç†”æ–­çš„æœ€å°è¯·æ±‚æ¬¡æ•°ï¼Œé»˜è®¤20ï¼Œé€šè¿‡ä¸€ä¸ªçª—å£10så†…è¯·æ±‚æ•°å¤§äº20ä¸ªå°±å¯åŠ¨ç†”æ–­å™¨</li> <li>errorThresholdPercentageï¼šè§¦å‘ç†”æ–­çš„å¤±è´¥è¯·æ±‚æœ€å°å æ¯”ï¼Œé»˜è®¤50%</li> <li>sleepWindowInMillisecondsï¼šä¼‘çœ æ—¶é•¿ï¼Œé»˜è®¤æ˜¯5000æ¯«ç§’</li> <li>forceOpen æ˜¯å¦å¼ºåˆ¶è·³é—¸</li></ul> <h2 id="open-feign-è¿œç¨‹è°ƒç”¨ç»„ä»¶"><a href="#open-feign-è¿œç¨‹è°ƒç”¨ç»„ä»¶" class="header-anchor">#</a> Open Feign è¿œç¨‹è°ƒç”¨ç»„ä»¶</h2> <p>Feignæ˜¯ä¸€ä¸ªè¿œç¨‹è°ƒç”¨ç»„ä»¶ï¼Œé›†æˆäº†ribbonå’Œhystrixã€‚åœ¨å‰é¢çš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†Ribbonçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œå¤§å¤§ç®€åŒ–äº†è¿œç¨‹è°ƒç”¨æ—¶çš„ä»£ç ï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1525652009416.png" alt="1525652009416"></p> <h3 id="open-feign-åˆ›å»º"><a href="#open-feign-åˆ›å»º" class="header-anchor">#</a> Open Feign åˆ›å»º</h3> <h4 id="å¼•å…¥ä¾èµ–-2"><a href="#å¼•å…¥ä¾èµ–-2" class="header-anchor">#</a> å¼•å…¥ä¾èµ–</h4> <p>åœ¨åˆ›å»ºä¸€ä¸ª Spring Boot Maven é¡¹ç›®ï¼Œåœ¨ Spring Initializer ä¸­å¼•å…¥ä¾èµ–ï¼š</p> <ul><li>åœ¨ Initializer çš„æœç´¢æ¡†å†…æœç´¢ Eureka Clientå’Œ OpenFeign ã€‚ æˆ–</li> <li>åœ¨ Spring Cloud Discovery ä¸‹é€‰æ‹© Eureka Discovery Client ï¼›åœ¨ Spring Cloud Routing ä¸‹é€‰æ‹© OpenFeign</li></ul> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Open Feign è¿œç¨‹è°ƒç”¨ç»„ä»¶--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--EurekaServer-è‡ªåŠ¨æ³¨å†Œ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Web--&gt;</span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="application-yaml"><a href="#application-yaml" class="header-anchor">#</a> application.yaml</h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">7000</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>client<span class="token punctuation">-</span>consumer<span class="token punctuation">-</span>feign
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
</code></pre></div><h4 id="å¯åŠ¨ç±»-æ³¨è§£"><a href="#å¯åŠ¨ç±»-æ³¨è§£" class="header-anchor">#</a> å¯åŠ¨ç±» æ³¨è§£</h4> <blockquote><p>@EnableFeignClients  å†…ç½®äº†ç†”æ–­å™¨å’Œè´Ÿè½½å‡è¡¡æ³¨è§£</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token comment">// å¼€å¯Eurekaå®¢æˆ·ç«¯åŠŸèƒ½</span>
<span class="token annotation punctuation">@EnableFeignClients</span> <span class="token comment">// å¼€å¯feignå®¢æˆ·ç«¯ï¼Œæ— éœ€é…ç½®ç†”æ–­å™¨å’Œè´Ÿè½½å‡è¡¡æ³¨è§£</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaFeignApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaFeignApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¯åŠ¨ç±»å¢åŠ äº†ä¸€ä¸ªæ–°çš„æ³¨è§£: <strong>@EnableFeignClients</strong>ï¼Œå¦‚æœæˆ‘ä»¬è¦ä½¿ç”¨ Feignï¼ˆå£°æ˜å¼ HTTP å®¢æˆ·ç«¯ï¼‰ï¼Œå¿…é¡»è¦åœ¨å¯åŠ¨ç±»åŠ å…¥è¿™ä¸ªæ³¨è§£ï¼Œä»¥å¼€å¯ Feign ã€‚</p> <h4 id="åˆ›å»ºfeignçš„å®¢æˆ·ç«¯-æ¥å£"><a href="#åˆ›å»ºfeignçš„å®¢æˆ·ç«¯-æ¥å£" class="header-anchor">#</a> åˆ›å»ºFeignçš„å®¢æˆ·ç«¯ æ¥å£</h4> <p><strong>é˜²å‘è¯´æ˜ï¼š</strong></p> <ul><li>æ–¹æ³•çš„è¿”å›å€¼ã€å‚æ•°ä»¥åŠrequestmappingè·¯å¾„è¦å’ŒæœåŠ¡æ–¹çš„ä¸€æ¨¡ä¸€æ ·ï¼Œå’Œè°ƒç”¨æ–¹æ— å…³ï¼Œæ¶ˆè´¹æ–¹åªè¦è°ƒç”¨è¯¥æ–¹æ³•å¾—åˆ°ç»“æœ</li> <li>å¦‚æœæœåŠ¡æ–¹controllerç±»æœ‰@RequestMapping å®šä¹‰å‘½åç©ºé—´ï¼Œå¦‚user,åœ¨è¿™é‡Œæˆ‘ä»¬å»ºè®®åœ¨æ–¹æ³•ä¸Šé¢æ‹¼æ¥ï¼Œä¸èƒ½åœ¨UserClientæ¥å£ä¸Šå»å®šä¹‰@requestMapping(&quot;/user/&quot;)  ä¸”æ³¨æ„è·¯å¾„å¿…é¡»å®Œæ•´</li> <li>@PathVariable(&quot;id&quot;) è¿™ä¸ªæ‹¬å·é‡Œé¢çš„idä¸èƒ½çœç•¥  åŒç†@Requestparam(&quot;id&quot;)é‡Œé¢çš„idä¹Ÿä¸èƒ½çœç•¥</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span></span><span class="token class-name">Client</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">&quot;Moduletow&quot;</span><span class="token punctuation">)</span> <span class="token comment">// æ ‡æ³¨è¯¥ç±»æ˜¯ä¸€ä¸ªfeignæ¥å£ ä¸”é“¾æ¥åˆ°æœåŠ¡æ–¹</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FinancingClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/financing/testopenfeign/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testopenfeign</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li>é¦–å…ˆè¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒFeignä¼šé€šè¿‡åŠ¨æ€ä»£ç†ï¼Œå¸®æˆ‘ä»¬ç”Ÿæˆå®ç°ç±»ã€‚è¿™ç‚¹è·Ÿmybatisçš„mapperå¾ˆåƒ</li> <li><code>@FeignClient</code>ï¼Œå£°æ˜è¿™æ˜¯ä¸€ä¸ªFeignå®¢æˆ·ç«¯ï¼Œç±»ä¼¼<code>@Mapper</code>æ³¨è§£ã€‚åŒæ—¶é€šè¿‡<code>value</code>å±æ€§æŒ‡å®šæœåŠ¡åç§°</li> <li>æ¥å£ä¸­çš„å®šä¹‰æ–¹æ³•ï¼Œå®Œå…¨é‡‡ç”¨SpringMVCçš„æ³¨è§£ï¼ŒFeignä¼šæ ¹æ®æ³¨è§£å¸®æˆ‘ä»¬ç”ŸæˆURLï¼Œå¹¶è®¿é—®è·å–ç»“æœ</li></ul> <ul><li>ä¸€ä¸ªæœåŠ¡åªèƒ½è¢«ä¸€ä¸ªç±»ç»‘å®šï¼Œä¸èƒ½è®©å¤šä¸ªç±»ç»‘å®šåŒä¸€ä¸ªè¿œç¨‹æœåŠ¡ï¼Œå¦åˆ™ï¼Œä¼šåœ¨å¯åŠ¨é¡¹ç›®æ˜¯å‡ºç°ã€<strong>å·²ç»‘å®š</strong>ã€å¼‚å¸¸</li></ul> <h4 id="è°ƒç”¨æ–¹-è¡¨ç°å±‚"><a href="#è°ƒç”¨æ–¹-è¡¨ç°å±‚" class="header-anchor">#</a> è°ƒç”¨æ–¹ è¡¨ç°å±‚</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span></span><span class="token class-name">Client<span class="token punctuation">.</span>FinancingClient</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RequestMapping</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinancingController</span> <span class="token punctuation">{</span>

    <span class="token comment">// è·å–ClientæœåŠ¡æ¥å£</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">FinancingClient</span> financingClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/three&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testopenfeign</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨æ¥å£ å¹¶ä¼ å‚</span>
        <span class="token class-name">String</span> testopenfeign <span class="token operator">=</span> financingClient<span class="token punctuation">.</span><span class="token function">testopenfeign</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> testopenfeign<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h4 id="æœåŠ¡æ–¹"><a href="#æœåŠ¡æ–¹" class="header-anchor">#</a> æœåŠ¡æ–¹</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testopenfeign/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testopenfeign</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;æˆåŠŸè¿›å…¥towæœåŠ¡,IDä¸º: &quot;</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="open-feign-è¯·æ±‚æ³¨è§£"><a href="#open-feign-è¯·æ±‚æ³¨è§£" class="header-anchor">#</a> Open Feign è¯·æ±‚æ³¨è§£</h2> <p><strong>é˜²å‘æŒ‡å—:</strong></p> <ul><li>è°ƒç”¨æ–¹çš„è¡¨ç°å±‚ä¸Clientæ¥å£çš„è¯·æ±‚ä¸å†²çª ä½¿ç”¨è¡¨ç°å±‚çš„è¯·æ±‚å¯éšæ„</li> <li>è°ƒç”¨æ–¹çš„Clientæ¥å£é‡Œ å› ä¸ºä¸æ˜¯æµè§ˆå™¨å‘å‡ºè¯·æ±‚ æ‰€ä»¥æ‰€æœ‰çš„è¯·æ±‚éƒ½éœ€è¦åŠ ä¸Šå¯¹åº”çš„æ³¨è§£</li> <li>æœåŠ¡æ–¹çš„è¯·æ±‚å»ºè®®åŠ ä¸Šè·Ÿè°ƒç”¨æ–¹çš„Clientæ¥å£é‡Œä¸€æ ·åŠ ä¸Šå¯¹åº”çš„æ³¨è§£</li> <li>æ–¹æ³•ä¸€æ—¦å†™ä¸Šäº†å‚æ•° åˆ™åœ¨è¯·æ±‚æ—¶å¿…é¡»å¸¦ä¸Šå‚æ•°æ²¡æœ‰å€¼ä¹Ÿå¯ä»¥ å¦‚: id= | å¦åˆ™æŠ¥é”™</li></ul> <h3 id="token-é—®é¢˜"><a href="#token-é—®é¢˜" class="header-anchor">#</a> token é—®é¢˜</h3> <blockquote><p>å¾®æœåŠ¡ Open Feign è¿œç¨‹è°ƒç”¨ç»„ä»¶ åœ¨è°ƒç”¨å¯¹æ–¹è¯·æ±‚è·å–æ•°æ®æ—¶ å¦‚æœè¯¥å¾®æœåŠ¡ä½¿ç”¨çš„securityå®‰å…¨æ¡†æ¶ åˆ™å¿…é¡»åœ¨ è¯·æ±‚å¤´å¸¦ä¸Štoken å¦åˆ™æ— æ³•è®¿é—®</p></blockquote> <p><strong>è§£å†³æ–¹æ³•</strong></p> <ul><li><p>FeignLogConfiguration åœ¨ Open Feign è¿œç¨‹è°ƒç”¨å¯¹æ–¹è¯·æ±‚è·å–æ•°æ®æ—¶</p> <p>è‡ªåŠ¨è·å– token å¹¶æ”¾å…¥è¯·æ±‚å¤´åœ¨è°ƒç”¨å¯¹æ–¹çš„å¾®æœåŠ¡è¯·æ±‚  å¯æ”¾å…¥securityé…ç½®åŒ…å†…</p></li> <li><p>åœ¨  Open Feign  çš„è¯·æ±‚æ¥å£å¸¦ä¸Š token  åœ¨è°ƒç”¨æ¥å£æ—¶æ‰‹åŠ¨è·å–tokenåœ¨ä¼ å…¥æ¥å£</p> <p>åœ¨è°ƒç”¨å¯¹æ–¹çš„å¾®æœåŠ¡è¯·æ±‚æ—¶å› ä¸ºtokenæ”¾è¡Œè€ŒæˆåŠŸè°ƒç”¨ | @RequestHeader(&quot;token&quot;) String token</p></li> <li><p>è¯·æ±‚å¤´æ²¡æœ‰tokenåˆ™æŠ¥é”™ ç©ºæŒ‡é’ˆå¼‚å¸¸ null</p></li></ul> <p><strong>FeignLogConfiguration ç±»</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>woniu<span class="token punctuation">.</span>config<span class="token punctuation">.</span>security</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestInterceptor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">feign<span class="token punctuation">.</span></span><span class="token class-name">RequestTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">RequestContextHolder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>context<span class="token punctuation">.</span>request<span class="token punctuation">.</span></span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignLogConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">RequestInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">RequestTemplate</span> requestTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//æ·»åŠ token</span>
        requestTemplate<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="restful-é£æ ¼è¯·æ±‚"><a href="#restful-é£æ ¼è¯·æ±‚" class="header-anchor">#</a> Restful é£æ ¼è¯·æ±‚</h3> <blockquote><p>æ³¨è§£: @PathVariable(&quot;å ä½å&quot;)</p> <p>åœ¨ Open Feign è¿œç¨‹è°ƒç”¨çš„Clientæ¥å£é‡Œ æŒ‰è§„èŒƒåœ¨æ³¨è§£é‡Œå†™å…¥ å ä½å‚æ•°å</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// GETï¼šç”¨äºè·å–èµ„æº </span>
<span class="token comment">// POSTï¼šç”¨äºæ–°å»ºèµ„æº	</span>
<span class="token comment">// PUTï¼šç”¨äºæ›´æ–°èµ„æº</span>
<span class="token comment">// DELETEï¼šç”¨äºåˆ é™¤èµ„æº</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test1/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test5/{id}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test5</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="get-è¯·æ±‚-2"><a href="#get-è¯·æ±‚-2" class="header-anchor">#</a> Get è¯·æ±‚</h3> <blockquote><p>å•ä¸ªå‚æ•°æ³¨è§£: @RequestParam(&quot;å ä½å&quot;)</p> <p>å¯¹è±¡ç±»å‹æ³¨è§£: @SpringQueryMap å¯¹è±¡ç±»å‹ å¯¹è±¡å</p> <p>å½“å‚æ•°ä¸º: Map é›†åˆæ—¶ å¯ä½¿ç”¨ä¸Šæ–¹ä¸¤ä¸ªæ³¨è§£éƒ½å¯ä½¿ç”¨</p> <p>è·å–è¯·æ±‚å¤´tokenæ³¨è§£: @RequestHeader(&quot;token&quot;)</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test2&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test3&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test3</span><span class="token punctuation">(</span><span class="token annotation punctuation">@SpringQueryMap</span> <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test4&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test4</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span>  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h3 id="post-è¯·æ±‚-2"><a href="#post-è¯·æ±‚-2" class="header-anchor">#</a> Post è¯·æ±‚</h3> <blockquote><p>å•ä¸ªå‚æ•°æ³¨è§£: @RequestParam(&quot;å ä½å&quot;)</p> <p>å¯¹è±¡ç±»å‹æ³¨è§£: @RequestBody å¯¹è±¡ç±»å‹ å¯¹è±¡å  |  {åº”ç”¨äº æµè§ˆå™¨ä¼ é€’çš„ç±»å‹ä¸º json}</p> <p>å½“å‚æ•°ä¸º: Map é›†åˆæ—¶ å¯ä½¿ç”¨ä¸Šæ–¹ä¸¤ä¸ªæ³¨è§£éƒ½å¯ä½¿ç”¨</p> <p>è·å–è¯·æ±‚å¤´tokenæ³¨è§£: @RequestHeader(&quot;token&quot;)</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test6&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test6</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id <span class="token punctuation">,</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test7&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test7</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span>  <span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test8&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test8</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="open-feign-å†…ç½®-hystrix-ç†”æ–­"><a href="#open-feign-å†…ç½®-hystrix-ç†”æ–­" class="header-anchor">#</a> Open Feign å†…ç½® Hystrix ç†”æ–­</h2> <p>é»˜è®¤æƒ…å†µä¸‹æ˜¯å…³é—­çš„ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸‹é¢çš„å‚æ•°æ¥å¼€å¯ï¼š(åœ¨woniu-service-consumerå·¥ç¨‹æ·»åŠ é…ç½®å†…å®¹)</p> <h3 id="open-feign-ç†”æ–­"><a href="#open-feign-ç†”æ–­" class="header-anchor">#</a> Open Feign ç†”æ–­</h3> <p>åªéœ€è¦å¼€å¯hystrixçš„ç†”æ–­åŠŸèƒ½å³å¯ï¼Œé»˜è®¤æ—¶é—´æ˜¯1sä¸­ï¼Œå¦‚æœè¦ä¿®æ”¹ç†”æ–­çš„æ—¶é—´ï¼Œè¦åšå¦‚ä¸‹çš„é…ç½®:</p> <p>ç†”æ–­çš„æ—¶é—´ä¸ä¼šäº§ç”Ÿå†²çª ä»¥æœ€çŸ­çš„æ—¶é—´ä¸ºä¸»</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
    <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
        <span class="token comment">## å¼€å¯ Feign çš„ç†”æ–­åŠŸèƒ½</span>
        <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">client</span><span class="token punctuation">:</span>
        <span class="token key atrule">config</span><span class="token punctuation">:</span>
            <span class="token comment">## æ³¨æ„: feignç†”æ–­ å¿…é¡»è·Ÿ hystrixç†”æ–­ä¸€èµ·ä½¿ç”¨æ‰æœ‰æ•ˆ</span>
            <span class="token key atrule">default</span><span class="token punctuation">:</span>
                <span class="token comment">#è®¾ç½®feignè¶…æ—¶è¿æ¥æ—¶é•¿</span>
                <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">4000</span>
                <span class="token comment">#è®¾ç½®feignè¯·æ±‚çš„è¶…æ—¶æ—¶é•¿  4sä¹‹å æä¾›æ–¹æ²¡æœ‰å“åº” ç›´æ¥é™çº§</span>
                <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">4000</span>
                
<span class="token comment">## Hystrix ç†”æ–­é…ç½®                </span>
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token key atrule">default</span><span class="token punctuation">:</span>
            <span class="token key atrule">execution</span><span class="token punctuation">:</span>
                <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
                    <span class="token key atrule">thread</span><span class="token punctuation">:</span>
                        <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">6000</span>
                    <span class="token key atrule">strategy</span><span class="token punctuation">:</span> THREAD
                <span class="token key atrule">timeout</span><span class="token punctuation">:</span>
                    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><blockquote><p>è¯´æ˜ï¼šconnectTimeoutæ˜¯feignè¿æ¥æŸä¸ªæœåŠ¡çš„è¶…æ—¶æ—¶é—´ï¼ŒreadTimeoutæ˜¯feignè¯·æ±‚æŸä¸ªæ¥å£çš„è¶…æ—¶æ—¶é•¿ï¼ŒtimeoutInMillisecondsæ˜¯hystrixç†”æ–­çš„æ—¶é—´ï¼ŒHystrixçš„è¶…æ—¶æ—¶é—´æ˜¯ç«™åœ¨å‘½ä»¤æ‰§è¡Œæ—¶é—´æ¥çœ‹çš„ï¼Œå’ŒFeignè®¾ç½®çš„è¶…æ—¶æ—¶é—´åœ¨è®¾ç½®ä¸Šå¹¶æ²¡æœ‰å…³è”å…³ç³»ã€‚Hystrixä¸ä»…ä»…å¯ä»¥å°è£…Httpè°ƒç”¨ï¼Œè¿˜å¯ä»¥å°è£…ä»»æ„çš„ä»£ç æ‰§è¡Œç‰‡æ®µã€‚Hystrixæ˜¯ä»å‘½ä»¤å¯¹è±¡çš„è§’åº¦å»å®šä¹‰ï¼ŒæŸä¸ªå‘½ä»¤æ‰§è¡Œçš„è¶…æ—¶æ—¶é—´ï¼Œè¶…è¿‡æ­¤æ­¤æ—¶é—´ï¼Œå‘½ä»¤å°†ä¼šç›´æ¥ç†”æ–­ï¼Œå‡è®¾hystrix çš„é»˜è®¤è¶…æ—¶æ—¶é—´è®¾ç½®äº†3000,å³3ç§’ï¼Œè€Œfeign è®¾ç½®çš„æ˜¯4ç§’ï¼Œé‚£ä¹ˆHystrixä¼šåœ¨3ç§’åˆ°æ¥æ—¶ç›´æ¥ç†”æ–­è¿”å›ï¼Œä¸ä¼šç­‰åˆ°feignçš„4ç§’æ‰§è¡Œç»“æŸï¼Œå¦‚æœhystrixçš„è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º6sï¼Œè€Œfeign è®¾ç½®çš„æ˜¯4ç§’ï¼Œé‚£ä¹ˆæœ€ç»ˆè¦ä»¥feignçš„æ—¶é—´4sä¸ºå‡†ï¼Œä½ å¯ä»¥ç†è§£ä¸ºä»¥æ—¶é—´çŸ­çš„ä¸ºå‡†ï¼Œè¿™ä¸¤æ®µéƒ½è¦é…ç½®ï¼Œä¸èƒ½ä¸é…hystrixçš„é…ç½®ï¼Œå¦åˆ™feigné…ç½®çš„readTimeoutä¸ç”Ÿæ•ˆ</p> <p>openfeigné›†æˆäº†hystrixç»„ä»¶ï¼Œä¸å†éœ€è¦å¼•å…¥hystrixç»„ä»¶ï¼Œåœ¨å¯åŠ¨ç±»ä¸Šä¸è¦å»æ·»åŠ ç†”æ–­æ³¨è§£</p></blockquote> <h3 id="open-feign-ç†”æ–­é™çº§"><a href="#open-feign-ç†”æ–­é™çº§" class="header-anchor">#</a> Open Feign ç†”æ–­é™çº§</h3> <p>å®šä¹‰ç±» å®ç° Open Feignè¿œç¨‹è°ƒç”¨Clientæ¥å£ ä½œä¸ºfallbackçš„é™çº§å¤„ç†ç±»</p> <blockquote><p>å®ç°æ¥å£ä¹‹å å¿…é¡»é‡å†™æ¥å£çš„ä½¿ç”¨çš„æ–¹æ³• ç„¶åå†™å…¥é™çº§ä¹‹åçš„å†…å®¹</p> <p>å®ç°æ¥å£ä¹‹å ä¼šå’ŒClientæ¥å£ é…ç½®çš„beanäº§ç”Ÿå†²çª</p></blockquote> <p><strong>è§£å†³å†²çª:</strong></p> <ul><li>Clientæ¥å£çš„ @FeignClient(value = &quot;æœåŠ¡å&quot;, qualifier = &quot;beanå&quot;ï¼Œfallback = é™çº§å¤„ç†ç±»å.class)</li> <li>è°ƒç”¨æ–¹çš„è¡¨ç°å±‚ åœ¨æ³¨å…¥Clientæ¥å£æ—¶æŒ‡å®šbeanå @Qualifier(&quot;beanå&quot;)</li></ul> <p><strong>Clientæ¥å£</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span></span><span class="token class-name">Client</span><span class="token punctuation">;</span>

<span class="token comment">// æ ‡æ³¨è¯¥ç±»æ˜¯ä¸€ä¸ªfeignæ¥å£ ä¸”é“¾æ¥åˆ°æœåŠ¡æ–¹  é‡å‘½åbeançš„åç§°  æŒ‡å®šé™çº§å¤„ç†ç±»</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;Moduletow&quot;</span><span class="token punctuation">,</span> qualifier <span class="token operator">=</span> <span class="token string">&quot;FinancingClient1&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">FinancingClientImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FinancingClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/financing/testopenfeign/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testopenfeign</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre></div><p><strong>é™çº§å¤„ç†ç±»</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span></span><span class="token class-name">Client</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinancingClientImpl</span> <span class="token keyword">implements</span> <span class="token class-name">FinancingClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testopenfeign</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;é™çº§æç¤º&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>è¡¨ç°å±‚ è°ƒç”¨</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FinancingController</span> <span class="token punctuation">{</span>

    <span class="token comment">// è·å–ClientæœåŠ¡æ¥å£</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;FinancingClient1&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">FinancingClient</span> financingClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/three&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testopenfeign</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è°ƒç”¨æ¥å£ å¹¶ä¼ å‚</span>
        <span class="token class-name">String</span> testopenfeign <span class="token operator">=</span> financingClient<span class="token punctuation">.</span><span class="token function">testopenfeign</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> testopenfeign<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="è¶…æ—¶å’Œè¶…æ—¶é‡è¯•"><a href="#è¶…æ—¶å’Œè¶…æ—¶é‡è¯•" class="header-anchor">#</a> è¶…æ—¶å’Œè¶…æ—¶é‡è¯•</h3> <p>OpenFeign æœ¬èº«ä¹Ÿå…·å¤‡é‡è¯•èƒ½åŠ›ï¼Œåœ¨æ—©æœŸçš„ Spring Cloud ä¸­ï¼ŒOpenFeign ä½¿ç”¨çš„æ˜¯ feign.Retryer.Default#Default() ï¼Œé‡è¯• 5 æ¬¡ã€‚ä½† OpenFeign é›†æˆäº†Ribbonä¾èµ–å’Œè‡ªåŠ¨é…ç½®ï¼ˆé»˜è®¤ä¹Ÿæ˜¯è½®è¯¢ï¼‰ï¼ŒRibbon ä¹Ÿæœ‰é‡è¯•çš„èƒ½åŠ›ï¼Œæ­¤æ—¶ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´è¡Œä¸ºçš„æ··ä¹±ã€‚ï¼ˆæ€»é‡è¯•æ¬¡æ•° = OpenFeign é‡è¯•æ¬¡æ•° x Ribbon çš„é‡è¯•æ¬¡æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªç¬›å¡å°”ç§¯ã€‚ï¼‰</p> <p>åæ¥ Spring Cloud æ„è¯†åˆ°äº†æ­¤é—®é¢˜ï¼Œå› æ­¤åšäº†æ”¹è¿›ï¼ˆ<a href="https://github.com/spring-cloud/spring-cloud-netflix/issues/467" target="_blank" rel="noopener noreferrer">issues 467</a>ï¼‰ï¼Œå°† OpenFeign çš„é‡è¯•æ”¹ä¸º feign.Retryer#NEVER_RETRY ï¼Œå³é»˜è®¤å…³é—­ã€‚ Ribbonçš„é‡è¯•æœºåˆ¶é»˜è®¤é…ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤æ˜¯å»é™¤é‡è¯•æœºåˆ¶çš„ï¼Œå¦‚æœä¸¤è€…éƒ½å¼€å¯é‡è¯•ï¼Œå…ˆæ‰§è¡Œribboné‡è¯•ï¼ŒæŠ›å‡ºå¼‚å¸¸ä¹‹åå†æ‰§è¡Œfeignçš„é‡è¯•</p> <p>æ‰€ä»¥ï¼ŒOpenFeignã€å¯¹å¤–ã€è¡¨ç°å‡ºçš„è¶…æ—¶å’Œé‡è¯•çš„è¡Œä¸ºï¼Œå®é™…ä¸Šæ˜¯ Ribbon çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•è¡Œä¸ºã€‚æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­è¿›è¡Œçš„é…ç½®ï¼Œ<strong>ä¹Ÿéƒ½æ˜¯é…ç½® Ribbon çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•</strong></p> <p><strong>åœ¨è°ƒç”¨æ–¹é…ç½®å¦‚ä¸‹</strong></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">## å…¨å±€é…ç½®</span>
<span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token comment">## è¯·æ±‚è¿æ¥çš„è¶…æ—¶æ—¶é—´</span>
  <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
  <span class="token comment">## è¯·æ±‚å¤„ç†çš„è¶…æ—¶æ—¶é—´</span>
  <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>   <span class="token comment">#1ç§’</span>
  <span class="token comment">## æœ€å¤§é‡è¯•æ¬¡æ•°</span>
  <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token comment">## åˆ‡æ¢å®ä¾‹çš„é‡è¯•æ¬¡æ•°</span>
  <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token comment">#NFLoadBalancerRuleClassName: RandomRule</span>
  <span class="token comment">## å¯¹æ‰€æœ‰è¯·æ±‚å¼€å¯é‡è¯•ï¼Œå¹¶éåªæœ‰get è¯·æ±‚æ‰å……å®ã€‚ä¸€èˆ¬ä¸ä¼šå¼€å¯è¿™ä¸ªåŠŸèƒ½ã€‚è¯¥å‚æ•°å’Œä¸Šé¢çš„3ä¸‰ä¸ªå‚æ•°æ²¡æœ‰å…³ç³»</span>
  <span class="token comment">#okToRetryOnAllOperations: true</span>
<span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>     <span class="token comment">#é»˜è®¤æ˜¯1sé™çº§</span>
  <span class="token comment">#client:         </span>
    <span class="token comment">#config:</span>
     <span class="token comment">## default:</span>
       <span class="token comment">## connectTimeout: 4000  #è¦å…³æ‰feignè¶…æ—¶è¿æ¥æ—¶é•¿</span>
        <span class="token comment">#readTimeout: 150000</span>
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">150000</span>   <span class="token comment">#è¿™ä¸ªæ—¶é—´è¦å¤§äºribboné‡è¯•æ¬¡æ•°çš„æ€»æ—¶é•¿ï¼Œå¦åˆ™è¿˜æ²¡é‡è¯•å®Œå°±é™çº§äº†</span>
</code></pre></div><p>è¢«è°ƒç”¨æ–¹è®¾ç½®çº¿ç¨‹ç¡çœ </p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token operator">+</span><span class="token string">&quot;ç«¯å£&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> str<span class="token operator">+</span><span class="token string">&quot;ç«¯å£&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>æµ‹è¯•ç»“æœï¼šç”±äºopenfeigné‡è¯•é»˜è®¤æ˜¯å…³é—­çš„ï¼Œæˆ‘ä»¬ä¸ç”¨ç®¡å®ƒã€‚è¢«è°ƒç”¨æ–¹ï¼Œå¦‚æœåªå¯åŠ¨ä¸€ä¸ªè¢«è°ƒæ–¹å®ä¾‹ï¼Œåˆ™ä¸€å…±12æ¬¡ï¼Œå› ä¸º MaxAutoRetriesNextServer: 1 åˆ‡æ¢ä¸‹ä¸€ä¸ªå®ä¾‹å†é‡è¯•ï¼Œä¸‹ä¸€ä¸ªå®ä¾‹è¿˜æ˜¯è‡ªå·±ï¼Œå¦‚æœè¢«è°ƒæ–¹å¯åŠ¨ä¸¤ä¸ªå®ä¾‹ï¼Œåˆ™å„6æ¬¡ã€‚å¦å¤–é‡è¯•å’Œç†”æ–­éƒ½å¼€å¯ï¼Œè¶…æ—¶æ—¶é—´æ˜¯1sï¼Œä¸€å…±æ˜¯12æ¬¡ï¼Œä¹Ÿå°±æ˜¯12sï¼Œ12sä¹‹åå°±ä¼šé™çº§ï¼Œè€Œhystrixé…ç½®çš„timeoutInMillisecondsçš„15sé™çº§ï¼Œåœ¨è¿™é‡Œæ˜¯ä»¥æ—¶é—´çŸ­çš„ä¸ºä¸»ã€‚å¦‚æœä¸å¯¹timeoutInMillisecondsè¿›è¡Œé…ç½®ï¼Œé‚£ä¹ˆhystrixé»˜è®¤æ˜¯1sï¼Œä¹Ÿå°±æ˜¯1sé’Ÿä¹‹åå°±ä¼šé™çº§ï¼Œä½†æ˜¯ä¸å½±å“ribbonçš„é‡è¯•ã€‚</p></blockquote> <p><strong>ä½ ä¹Ÿå¯ä»¥æŒ‡å®šå¯¹æŸä¸ªç‰¹å®šæœåŠ¡çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•ï¼š</strong></p> <p>åˆ™å…¶ä»–çš„è¯·æ±‚èµ°ä¸Šé¢çš„é‡è¯•ï¼ŒSERVICE-PRODUCERè¯¥æœåŠ¡çš„é‡è¯•å•ç‹¬é…ç½®</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment">## é’ˆå¯¹ spring-service-b çš„è®¾ç½®ï¼Œæ³¨æ„æœåŠ¡åçš„å¤§å°å†™</span>
<span class="token key atrule">spring-service-b</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">connectTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>   
    <span class="token key atrule">MaxAutoRetries</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">MaxAutoRetriesNextServer</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre></div><p>åœ¨è¢«è°ƒæ–¹ï¼Œä¿®æ”¹å¦‚ä¸‹ä»£ç æµ‹è¯•</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/hello&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>str<span class="token operator">+</span><span class="token string">&quot;ç«¯å£&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> str<span class="token operator">+</span><span class="token string">&quot;ç«¯å£&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="å¦‚ä½•æ›¿æ¢åº•å±‚ç”¨httpå®ç°"><a href="#å¦‚ä½•æ›¿æ¢åº•å±‚ç”¨httpå®ç°" class="header-anchor">#</a> å¦‚ä½•æ›¿æ¢åº•å±‚ç”¨HTTPå®ç°</h3> <p>æœ¬è´¨ä¸Šæ˜¯ OpenFeign æ‰€ä½¿ç”¨çš„ RestTemplate æ›¿æ¢åº•å±‚ HTTP å®ç°</p> <ul><li>æ›¿æ¢æˆ HTTPClient</li></ul> <p>å°† OpenFeign çš„åº•å±‚ HTTP å®¢æˆ·ç«¯æ›¿æ¢æˆ HTTPClient éœ€è¦ 2 æ­¥:</p> <p>1ã€å¼•å…¥ä¾èµ–ï¼š</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.github.openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>feign-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>2ã€åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨å®ƒï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">## æ¿€æ´» httpclient çš„ä½¿ç”¨</span>
</code></pre></div><ul><li>æ›¿æ¢æˆ OkHttp</li></ul> <p>å°† OpenFeign çš„åº•å±‚ HTTP å®¢æˆ·ç«¯æ›¿æ¢æˆ OkHttp éœ€è¦ 2 æ­¥:</p> <p>1ã€å¼•å…¥ä¾èµ–</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code>&lt;dependency<span class="token punctuation">&gt;</span>
  &lt;groupId<span class="token punctuation">&gt;</span>io.github.openfeign&lt;/groupId<span class="token punctuation">&gt;</span>
  &lt;artifactId<span class="token punctuation">&gt;</span>feign<span class="token punctuation">-</span>okhttp&lt;/artifactId<span class="token punctuation">&gt;</span>
&lt;/dependency<span class="token punctuation">&gt;</span>
</code></pre></div><p>2ã€é…ç½®</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment">## å…³é—­ httpclient çš„ä½¿ç”¨</span>
  <span class="token key atrule">okhttp</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment">## æ¿€æ´» okhttp çš„ä½¿ç”¨</span>
</code></pre></div><h3 id="æ—¥å¿—çº§åˆ«-äº†è§£"><a href="#æ—¥å¿—çº§åˆ«-äº†è§£" class="header-anchor">#</a> æ—¥å¿—çº§åˆ«(äº†è§£)</h3> <div class="language-java extra-class"><pre class="language-java"><code>å‰é¢è®²è¿‡ï¼Œé€šè¿‡`logging<span class="token punctuation">.</span>level<span class="token punctuation">.</span>xx<span class="token operator">=</span>debug`æ¥è®¾ç½®æ—¥å¿—çº§åˆ«ã€‚ç„¶è€Œè¿™ä¸ªå¯¹<span class="token class-name">Fegin</span>å®¢æˆ·ç«¯è€Œè¨€ä¸ä¼šäº§ç”Ÿæ•ˆæœã€‚å› ä¸º`<span class="token annotation punctuation">@FeignClient</span>`æ³¨è§£ä¿®æ”¹çš„å®¢æˆ·ç«¯åœ¨è¢«ä»£ç†æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<span class="token class-name">Fegin<span class="token punctuation">.</span>Logger</span>å®ä¾‹ã€‚æˆ‘ä»¬éœ€è¦é¢å¤–æŒ‡å®šè¿™ä¸ªæ—¥å¿—çš„çº§åˆ«æ‰å¯ä»¥ã€‚ç„¶åæ ¹æ® <span class="token operator">*</span><span class="token operator">*</span>logging<span class="token punctuation">.</span>level<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FeignClient</span><span class="token punctuation">&gt;</span></span><span class="token operator">*</span><span class="token operator">*</span> å‚æ•°é…ç½®æ ¼å¼æ¥å¼€å¯ <span class="token class-name">Feign</span> å®¢æˆ·ç«¯çš„ DEBUG æ—¥å¿—ï¼Œå…¶ä¸­ <span class="token operator">*</span><span class="token operator">*</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FeignClient</span><span class="token punctuation">&gt;</span></span><span class="token operator">*</span><span class="token operator">*</span> éƒ¨åˆ†ä¸º <span class="token class-name">Feign</span> å®¢æˆ·ç«¯å®šä¹‰æ¥å£çš„å®Œæ•´è·¯å¾„ã€‚é»˜è®¤å€¼æ˜¯<span class="token operator">*</span><span class="token operator">*</span>NONE<span class="token operator">*</span><span class="token operator">*</span>ï¼Œè€ŒNONEä¸ä¼šè®°å½•<span class="token class-name">Feign</span><span class="token operator">*</span><span class="token operator">*</span>è°ƒç”¨è¿‡ç¨‹<span class="token operator">*</span><span class="token operator">*</span>çš„ä»»ä½•æ—¥å¿—çš„ï¼Œ<span class="token operator">*</span><span class="token operator">*</span>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ—¥å¿—ä¸æ˜¯å¯åŠ¨feignå®¢æˆ·ç«¯çš„æ—¥å¿—ï¼Œè€Œæ˜¯feignè°ƒç”¨è¿œç¨‹æ¥å£æ—¶äº§ç”Ÿçš„æ—¥å¿—<span class="token operator">*</span><span class="token operator">*</span>ã€‚
</code></pre></div><p>1ï¼‰è®¾ç½®com.woniuåŒ…ä¸‹çš„æ—¥å¿—çº§åˆ«éƒ½ä¸ºdebug</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">level</span><span class="token punctuation">:</span>
    <span class="token key atrule">com</span><span class="token punctuation">:</span>
      <span class="token key atrule">woniu</span><span class="token punctuation">:</span>
        <span class="token key atrule">client</span><span class="token punctuation">:</span>
          <span class="token key atrule">UserFeignClient</span><span class="token punctuation">:</span> debug   <span class="token comment">#UserFeignClientä¸ºæŸä¸ªfeignæ¥å£</span>
</code></pre></div><p>2ï¼‰ç¼–å†™é…ç½®ç±»ï¼Œå®šä¹‰æ—¥å¿—çº§åˆ«</p> <p>å†…å®¹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignLogConfiguration</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span>FULL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¿™é‡ŒæŒ‡å®šçš„Levelçº§åˆ«æ˜¯FULLï¼ŒFeignæ”¯æŒ4ç§çº§åˆ«ï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1528863525224.png" alt="1528863525224"></p> <ul><li>NONEï¼šä¸è®°å½•ä»»ä½•æ—¥å¿—ä¿¡æ¯ï¼Œè¿™æ˜¯é»˜è®¤å€¼ã€‚</li> <li>BASICï¼šä»…è®°å½•è¯·æ±‚çš„æ–¹æ³•ï¼ŒURLä»¥åŠå“åº”çŠ¶æ€ç å’Œæ‰§è¡Œæ—¶é—´</li> <li>HEADERSï¼šåœ¨BASICçš„åŸºç¡€ä¸Šï¼Œé¢å¤–è®°å½•äº†è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯</li> <li>FULLï¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„æ˜ç»†ï¼ŒåŒ…æ‹¬å¤´ä¿¡æ¯ã€è¯·æ±‚ä½“ã€å…ƒæ•°æ®ã€‚</li></ul> <p>3ï¼‰åœ¨FeignClientä¸­æŒ‡å®šé…ç½®ç±»ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;service-privider&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">UserFeignClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">FeignConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserFeignClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/{id}&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">User</span> <span class="token function">queryUserById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>4ï¼‰é‡å¯é¡¹ç›®ï¼Œè¿›è¡Œæµ‹è¯•ï¼šåœ¨é€šè¿‡openfeignå»è°ƒç”¨æŸä¸ªæ¥å£æ—¶ï¼Œä¼šæœ‰è¯¦ç»†çš„ä¿¡æ¯ã€‚å¦‚æœæŠŠæ—¥å¿—çº§åˆ«è®¾ç½®ä¸ºNONEï¼Œåˆ™æ²¡æœ‰ã€‚</p> <p>æµ‹è¯•ï¼šhttp://localhost:9527/port1</p> <h2 id="zuul-ç½‘å…³ç»„ä»¶"><a href="#zuul-ç½‘å…³ç»„ä»¶" class="header-anchor">#</a> Zuul ç½‘å…³ç»„ä»¶</h2> <p><strong>å®ƒæ˜¯ä¸€ä¸ªè·¯ç”±ç½‘å…³ç»„ä»¶</strong>ï¼Œé€šè¿‡å‰é¢çš„å­¦ä¹ ï¼Œä½¿ç”¨Spring Cloudå®ç°å¾®æœåŠ¡çš„æ¶æ„åŸºæœ¬æˆå‹ï¼Œå¤§è‡´æ˜¯è¿™æ ·çš„ï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1525674644660.png" alt="1525674644660"></p> <div class="language- extra-class"><pre><code>æˆ‘ä»¬ä½¿ç”¨Spring Cloud Netflixä¸­çš„Eurekaå®ç°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒä»¥åŠæœåŠ¡æ³¨å†Œä¸å‘ç°ï¼›è€ŒæœåŠ¡é—´é€šè¿‡Ribbonæˆ–Feignå®ç°æœåŠ¡çš„æ¶ˆè´¹ä»¥åŠå‡è¡¡è´Ÿè½½ã€‚ä¸ºäº†ä½¿å¾—æœåŠ¡é›†ç¾¤æ›´ä¸ºå¥å£®ï¼Œä½¿ç”¨Hystrixçš„ç†”æ–­æœºåˆ¶æ¥é¿å…åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ä¸ªåˆ«æœåŠ¡å‡ºç°å¼‚å¸¸æ—¶å¼•èµ·çš„æ•…éšœè”“å»¶ã€‚

åœ¨è¯¥æ¶æ„ä¸­ï¼Œæˆ‘ä»¬çš„æœåŠ¡é›†ç¾¤åŒ…å«ï¼šå†…éƒ¨æœåŠ¡Service Aå’ŒService Bï¼Œä»–ä»¬éƒ½ä¼šæ³¨å†Œä¸è®¢é˜…æœåŠ¡è‡³Eureka Serverï¼Œè€ŒOpen Serviceæ˜¯ä¸€ä¸ªå¯¹å¤–çš„æœåŠ¡ï¼Œé€šè¿‡å‡è¡¡è´Ÿè½½å…¬å¼€è‡³æœåŠ¡è°ƒç”¨æ–¹ã€‚æˆ‘ä»¬æŠŠç„¦ç‚¹èšé›†åœ¨å¯¹å¤–æœåŠ¡è¿™å—ï¼Œç›´æ¥æš´éœ²æˆ‘ä»¬çš„æœåŠ¡åœ°å€ï¼Œè¿™æ ·çš„å®ç°æ˜¯å¦åˆç†ï¼Œæˆ–è€…æ˜¯å¦æœ‰æ›´å¥½çš„å®ç°æ–¹å¼å‘¢ï¼Ÿ
</code></pre></div><p>å…ˆæ¥è¯´è¯´è¿™æ ·æ¶æ„éœ€è¦åšçš„ä¸€äº›äº‹å„¿ä»¥åŠå­˜åœ¨çš„ä¸è¶³ï¼š</p> <ul><li><p>ç ´åäº†æœåŠ¡æ— çŠ¶æ€ç‰¹ç‚¹ã€‚</p> <p>ä¸ºäº†ä¿è¯å¯¹å¤–æœåŠ¡çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬éœ€è¦å®ç°å¯¹æœåŠ¡è®¿é—®çš„æƒé™æ§åˆ¶ï¼Œè€Œå¼€æ”¾æœåŠ¡çš„æƒé™æ§åˆ¶æœºåˆ¶å°†ä¼šè´¯ç©¿å¹¶æ±¡æŸ“æ•´ä¸ªå¼€æ”¾æœåŠ¡çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¿™ä¼šå¸¦æ¥çš„æœ€ç›´æ¥é—®é¢˜æ˜¯ï¼Œç ´åäº†æœåŠ¡é›†ç¾¤ä¸­REST APIæ— çŠ¶æ€çš„ç‰¹ç‚¹ã€‚å…·ä½“å¼€å‘å’Œæµ‹è¯•çš„è§’åº¦æ¥è¯´ï¼Œåœ¨å·¥ä½œä¸­é™¤äº†è¦è€ƒè™‘å®é™…çš„ä¸šåŠ¡é€»è¾‘ä¹‹å¤–ï¼Œè¿˜éœ€è¦é¢å¤–è€ƒè™‘å¯¹æ¥å£è®¿é—®çš„æ§åˆ¶å¤„ç†ã€‚</p></li> <li><p>æ— æ³•ç›´æ¥å¤ç”¨æ—¢æœ‰æ¥å£ã€‚</p> <p>å½“æˆ‘ä»¬éœ€è¦å¯¹ä¸€ä¸ªå³æœ‰çš„é›†ç¾¤å†…è®¿é—®æ¥å£ï¼Œå®ç°å¤–éƒ¨æœåŠ¡è®¿é—®æ—¶ï¼Œæˆ‘ä»¬ä¸å¾—ä¸é€šè¿‡åœ¨åŸæœ‰æ¥å£ä¸Šå¢åŠ æ ¡éªŒé€»è¾‘ï¼Œæˆ–å¢åŠ ä¸€ä¸ªä»£ç†è°ƒç”¨æ¥å®ç°æƒé™æ§åˆ¶ï¼Œæ— æ³•ç›´æ¥å¤ç”¨åŸæœ‰çš„æ¥å£ã€‚</p></li></ul> <p>ä¸ºäº†è§£å†³ä¸Šé¢è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°†æƒé™æ§åˆ¶è¿™æ ·çš„ä¸œè¥¿ä»æˆ‘ä»¬çš„æœåŠ¡å•å…ƒä¸­æŠ½ç¦»å‡ºå»ï¼Œè€Œæœ€é€‚åˆè¿™äº›é€»è¾‘çš„åœ°æ–¹å°±æ˜¯å¤„äºå¯¹å¤–è®¿é—®æœ€å‰ç«¯çš„åœ°æ–¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ›´å¼ºå¤§ä¸€äº›çš„å‡è¡¡è´Ÿè½½å™¨çš„ æœåŠ¡ç½‘å…³ã€‚</p> <p>æœåŠ¡ç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­ä¸€ä¸ªä¸å¯æˆ–ç¼ºçš„éƒ¨åˆ†ã€‚é€šè¿‡æœåŠ¡ç½‘å…³ç»Ÿä¸€å‘å¤–ç³»ç»Ÿæä¾›REST APIçš„è¿‡ç¨‹ä¸­ï¼Œé™¤äº†å…·å¤‡<code>æœåŠ¡è·¯ç”±</code>ã€<code>å‡è¡¡è´Ÿè½½</code>åŠŸèƒ½ä¹‹å¤–ï¼Œå®ƒè¿˜å…·å¤‡äº†<code>æƒé™æ§åˆ¶</code>ç­‰åŠŸèƒ½ã€‚Spring Cloud Netflixä¸­çš„Zuulå°±æ‹…ä»»äº†è¿™æ ·çš„ä¸€ä¸ªè§’è‰²ï¼Œä¸ºå¾®æœåŠ¡æ¶æ„æä¾›äº†å‰é—¨ä¿æŠ¤çš„ä½œç”¨ï¼ŒåŒæ—¶å°†æƒé™æ§åˆ¶è¿™äº›è¾ƒé‡çš„éä¸šåŠ¡é€»è¾‘å†…å®¹è¿ç§»åˆ°æœåŠ¡è·¯ç”±å±‚é¢ï¼Œä½¿å¾—æœåŠ¡é›†ç¾¤ä¸»ä½“èƒ½å¤Ÿå…·å¤‡æ›´é«˜çš„å¯å¤ç”¨æ€§å’Œå¯æµ‹è¯•æ€§ã€‚</p> <h3 id="zuul-ç½‘å…³ç»„ä»¶-ç®€ä»‹"><a href="#zuul-ç½‘å…³ç»„ä»¶-ç®€ä»‹" class="header-anchor">#</a> Zuul ç½‘å…³ç»„ä»¶ ç®€ä»‹</h3> <p>å®˜ç½‘ï¼šhttps://github.com/Netflix/zuul</p> <p>äº‹å®ä¸Šï¼Œåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒZuulå°±æ˜¯è·¯ç”± è¿›è¡Œè½¬å‘</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1525675168152.png" alt="1525675168152"></p> <h3 id="zuul-æ¶æ„"><a href="#zuul-æ¶æ„" class="header-anchor">#</a> Zuul æ¶æ„</h3> <blockquote><p>ä¸ç®¡æ˜¯æ¥è‡ªäºå®¢æˆ·ç«¯ï¼ˆPCæˆ–ç§»åŠ¨ç«¯ï¼‰çš„è¯·æ±‚ï¼Œè¿˜æ˜¯æœåŠ¡å†…éƒ¨è°ƒç”¨ã€‚ä¸€åˆ‡å¯¹æœåŠ¡çš„è¯·æ±‚éƒ½ä¼šç»è¿‡Zuulè¿™ä¸ªç½‘å…³ï¼Œç„¶åå†ç”±ç½‘å…³æ¥å®ç° é‰´æƒã€åŠ¨æ€è·¯ç”±ç­‰ç­‰æ“ä½œã€‚Zuulå°±æ˜¯æˆ‘ä»¬æœåŠ¡çš„ç»Ÿä¸€å…¥å£ã€‚</p></blockquote> <h4 id="pom-æ–‡ä»¶å¯¼å…¥"><a href="#pom-æ–‡ä»¶å¯¼å…¥" class="header-anchor">#</a> <strong>pom  æ–‡ä»¶å¯¼å…¥</strong></h4> <p>Zuul ç½‘å…³ç»„ä»¶ ä¾èµ– ä¸º Zuul [Maintenance] ä¸è¦å¯¼é”™alibb</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Web--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Zuul ç½‘å…³ç»„ä»¶ --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-zuul<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--EurekaServer-è‡ªåŠ¨æ³¨å†Œ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="ç¼–å†™-é…ç½®"><a href="#ç¼–å†™-é…ç½®" class="header-anchor">#</a> <strong>ç¼–å†™ é…ç½®</strong></h4> <blockquote><p>æ–¹å¼ä¸€: ä¸è¿›è¡Œæ³¨å†Œ  ç›´æ¥ä½¿ç”¨ url  ä¸å¤Ÿçµæ´»</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span> <span class="token comment">#æœåŠ¡ç«¯å£</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> api<span class="token punctuation">-</span>gateway <span class="token comment">#æŒ‡å®šæœåŠ¡å</span>
<span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-provider</span><span class="token punctuation">:</span> <span class="token comment">## è¿™é‡Œæ˜¯è·¯ç”±idï¼Œéšæ„å†™</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /service<span class="token punctuation">-</span>provider/<span class="token important">**</span> <span class="token comment">## è¿™é‡Œæ˜¯æ˜ å°„è·¯å¾„</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">8081</span> <span class="token comment">## æ˜ å°„è·¯å¾„å¯¹åº”çš„å®é™…urlåœ°å€</span>
</code></pre></div><blockquote><p>æ–¹å¼äºŒ: æ³¨å†Œ ä½¿ç”¨æœåŠ¡å ä¸”å†…ç½®æœ‰è´Ÿè½½å‡è¡¡ é»˜è®¤è½®è¯¢</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Zuul

<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment">## æ³¨å†Œä¸­å¿ƒçš„åœ°å€ å¦‚æœæ³¨å†Œé›†ç¾¤å¯å¯ä»¥å†™å…¥å¤šä¸ªæ³¨å†Œä¸­å¿ƒçš„åœ°å€ , éš”å¼€</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>10086/eureka
    <span class="token comment">## æ¯éš”5ç§’å‘æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡</span>
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
    <span class="token comment">## è®¾ç½® IP</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token comment">## æ³¨å†Œæ—¶ä½¿ç”¨è‡ªå·±çš„IPè€Œä¸æ˜¯ä¸»æœºå</span>
    <span class="token key atrule">prefer-ip-address</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment">## å®ä¾‹id</span>
    <span class="token key atrule">instance-id</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{</span>server.port<span class="token punctuation">}</span>

<span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token comment">## å†’å·å·¦è¾¹æ˜¯è·¯ç”±idå¯é…ç½®å¤šä¸ªï¼Œè·¯ç”±åï¼Œéšæ„å†™ï¼Œä¸èƒ½å†™ä¸­æ–‡</span>
    <span class="token key atrule">Modulethree</span><span class="token punctuation">:</span>
      <span class="token comment">## è¿™é‡Œæ˜¯æ˜ å°„è·¯å¾„ åœ¨è½¬å‘æ—¶ä¼šå°† three è£åˆ‡æ‰</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /three/<span class="token important">**</span>
      <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> Modulethree <span class="token comment">## æŒ‡å®šæœåŠ¡åç§°</span>

    <span class="token comment">## å†’å·å·¦è¾¹æ˜¯è·¯ç”±idå¯é…ç½®å¤šä¸ªï¼Œè·¯ç”±åï¼Œéšæ„å†™ï¼Œä¸èƒ½å†™ä¸­æ–‡</span>
    <span class="token key atrule">Moduletow</span><span class="token punctuation">:</span>
      <span class="token comment">## è¿™é‡Œæ˜¯æ˜ å°„è·¯å¾„ åœ¨è½¬å‘æ—¶ä¼šå°† tow è£åˆ‡æ‰</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /tow/<span class="token important">**</span>
      <span class="token key atrule">serviceId</span><span class="token punctuation">:</span> Moduletow <span class="token comment">## æŒ‡å®šæœåŠ¡åç§°</span>
</code></pre></div><blockquote><p>æ–¹å¼ä¸‰: ç®€åŒ– æ³¨å†Œ ä½¿ç”¨æœåŠ¡å ä¸”å†…ç½®æœ‰è´Ÿè½½å‡è¡¡ é»˜è®¤è½®è¯¢</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
  	<span class="token comment">## æŒ‡å®šæœåŠ¡åç§° : æ˜ å°„è·¯å¾„ åœ¨è½¬å‘æ—¶ä¼šå°† tow è£åˆ‡æ‰</span>
    <span class="token key atrule">service-provider</span><span class="token punctuation">:</span> /service<span class="token punctuation">-</span>provider/<span class="token important">**</span> 
</code></pre></div><blockquote><p>æ–¹å¼å››: é»˜è®¤é…ç½®  ä¸”å†…ç½®æœ‰è´Ÿè½½å‡è¡¡ é»˜è®¤è½®è¯¢</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token comment">## å³ ä¸é…ç½®  zuul:  ä½¿ç”¨é»˜è®¤çš„èŒƒå›´åè¿›è¡Œè½¬å‘</span>
http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>10010/æœåŠ¡å/è¯·æ±‚
</code></pre></div><h4 id="å¯åŠ¨ç±»-4"><a href="#å¯åŠ¨ç±»-4" class="header-anchor">#</a> å¯åŠ¨ç±»</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai</span><span class="token punctuation">;</span>

<span class="token comment">// å¼€å¯ç½‘å…³åŠŸèƒ½</span>
<span class="token annotation punctuation">@EnableZuulProxy</span>
<span class="token comment">// å¼€å¯Eurekaå®¢æˆ·ç«¯åŠŸèƒ½</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token comment">// è§£å†³ ä½¿ç”¨äº† mybatis-plus ä½†æ˜¯æ²¡é…ç½® æ•°æ®åº“ä¿¡æ¯åˆ™å¯åŠ¨æŠ¥é”™</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ZuulApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>æµ‹è¯•: http://localhost:10010/three/list</p> <h3 id="å…¶ä»–é…ç½®"><a href="#å…¶ä»–é…ç½®" class="header-anchor">#</a> å…¶ä»–é…ç½®</h3> <h4 id="_1ã€è·¯ç”±å‰ç¼€"><a href="#_1ã€è·¯ç”±å‰ç¼€" class="header-anchor">#</a> 1ã€è·¯ç”±å‰ç¼€</h4> <p>é…ç½®ç¤ºä¾‹ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-provider</span><span class="token punctuation">:</span> /service<span class="token punctuation">-</span>provider/<span class="token important">**</span>
    <span class="token key atrule">service-consumer</span><span class="token punctuation">:</span> /service<span class="token punctuation">-</span>consumer/<span class="token important">**</span>
  <span class="token key atrule">prefix</span><span class="token punctuation">:</span> /api <span class="token comment">## æ·»åŠ è·¯ç”±å‰ç¼€</span>
</code></pre></div><p>æˆ‘ä»¬é€šè¿‡<code>zuul.prefix=/api</code>æ¥æŒ‡å®šäº†è·¯ç”±çš„å‰ç¼€ï¼Œè¿™æ ·åœ¨å‘èµ·è¯·æ±‚æ—¶ï¼Œè·¯å¾„å°±è¦ä»¥/apiå¼€å¤´ã€‚</p> <h4 id="_2ã€ä¸å»é™¤æ˜ å°„è·¯å¾„å‰ç¼€"><a href="#_2ã€ä¸å»é™¤æ˜ å°„è·¯å¾„å‰ç¼€" class="header-anchor">#</a> 2ã€ä¸å»é™¤æ˜ å°„è·¯å¾„å‰ç¼€</h4> <blockquote><p>strip-prefix é»˜è®¤å€¼ä¸ºtrueï¼Œè¡¨ç¤ºé™¤å»å‰ç¼€ï¼Œstrip-prefix  = false è¡¨ç¤ºä¸é™¤å»å‰ç¼€</p> <p>æ³¨æ„: æ–¹å¼ä¸‰ ç®€åŒ–çš„é…ç½®ä¸èƒ½è¿›è¡Œ æ˜ å°„è·¯å¾„å‰ç¼€ è®¾ç½®</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-provider</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /user<span class="token punctuation">-</span>service/<span class="token important">**</span>
      <span class="token key atrule">url</span><span class="token punctuation">:</span>  http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8081</span>
      <span class="token key atrule">strip-prefix</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      
<span class="token key atrule">æ³¨æ„</span><span class="token punctuation">:</span>
<span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">USER-SERVICE</span><span class="token punctuation">:</span> /user<span class="token punctuation">-</span>service/<span class="token important">**</span>
    <span class="token key atrule">USER-CONSUMER</span><span class="token punctuation">:</span> /user<span class="token punctuation">-</span>consumer/<span class="token important">**</span> 
  <span class="token key atrule">strip-prefix</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>  <span class="token comment">#é‡‡ç”¨è¿™ä¸ªæ–¹å¼é…ç½®è·¯ç”±strip-prefixä¸ä¼šç”Ÿæ•ˆ</span>
</code></pre></div><h4 id="_3ã€å…³é—­é»˜è®¤é…ç½®è®¿é—®"><a href="#_3ã€å…³é—­é»˜è®¤é…ç½®è®¿é—®" class="header-anchor">#</a> 3ã€å…³é—­é»˜è®¤é…ç½®è®¿é—®</h4> <p>å¦‚æœä¸æƒ³ä½¿ç”¨é»˜è®¤çš„è·¯ç”±è§„åˆ™ï¼Œå°±å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ä¸‹åˆ—å†…å®¹ï¼Œå³å¯å…³é—­æ‰€æœ‰é»˜è®¤çš„è·¯ç”±è§„åˆ™ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">ignored-services</span><span class="token punctuation">:</span> <span class="token string">'*'</span>  <span class="token comment">#æ‰€æœ‰çš„è¯·æ±‚ éƒ½ä¸ä½¿ç”¨é»˜è®¤çš„è·¯ç”±è§„åˆ™ï¼Œæ‰€è°“é»˜è®¤çš„è§„åˆ™ï¼šå°±æ˜¯ä»€ä¹ˆéƒ½ä¸é…ï¼Œåœ°å€æ ç›´æ¥å†™æœåŠ¡å</span>
</code></pre></div><blockquote><p>å¿½ç•¥æ‰æ‰€æœ‰ç›´æ¥åœ¨åœ°å€æ å†™æœåŠ¡åçš„è¯·æ±‚</p></blockquote> <p>å…³é—­é»˜è®¤çš„è·¯ç”±é…ç½®ä¹‹åï¼Œéœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é€ä¸ªä¸ºéœ€è¦è·¯ç”±çš„æœåŠ¡æ·»åŠ æ˜ å°„è§„åˆ™ã€‚</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">USER-SERVICE</span><span class="token punctuation">:</span> /user<span class="token punctuation">-</span>service/<span class="token important">**</span>
    <span class="token key atrule">USER-CONSUMER</span><span class="token punctuation">:</span> /<span class="token important">**</span>   <span class="token comment">#</span>
  <span class="token key atrule">ignored-services</span><span class="token punctuation">:</span> provider<span class="token punctuation">-</span>service    <span class="token comment">#ä¸èƒ½åœ¨åœ°å€æ ä¸Šç›´æ¥è¾“å…¥provider-serviceæœåŠ¡åï¼Œå¿…é¡»ç»™è¯¥æœåŠ¡é…ç½®æ˜ å°„è§„åˆ™</span>
</code></pre></div><table><thead><tr><th>é€šé…ç¬¦</th> <th>è¯´æ˜</th> <th>ä¸¾ä¾‹</th></tr></thead> <tbody><tr><td>?</td> <td>åŒ¹é…ä»»æ„å•ä¸ªå­—ç¬¦</td> <td>/xxx/?</td></tr> <tr><td>*</td> <td>åŒ¹é…ä»»æ„æ•°é‡çš„å­—ç¬¦</td> <td>/xxx/*</td></tr> <tr><td>**</td> <td>åŒ¹é…ä»»æ„æ•°é‡çš„å­—ç¬¦ï¼Œ åŒ…æ‹¬å¤šçº§ç›®å½•</td> <td>/xxx/**</td></tr></tbody></table> <p>ä¸ºäº†è®©ç”¨æˆ·æ›´çµæ´»åœ°ä½¿ç”¨è·¯ç”±é…ç½®è§„åˆ™ï¼Œzuul è¿˜æä¾›äº†ä¸€ä¸ªå¿½ç•¥è¡¨è¾¾å¼å‚æ•° <code>zuul.ignored-patterns</code>ï¼Œè¯¥å‚æ•°ç”¨æ¥è®¾ç½®ä¸è¢«ç½‘å…³è¿›è¡Œè·¯ç”±çš„ Url è¡¨è¾¾å¼</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">ignored-patterns</span><span class="token punctuation">:</span> /<span class="token important">**/xxx/**</span>
  <span class="token key atrule">routes</span><span class="token punctuation">:</span>
    <span class="token key atrule">eureka-client-employee</span><span class="token punctuation">:</span> /employee/<span class="token important">**</span>
    <span class="token key atrule">eureka-client-department</span><span class="token punctuation">:</span> /department/<span class="token important">**</span>
</code></pre></div><h3 id="zuulfilter-è¿‡æ»¤å™¨"><a href="#zuulfilter-è¿‡æ»¤å™¨" class="header-anchor">#</a> ZuulFilter  è¿‡æ»¤å™¨</h3> <blockquote><p>Zuulä½œä¸ºç½‘å…³çš„å…¶ä¸­ä¸€ä¸ªé‡è¦åŠŸèƒ½ï¼Œå°±æ˜¯å®ç°è¯·æ±‚çš„é‰´æƒã€‚è€Œè¿™ä¸ªåŠ¨ä½œæˆ‘ä»¬å¾€å¾€æ˜¯é€šè¿‡Zuulæä¾›çš„è¿‡æ»¤å™¨æ¥å®ç°çš„ã€‚</p></blockquote> <h4 id="zuulfilter"><a href="#zuulfilter" class="header-anchor">#</a> ZuulFilter</h4> <p>ZuulFilteræ˜¯è¿‡æ»¤å™¨çš„é¡¶çº§çˆ¶ç±»ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶ä¸­å®šä¹‰çš„4ä¸ªæœ€é‡è¦çš„æ–¹æ³•ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token class-name">ZuulFilter</span> <span class="token keyword">implements</span> <span class="token class-name">IZuulFilter</span><span class="token punctuation">{</span>

    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ¥è‡ªIZuulFilter</span>

    <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span><span class="token punctuation">;</span><span class="token comment">// IZuulFilter</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p><code>shouldFilter</code>ï¼šè¿”å›ä¸€ä¸ª<code>Boolean</code>å€¼ï¼Œåˆ¤æ–­è¯¥è¿‡æ»¤å™¨æ˜¯å¦éœ€è¦æ‰§è¡Œã€‚è¿”å›trueæ‰§è¡Œï¼Œè¿”å›falseä¸æ‰§è¡Œã€‚</p></li> <li><p><code>run</code>ï¼šè¿‡æ»¤å™¨çš„å…·ä½“ä¸šåŠ¡é€»è¾‘ã€‚</p></li> <li><p><code>filterType</code>ï¼šè¿”å›å­—ç¬¦ä¸²ï¼Œä»£è¡¨è¿‡æ»¤å™¨çš„ç±»å‹ã€‚åŒ…å«ä»¥ä¸‹4ç§ï¼š</p> <p>preï¼šè¯·æ±‚åœ¨è¢«è·¯ç”±ä¹‹å‰æ‰§è¡Œ</p> <p>routeï¼šåœ¨è·¯ç”±è¯·æ±‚æ—¶è°ƒç”¨</p> <p>postï¼šåœ¨routeå’Œerrrorè¿‡æ»¤å™¨ä¹‹åè°ƒç”¨</p> <p>errorï¼šå¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯è°ƒç”¨</p></li> <li><p><code>filterOrder</code>ï¼šé€šè¿‡è¿”å›çš„intå€¼æ¥å®šä¹‰è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p></li></ul> <h4 id="è¿‡æ»¤å™¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ"><a href="#è¿‡æ»¤å™¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ" class="header-anchor">#</a> è¿‡æ»¤å™¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ</h4> <p>è¿™å¼ æ˜¯Zuulå®˜ç½‘æä¾›çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸå›¾ï¼Œæ¸…æ™°çš„è¡¨ç°äº†ä¸€ä¸ªè¯·æ±‚åœ¨å„ä¸ªè¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºã€‚</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1529152248172.png" alt="1529152248172"></p> <p>æ­£å¸¸æµç¨‹ï¼š</p> <ul><li>è¯·æ±‚åˆ°è¾¾é¦–å…ˆä¼šç»è¿‡preç±»å‹è¿‡æ»¤å™¨ï¼Œè€Œååˆ°è¾¾routeç±»å‹ï¼Œè¿›è¡Œè·¯ç”±ï¼Œè¯·æ±‚å°±åˆ°è¾¾çœŸæ­£çš„æœåŠ¡æä¾›è€…ï¼Œæ‰§è¡Œè¯·æ±‚ï¼Œè¿”å›ç»“æœåï¼Œä¼šåˆ°è¾¾postè¿‡æ»¤å™¨ã€‚è€Œåè¿”å›å“åº”ã€‚</li></ul> <p>å¼‚å¸¸æµç¨‹ï¼š4ç§æƒ…å†µ</p> <ul><li>æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœpreæˆ–è€…routeè¿‡æ»¤å™¨å‡ºç°å¼‚å¸¸ï¼Œéƒ½ä¼šç›´æ¥è¿›å…¥errorè¿‡æ»¤å™¨ï¼Œåœ¨errorå¤„ç†å®Œæ¯•åï¼Œä¼šå°†è¯·æ±‚äº¤ç»™POSTè¿‡æ»¤å™¨ï¼Œæœ€åè¿”å›ç»™ç”¨æˆ·ã€‚ï¼ˆ2ç§ï¼‰</li> <li>å¦‚æœæ˜¯errorè¿‡æ»¤å™¨è‡ªå·±å‡ºç°å¼‚å¸¸ï¼Œæœ€ç»ˆä¹Ÿä¼šè¿›å…¥POSTè¿‡æ»¤å™¨ï¼Œå°†æœ€ç»ˆç»“æœè¿”å›ç»™è¯·æ±‚å®¢æˆ·ç«¯ã€‚</li> <li>å¦‚æœæ˜¯POSTè¿‡æ»¤å™¨å‡ºç°å¼‚å¸¸ï¼Œä¼šè·³è½¬åˆ°errorè¿‡æ»¤å™¨ï¼Œä½†æ˜¯ä¸preå’Œrouteä¸åŒçš„æ˜¯ï¼Œè¯·æ±‚ä¸ä¼šå†åˆ°è¾¾POSTè¿‡æ»¤å™¨äº†ï¼Œè€Œæ˜¯ç›´æ¥å“åº”ç”¨æˆ·</li></ul> <p>æ‰€æœ‰å†…ç½®è¿‡æ»¤å™¨åˆ—è¡¨ï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/1525682427811.png" alt=""></p> <h3 id="å®šä¹‰è¿‡æ»¤å™¨ç±»"><a href="#å®šä¹‰è¿‡æ»¤å™¨ç±»" class="header-anchor">#</a> å®šä¹‰è¿‡æ»¤å™¨ç±»</h3> <blockquote><p>è¯¥ç±» @Component æ³¨å…¥é…ç½® ç»§æ‰¿ ZuulFilter é‡å†™å…¶æ–¹æ³•</p> <p>preï¼šè¯·æ±‚åœ¨è¢«è·¯ç”±ä¹‹å‰æ‰§è¡Œ</p> <p>routeï¼šåœ¨è·¯ç”±è¯·æ±‚æ—¶è°ƒç”¨</p> <p>postï¼šåœ¨routeå’Œerrrorè¿‡æ»¤å™¨ä¹‹åè°ƒç”¨</p> <p>errorï¼šå¤„ç†è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯è°ƒç”¨</p></blockquote> <p>æ³¨æ„ç‚¹:</p> <ul><li>context.setSendZuulResponse(false);  ä¸å¯¹å…¶è¿›è¡Œè·¯ç”±, ä¹Ÿä¸ä¼šå¯¹å…¶ä»–è¿‡æ»¤å™¨äº§ç”Ÿå½±å“,èƒ½å¤Ÿæ­£å¸¸é€šè¿‡æ‰€æœ‰è¿‡æ»¤å™¨</li> <li>error è¿‡æ»¤å™¨çš„è§¦å‘æ–¹å¼ åªèƒ½æ˜¯å…¶ä»–è¿‡æ»¤å™¨äº§ç”Ÿå¼‚å¸¸æ‰ä¼šè¿›å…¥ å¾®æœåŠ¡äº§ç”Ÿçš„å¼‚å¸¸ä¸ä¼šè¿›å…¥errorè¿‡æ»¤å™¨</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginFilter</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * è¿‡æ»¤å™¨ç±»å‹ï¼Œå‰ç½®è¿‡æ»¤å™¨
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;pre&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåº
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// intå€¼æ¥å®šä¹‰è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼Œæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ ä»…åŒç±»è¿‡æ»¤å™¨ã€‚</span>
        <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * è¯¥è¿‡æ»¤å™¨æ˜¯å¦ç”Ÿæ•ˆ
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿”å›true  è¡¨ç¤ºæ‰§è¡Œä¸‹é¢æ–¹æ³•çš„runã€‚ </span>
        <span class="token comment">// è¿”å›falseè¡¨ç¤ºä¸æ‰§è¡Œæœ¬ç±»çš„ run æ–¹æ³•ï¼Œä¸å½±å“å…¶ä»–è¿‡æ»¤å™¨ ç„¶åæ‰§è¡Œåé¢çš„è¿‡æ»¤å™¨</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>

    <span class="token comment">// run æ–¹æ³• æ‰§è¡Œ</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="å¸¸ç”¨-è¿‡æ»¤å™¨-æ¨¡æ¿"><a href="#å¸¸ç”¨-è¿‡æ»¤å™¨-æ¨¡æ¿" class="header-anchor">#</a> å¸¸ç”¨ è¿‡æ»¤å™¨ æ¨¡æ¿</h3> <h4 id="pre-è¿‡æ»¤å™¨-æ£€éªŒ-token"><a href="#pre-è¿‡æ»¤å™¨-æ£€éªŒ-token" class="header-anchor">#</a> pre è¿‡æ»¤å™¨ æ£€éªŒ token</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>zuulfilter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span></span><span class="token class-name">ZuulFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">RequestContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">ZuulException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>micrometer<span class="token punctuation">.</span>core<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExpFilterpre</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;pre&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–zuulæä¾›çš„ä¸Šä¸‹æ–‡å¯¹è±¡</span>
        <span class="token class-name">RequestContext</span> context <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä»ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­è·å–è¯·æ±‚å¯¹è±¡</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–tokenä¿¡æ¯</span>
        <span class="token comment">// String token = request.getParameter(&quot;token&quot;);</span>
        <span class="token class-name">String</span> token <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ¤æ–­</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿‡æ»¤è¯¥è¯·æ±‚ï¼Œä¸å¯¹å…¶è¿›è¡Œè·¯ç”±</span>
            context<span class="token punctuation">.</span><span class="token function">setSendZuulResponse</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®¾ç½®å“åº”çŠ¶æ€ç ï¼Œ401</span>
            context<span class="token punctuation">.</span><span class="token function">setResponseStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>SC_UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è®¾ç½®å“åº”ä¿¡æ¯</span>
            <span class="token comment">// response.getWriter().write(&quot;{\&quot;status\&quot;:\&quot;401\&quot;, \&quot;text\&quot;:\&quot;tokenæ— æ•ˆ!\&quot;}&quot;);</span>
            context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;status\&quot;:\&quot;401\&quot;, \&quot;text\&quot;:\&quot;request error!\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// æ ¡éªŒé€šè¿‡ï¼ŒæŠŠç™»é™†ä¿¡æ¯æ”¾å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œç»§ç»­å‘åæ‰§è¡Œ</span>
        context<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="post-è¿‡æ»¤å™¨-è·å–å¼‚å¸¸"><a href="#post-è¿‡æ»¤å™¨-è·å–å¼‚å¸¸" class="header-anchor">#</a> post è¿‡æ»¤å™¨ è·å–å¼‚å¸¸</h4> <blockquote><p>ç¨‹åºå‡ºç°å¼‚å¸¸ å¦‚:404 500ç­‰åœ¨ post è¿‡æ»¤å™¨å¯è·å–åˆ°</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>zuulfilter</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span></span><span class="token class-name">ZuulFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">RequestContext</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span>exception<span class="token punctuation">.</span></span><span class="token class-name">ZuulException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExpFilterprepost</span> <span class="token keyword">extends</span> <span class="token class-name">ZuulFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filterType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;post&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">filterOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">shouldFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ZuulException</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–zuulæä¾›çš„ä¸Šä¸‹æ–‡å¯¹è±¡</span>
        <span class="token class-name">RequestContext</span> context <span class="token operator">=</span> <span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä»ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­è·å–è¯·æ±‚å¯¹è±¡</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token class-name">HttpServletResponse</span> response <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Content-type&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;text/html;charset=UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> responseStatusCode <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResponseStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>responseStatusCode <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;status\&quot;:\&quot;404\&quot;, \&quot;text\&quot;:\&quot;ç½‘å€ä¸æ­£ç¡®!\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>responseStatusCode <span class="token operator">==</span> <span class="token number">405</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;status\&quot;:\&quot;405\&quot;, \&quot;text\&quot;:\&quot;è¯·æ±‚ç±»å‹ä¸ä¸€è‡´!\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>responseStatusCode <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;status\&quot;:\&quot;500\&quot;, \&quot;text\&quot;:\&quot;ç¨‹åºå‡ºç°é”™è¯¯!\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>responseStatusCode <span class="token operator">==</span> <span class="token number">504</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;status\&quot;:\&quot;504\&quot;, \&quot;text\&quot;:\&quot;ç½‘å…³è¶…æ—¶!\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>responseStatusCode <span class="token operator">==</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">setResponseBody</span><span class="token punctuation">(</span><span class="token string">&quot;{\&quot;status\&quot;:\&quot;400\&quot;, \&quot;text\&quot;:\&quot;è¯·æ±‚å‚æ•°ç±»å‹é”™è¯¯!\&quot;}&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="zuul-ä¸-hystrix-ç»“åˆå®ç°ç†”æ–­"><a href="#zuul-ä¸-hystrix-ç»“åˆå®ç°ç†”æ–­" class="header-anchor">#</a> Zuul ä¸ Hystrix ç»“åˆå®ç°ç†”æ–­</h3> <p>Zuul å’Œ Hystrix ç»“åˆä½¿ç”¨å®ç°ç†”æ–­åŠŸèƒ½æ—¶ï¼Œéœ€è¦å®Œæˆ FallbackProvider æ¥å£ã€‚è¯¥æ¥å£æä¾›äº† 2 ä¸ªæ–¹æ³•ï¼š</p> <ul><li><strong>.getRoute</strong> æ–¹æ³•ï¼šç”¨äºæŒ‡å®šä¸ºå“ªä¸ªæœåŠ¡æä¾› fallback åŠŸèƒ½ã€‚</li> <li><strong>.fallbackResponse</strong> æ–¹æ³•ï¼šç”¨äºæ‰§è¡Œå›é€€æ“ä½œçš„å…·ä½“é€»è¾‘ã€‚</li></ul> <p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¸º service-id ä¸º <code>eureka-client-department</code> çš„å¾®æœåŠ¡ï¼ˆåœ¨ zuul ç½‘å…³å¤„ï¼‰æä¾›ç†”æ–­ fallback åŠŸèƒ½ã€‚</p> <ul><li>å®ç° FallbackProvider æ¥å£ï¼Œå¹¶æ‰˜ç®¡ç»™ Spring IoC å®¹å™¨</li></ul> <p>1ã€Zuulä¸­é»˜è®¤å°±å·²ç»é›†æˆäº†Ribbonè´Ÿè½½å‡è¡¡å’ŒHystixç†”æ–­æœºåˆ¶ã€‚ä½†æ˜¯æ‰€æœ‰çš„è¶…æ—¶ç­–ç•¥éƒ½æ˜¯èµ°çš„é»˜è®¤å€¼ï¼Œæ¯”å¦‚ç†”æ–­è¶…æ—¶æ—¶é—´åªæœ‰1Sï¼Œå¾ˆå®¹æ˜“å°±è§¦å‘äº†ã€‚å› æ­¤å»ºè®®æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œé…ç½®ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">ReadTimeout</span><span class="token punctuation">:</span> <span class="token number">12000</span> 
  <span class="token key atrule">ConnectTimeout</span><span class="token punctuation">:</span> <span class="token number">10000</span> 
  
  
<span class="token key atrule">woniu-service-provider</span><span class="token punctuation">:</span>  <span class="token comment">#åœ¨ç½‘å…³ä¸Šé…ç½® è¯·æ±‚æŸä¸ªæœåŠ¡åçš„è´Ÿè½½å‡è¡¡æµ‹è¯•  æœåŠ¡åå°å†™</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.RandomRule
</code></pre></div><blockquote><p>1.ç½‘å…³è½¬å‘ç»™AæœåŠ¡ï¼ŒAæœåŠ¡é€šè¿‡openfeignè¯·æ±‚BæœåŠ¡ï¼Œå¹¶ä¸”åœ¨AæœåŠ¡é…ç½®äº†openfeignçš„é‡è¯•åŠŸèƒ½ï¼Œå‡å¦‚AæœåŠ¡ç¬¬ä¸€æ¬¡è¯·æ±‚BæœåŠ¡ä»¥åŠé‡è¯•æ€»æ—¶é•¿æ˜¯12s((1+5)*2))ï¼Œé‚£ä¹ˆç½‘å…³çš„ ribbon.ReadTimeoutåº”è¯¥ç­‰äº12s,12sä¹‹åç«‹åˆ»é™çº§.</p> <p>2.ç½‘å…³é™çº§ä¹‹åï¼Œå¦‚æœå®šä¹‰äº†postè¿‡æ»¤å™¨ï¼Œåˆ™èµ°postè¿‡æ»¤å™¨ï¼Œæ­¤æ—¶postè¿‡æ»¤å™¨æ”¶åˆ°çš„çŠ¶æ€å€¼å°±æ˜¯200ï¼Œä¸ºç½‘å…³é™çº§æ­£å¸¸å¤„ç†çš„çŠ¶æ€å€¼ï¼Œç„¶åpostæŠŠå¤„ç†ç»“æœå“åº”ç»™æµè§ˆå™¨ï¼Œå¦‚æœpostè¿‡æ»¤å™¨æ²¡æœ‰å¯¹statusä¸º200çš„è¿›è¡Œå¤„ç†ï¼Œé‚£è¿™ä¸ªå“åº”ç»“æœè¿˜æ˜¯ç½‘å…³é™çº§ç»“æœï¼Œè¿™å¹¶ä¸æ„å‘³ç€postè¿‡æ»¤å™¨ä¸æ‰§è¡Œ</p> <p>3.å¦‚æœReadTimeoutè¶…æ—¶æ—¶é—´å°äºå¾®æœåŠ¡è¯·æ±‚çš„æ€»æ—¶é•¿ï¼Œå¦‚ReadTimeout=3000ï¼Œé‚£ä¹ˆ3sç½‘å…³å°±é™çº§äº†ï¼Œç„¶åæ‰§è¡Œpostè¿‡æ»¤å™¨ï¼Œæ­¤æ—¶postè¿‡æ»¤å™¨æ”¶åˆ°çš„å“åº”çŠ¶æ€å€¼ä¾ç„¶æ˜¯200.åªä¸è¿‡ä¸è¦è¿™æ ·é…ç½®ï¼Œå¦åˆ™ç½‘å…³éƒ½ç»™å®¢æˆ·å“åº”äº†ï¼Œè€Œå¾®æœåŠ¡é€šè¿‡feignè¿˜åœ¨ä¸æ–­çš„é‡è¯•</p> <p>4.å¦‚æœReadTimeoutè¶…æ—¶æ—¶é—´å¤§äºå¾®æœåŠ¡è¯·æ±‚çš„æ€»æ—¶é•¿ï¼Œå¦‚ReadTimeout=20000ï¼Œä¹Ÿå°±æ˜¯20såæ‰é™çº§ï¼Œé‚£ä¹ˆåœ¨12såï¼ŒAæœåŠ¡ä¸å†é‡è¯•BæœåŠ¡äº†ï¼Œè¯·æ±‚å¤±è´¥ï¼Œç›´æ¥æŠ›å‡ºçŠ¶æ€ç ä¸º500çš„å¼‚å¸¸ï¼Œè€Œæ­¤æ—¶zuulè¿˜æ²¡æœ‰é™çº§ï¼Œæ‰€ä»¥postè¿‡æ»¤å™¨æ”¶åˆ°çš„å“åº”çŠ¶æ€å€¼æ˜¯500ï¼Œpostè¿‡æ»¤å™¨å¯ä»¥å¯¹500çš„çŠ¶æ€ç è¿›è¡Œå¤„ç†ï¼Œç„¶åå“åº”</p> <p>5.å¦‚æœAæœåŠ¡é€šè¿‡feignè°ƒç”¨äº†BæœåŠ¡å¤±è´¥ï¼ŒAæœåŠ¡è‡ªå·±å®ç°äº†feignçš„é™çº§åŠŸèƒ½ï¼Œé‚£ä¹ˆç«™åœ¨zuulçš„è§’åº¦æ¥çœ‹ï¼ŒAæœåŠ¡æ˜¯æ­£å¸¸å“åº”ï¼Œæ­¤æ—¶zuulä¸ä¼šæ‰§è¡Œé™çº§ï¼Œæœ€ç»ˆåªæ‰§è¡Œpostç±»å‹è¿‡æ»¤å™¨ï¼Œè¿‡æ»¤å™¨æ”¶åˆ°AæœåŠ¡çš„å“åº”çŠ¶æ€ç å°±æ˜¯200ï¼Œä½ å¯ä»¥æ³¨æ‰feignçš„é™çº§å®ç°ç±»ã€‚</p></blockquote> <h4 id="zuul-ä¸-hystrix-é™çº§"><a href="#zuul-ä¸-hystrix-é™çº§" class="header-anchor">#</a> Zuul ä¸ Hystrix é™çº§</h4> <p>é˜²å‘æŒ‡å—:</p> <ul><li>é™çº§ç±»åŠ ä¸Šæ³¨è§£: @Component</li> <li>å¯åŠ¨ç±»åŠ ä¸Š: @EnableCircuitBreaker | å¼€å¯Hystrixç†”æ–­</li> <li>åœ¨ Zuul  ç†”æ–­æ—¶ è§¦å‘é™çº§</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>netflix<span class="token punctuation">.</span>zuul<span class="token punctuation">.</span>filters<span class="token punctuation">.</span>route<span class="token punctuation">.</span></span><span class="token class-name">FallbackProvider</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ClientHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZuulFallBack</span> <span class="token keyword">implements</span> <span class="token class-name">FallbackProvider</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * è¦é™çº§çš„ æœåŠ¡å
     * return &quot;*&quot;  æ‰€æœ‰æœåŠ¡çš„é™çº§
     * return â€œæœåŠ¡åâ€
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">fallbackResponse</span><span class="token punctuation">(</span><span class="token class-name">String</span> route<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> cause<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ClientHttpResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">/**
             *  è¦ç»™å®¢æˆ·ç«¯å“åº”çš„çŠ¶æ€å—
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpStatus</span> <span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/**
             * çŠ¶æ€å€¼
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getRawStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getStatusText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getReasonPhrase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/**
             * é™çº§æ—¶éœ€å…³é—­ ...
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token punctuation">}</span>

            <span class="token comment">/**
             * å“åº”çš„å†…å®¹
             * @return
             * @throws IOException
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">InputStream</span> <span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token string">&quot;{statusï¼š403,msg:æœåŠ¡å™¨æ­£å¿™ï¼Œè¯·ç¨åå†è¯•}&quot;</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/**
             * å“åº”å¤´     MediaType
             * @return
             */</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">HttpHeaders</span> <span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">HttpHeaders</span> header <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">MediaType</span> type <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaType</span><span class="token punctuation">(</span><span class="token string">&quot;application&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;json&quot;</span><span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                header<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> header<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="zuul-ä¸­çš„-eager-load-é…ç½®"><a href="#zuul-ä¸­çš„-eager-load-é…ç½®" class="header-anchor">#</a> Zuul ä¸­çš„ Eager Load é…ç½®</h3> <p>zuul çš„è·¯ç”±è½¬å‘ä¹Ÿæ˜¯ç”±é€šè¿‡ Ribbon å®ç°è´Ÿè½½å‡è¡¡çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç›¸å…³çš„ Bean ä¼šå»¶è¿ŸåŠ è½½ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨å¾®æœåŠ¡æ—¶ï¼Œæ‰ä¼šåˆå§‹åŒ–è¿™äº›å¯¹è±¡ã€‚æ‰€ä»¥ zuul æ— æ³•åœ¨ç¬¬ä¸€æ—¶é—´åŠ è½½åˆ° Ribbon çš„è´Ÿè½½å‡è¡¡ã€‚</p> <p>å¦‚æœæƒ³æå‰åŠ è½½ Ribbon å®¢æˆ·ç«¯ï¼Œå°±å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­å¼€å¯é¥¥é¥¿åŠ è½½ï¼ˆå³ï¼Œç«‹å³åŠ è½½ï¼‰ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>æ³¨æ„ <strong>eager-load</strong> é…ç½®å¯¹äºé»˜è®¤è·¯ç”±ä¸èµ·ä½œç”¨ã€‚å› æ­¤ï¼Œé€šå¸¸å®ƒéƒ½æ˜¯ç»“åˆ <code>zuul.ignored-services=*</code> ï¼ˆå³å¿½ç•¥æ‰€æœ‰çš„é»˜è®¤è·¯ç”±ï¼‰ ä¸€èµ·ä½¿ç”¨çš„ï¼Œä»¥è¾¾åˆ° zuul å¯åŠ¨æ—¶å°±é»˜è®¤å·²ç»åˆå§‹åŒ–å„ä¸ªè·¯ç”±æ‰€è¦è½¬å‘çš„è´Ÿè½½å‡è¡¡å¯¹è±¡ã€‚</p> <h3 id="ç¦ç”¨-zuul-è¿‡æ»¤å™¨"><a href="#ç¦ç”¨-zuul-è¿‡æ»¤å™¨" class="header-anchor">#</a> ç¦ç”¨ zuul è¿‡æ»¤å™¨</h3> <p>Spring Cloud é»˜è®¤ä¸º zuul ç¼–å†™å¹¶å¯åŠ¨äº†ä¸€äº›è¿‡æ»¤å™¨ï¼Œè¿™äº›è¿‡æ»¤å™¨éƒ½æ”¾åœ¨ <code>org.springframework.cloud.netflix.zuul.filters</code> åŒ…ä¸‹ã€‚</p> <p>å¦‚æœéœ€è¦ç¦ç”¨æŸä¸ªè¿‡æ»¤å™¨ï¼Œåªéœ€è¦è®¾ç½® <code>zuul.&lt;SimpleClassName&gt;.&lt;filterType&gt;.disabled=true</code>ï¼Œå°±èƒ½ç¦ç”¨åä¸º <code>&lt;SimpleClassName&gt;</code> çš„è¿‡æ»¤å™¨ã€‚ä¾‹å¦‚:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">JwtFilter</span><span class="token punctuation">:</span>
    <span class="token key atrule">pre</span><span class="token punctuation">:</span>
      <span class="token key atrule">disable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>ä¸Šè¿°é…ç½®å°±ç¦ç”¨æ‰äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„ JwtFilter ã€‚</p> <h2 id="eureka-å¾®æœåŠ¡-æ€»æ±‡"><a href="#eureka-å¾®æœåŠ¡-æ€»æ±‡" class="header-anchor">#</a> ||-&gt; Eureka å¾®æœåŠ¡ æ€»æ±‡</h2> <h3 id="ä¾èµ–"><a href="#ä¾èµ–" class="header-anchor">#</a> ä¾èµ–</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Eureka å¾®æœåŠ¡--&gt;</span>
<span class="token comment">&lt;!--eurekaçš„æ³¨å†Œä¸­å¿ƒä¾èµ– è¿˜éœ€é…ç½®ç‰ˆæœ¬&lt;properties&gt;å’Œ&lt;dependencyManagement&gt;--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--EurekaServer-å®¢æˆ·ç«¯è‡ªåŠ¨æ³¨å†Œ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Hystrixç†”æ–­ æœåŠ¡é™çº§--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Open Feign è¿œç¨‹è°ƒç”¨ç»„ä»¶--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!--Zuul ç½‘å…³ç»„ä»¶--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-zuul<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--Eureka å¾®æœåŠ¡ ç‰ˆæœ¬ç®¡ç† å¯å†™å…¥çˆ¶ç±»çš„pom--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>2.3.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--EurekaServerä¾èµ–çš„ç‰ˆæœ¬ å¯å†™å…¥çˆ¶ç±»çš„pom--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Hoxton.SR9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--Springcloud ç®¡ç† å¯å†™å…¥çˆ¶ç±»çš„pom--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="eureka-æ³¨è§£"><a href="#eureka-æ³¨è§£" class="header-anchor">#</a> Eureka æ³¨è§£</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// -- å¯åŠ¨ç±» --</span>
<span class="token comment">// å¯åŠ¨ç±» è§£å†³ ä½¿ç”¨äº† mybatis-plus ä½†æ˜¯æ²¡é…ç½® æ•°æ®åº“ä¿¡æ¯åˆ™å¯åŠ¨æŠ¥é”™</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token comment">// å£°æ˜å½“å‰springbootåº”ç”¨æ˜¯ä¸€ä¸ªeurekaæœåŠ¡ä¸­å¿ƒ</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token comment">// å¼€å¯Eurekaå®¢æˆ·ç«¯åŠŸèƒ½</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> 
<span class="token comment">// å¼€å¯Hystrixç†”æ–­</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span> <span class="token operator">||</span> <span class="token annotation punctuation">@EnableHystrix</span>
<span class="token comment">// å¼€å¯Zuulç½‘å…³åŠŸèƒ½</span>
<span class="token annotation punctuation">@EnableZuulProxy</span>
<span class="token comment">// ç»„åˆæ³¨è§£</span>
<span class="token annotation punctuation">@SpringCloudApplication</span>
<span class="token operator">*</span> <span class="token annotation punctuation">@SpringBootApplication</span> <span class="token comment">// å¯åŠ¨ç±»æ³¨è§£</span>
<span class="token operator">*</span> <span class="token annotation punctuation">@EnableDiscoveryClient</span> <span class="token comment">// å¼€å¯ Eurekaå®¢æˆ·ç«¯</span>
<span class="token operator">*</span> <span class="token annotation punctuation">@EnableCircuitBreaker</span> <span class="token comment">// å¼€å¯Hystrixç†”æ–­</span>
<span class="token comment">// å¼€å¯ Open Feign å®¢æˆ·ç«¯ è¿œç¨‹è°ƒç”¨ç»„ä»¶ï¼Œæ— éœ€é…ç½®ç†”æ–­å™¨å’Œè´Ÿè½½å‡è¡¡æ³¨è§£</span>
<span class="token annotation punctuation">@EnableFeignClients</span>

<span class="token comment">// -- å¯åŠ¨ç±»é‡Œçš„ RestTemplate æ–¹æ³•ä¸Š --</span>
<span class="token comment">// è´Ÿè½½å‡è¡¡ ä¸æ·»åŠ è¿™ä¸ªæ³¨è§£ï¼Œä¸èƒ½ç›´æ¥ç”¨æœåŠ¡åè®¿é—®</span>
<span class="token annotation punctuation">@LoadBalanced</span>
    
<span class="token comment">// -- è¡¨ç°å±‚ é™çº§ -- </span>
<span class="token comment">// æŒ‡å®šæœåŠ¡æŸ¥è¯¢å¼‚å¸¸æ—¶è°ƒç”¨çš„æ–¹æ³• å†™åœ¨æ–¹æ³•ä¸Š</span>
<span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;æ–¹æ³•å&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// æŒ‡å®šä¸€ä¸ªç±»çš„å…¨å±€é™çº§æ–¹æ³• ç±»ä¸Š é…åˆ@HystrixCommandè®©æ–¹æ³•å¼‚å¸¸è§¦å‘é™çº§</span>
<span class="token annotation punctuation">@DefaultProperties</span><span class="token punctuation">(</span>defaultFallback <span class="token operator">=</span> <span class="token string">&quot;æ–¹æ³•å&quot;</span><span class="token punctuation">)</span>
    
<span class="token comment">// -- Open Feign è¿œç¨‹è°ƒç”¨ç»„ä»¶ æ¥å£ç±» --</span>
<span class="token comment">// æ ‡æ³¨è¯¥ç±»æ˜¯ä¸€ä¸ªfeignæ¥å£ ä¸”é“¾æ¥åˆ°æœåŠ¡æ–¹</span>
<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;æœåŠ¡å&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="springconfig-nacos-å¾®æœåŠ¡"><a href="#springconfig-nacos-å¾®æœåŠ¡" class="header-anchor">#</a> SpringConfig-Nacos å¾®æœåŠ¡</h2> <h3 id="nacos-çš„ä¸‹è½½å’Œå®‰è£…"><a href="#nacos-çš„ä¸‹è½½å’Œå®‰è£…" class="header-anchor">#</a> Nacos çš„ä¸‹è½½å’Œå®‰è£…</h3> <p>é¦–å…ˆå» nacos çš„ github åœ°å€ä¸‹è½½ release å®‰è£…åŒ…ã€‚<a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener noreferrer">ä¸‹è½½åœ°å€</a></p> <p>è¿›å…¥åˆ° nacos/bin ç›®å½•ä¸‹é¢ï¼Œ<strong>startup</strong> å‘½ä»¤ç”¨äºå¯åŠ¨ nacos ï¼Œ<strong>shutdown</strong> å‘½ä»¤ç”¨äºåœæ‰ nacos ã€‚</p> <blockquote><p>windows ç³»ç»Ÿ åœ¨binæ–‡ä»¶å¤¹ä¸‹cmd</p></blockquote> <ul><li>æ‰§è¡Œ startup.cmd -m standalone å¯åŠ¨ï¼Œå•æ¨¡å¼å¯åŠ¨</li></ul> <blockquote><p>linux/unix ç³»ç»Ÿ</p></blockquote> <ul><li>æ‰§è¡Œ startup.sh -m standalone å¯åŠ¨ã€‚</li></ul> <blockquote><p>linux/unix ç³»ç»Ÿdocker-compose é•œåƒå®¹å™¨</p></blockquote> <ul><li>ç¼–å†™docker-compose.ymlæ–‡ä»¶   å¯åŠ¨è¯¥æ–‡ä»¶ å‘½ä»¤ï¼š docker-compose up</li></ul> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/image-20220721190744220.png" alt="image-20220721190744220"></p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">nacos</span><span class="token punctuation">:</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>server<span class="token punctuation">:</span>latest
  <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nacos<span class="token punctuation">-</span>standalone<span class="token punctuation">-</span><span class="token number">8848</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> PREFER_HOST_MODE=hostname
    <span class="token punctuation">-</span> MODE=standalone   <span class="token comment">#å•æœºæ¨¡å¼å¯åŠ¨</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ./8848/logs/<span class="token punctuation">:</span>/home/nacos/logs   <span class="token comment">#å‰é¢æ˜¯å®¿ä¸»æœºå  åé¢æ˜¯å®¹å™¨ç›®å½•å</span>
    <span class="token punctuation">-</span> ./8848/init.d/custom.properties<span class="token punctuation">:</span>/home/nacos/init.d/custom.properties
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;8848:8848&quot;</span>
</code></pre></div><p>nacos çš„é»˜è®¤æœåŠ¡ç«¯å£æ˜¯ <strong>8848</strong> ï¼Œå¯åŠ¨å®Œæˆä¹‹åé€šè¿‡æµè§ˆå™¨è®¿é—® nacosï¼šhttp://127.0.0.1:8848/nacos ã€‚</p> <p>çœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼Œéœ€è¦ç™»é™†ï¼Œé»˜è®¤çš„ç”¨æˆ·åå¯†ç éƒ½æ˜¯ <strong>nacos</strong> ï¼Œç™»é™†ä¹‹åçœ‹åˆ°å¦‚ä¸‹ç•Œé¢ï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/image-20210610204222725.png" alt="image-20210610204222725"></p> <p>nacos çš„å•æœº standalone æ¨¡å¼æ˜¯å¼€å‘ç¯å¢ƒä¸­ä½¿ç”¨çš„å¯åŠ¨æ–¹å¼ï¼Œå®ƒå¯¹ç”¨æˆ·è€Œè¨€éå¸¸å‹å¥½ï¼Œå‡ ä¹ä¸éœ€è¦çš„æ›´å¤šçš„æ“ä½œå°±å¯ä»¥æ­å»º nacos å•èŠ‚ç‚¹ã€‚å¦å¤–ï¼Œstandalone æ¨¡å¼å®‰è£…é»˜è®¤æ˜¯ä½¿ç”¨äº† nacos æœ¬èº«çš„åµŒå…¥å¼æ•°æ®åº“ apache derby(Derbyæ˜¯ä¸€ä¸ªOpen sourceçš„äº§å“ï¼Œæ˜¯ä¸€ä¸ªå°å‹çš„æ•°æ®åº“) ã€‚</p> <h2 id="nacos-æ³¨å†Œä¸­å¿ƒ"><a href="#nacos-æ³¨å†Œä¸­å¿ƒ" class="header-anchor">#</a> |-- Nacos æ³¨å†Œä¸­å¿ƒ</h2> <blockquote><p>Nacos  å¯åŠ¨å³ä¸ºæ³¨å†Œä¸­å¿ƒ æ— éœ€åˆ›å»ºé¡¹ç›® åˆ¶ä½œæ³¨å†Œä¸­å¿ƒ åªéœ€å°†å¾®æœåŠ¡æ³¨å†Œå³å¯</p> <p>nacos çš„é»˜è®¤æœåŠ¡ç«¯å£æ˜¯ <strong>8848</strong> ï¼Œå¯åŠ¨å®Œæˆä¹‹åé€šè¿‡æµè§ˆå™¨è®¿é—® nacosï¼šhttp://127.0.0.1:8848/nacos ã€‚</p> <p>é»˜è®¤çš„è´¦å· å¯†ç : nacos</p></blockquote> <h3 id="nacos-æ³¨å†Œ-æ­¥éª¤"><a href="#nacos-æ³¨å†Œ-æ­¥éª¤" class="header-anchor">#</a> Nacos æ³¨å†Œ æ­¥éª¤</h3> <h4 id="nacos-ä¾èµ–"><a href="#nacos-ä¾èµ–" class="header-anchor">#</a> Nacos  ä¾èµ–</h4> <p>æ³¨æ„å¼•å…¥ä¾èµ–æ—¶ é€‰æ‹© Nacos Service Discovery ä¸” è¿˜è¦å¯¹åº”çš„ç‰ˆæœ¬ å¯å¼•å…¥çˆ¶é¡¹ç›®</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Nacos è‡ªåŠ¨æ³¨å†Œä¾èµ–--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="nacos-æ³¨è§£"><a href="#nacos-æ³¨è§£" class="header-anchor">#</a> Nacos  æ³¨è§£</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ---- å¯åŠ¨ç±» ----</span>
<span class="token comment">// å¯ç”¨ nacos çš„æœåŠ¡å‘ç°</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> 
</code></pre></div><h3 id="nacos-é…ç½®ä¸­å¿ƒ"><a href="#nacos-é…ç½®ä¸­å¿ƒ" class="header-anchor">#</a> Nacos  é…ç½®ä¸­å¿ƒ</h3> <p>Nacos ä½œä¸ºé…ç½®ç®¡ç†ä¸­å¿ƒï¼Œå®ç°çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯é…ç½®çš„ç»Ÿä¸€ç®¡ç†ã€‚</p> <h4 id="nacos-é…ç½®ä¸­å¿ƒ-æ³¨è§£"><a href="#nacos-é…ç½®ä¸­å¿ƒ-æ³¨è§£" class="header-anchor">#</a> Nacos é…ç½®ä¸­å¿ƒ æ³¨è§£</h4> <blockquote><p>æ·»åŠ   æ³¨è§£</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Nacos é…ç½®æ–‡ä»¶å­˜æ”¾æ³¨å†Œä¸­å¿ƒ--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="æ–°å»ºé…ç½®æ–‡ä»¶-bootstrap-yml"><a href="#æ–°å»ºé…ç½®æ–‡ä»¶-bootstrap-yml" class="header-anchor">#</a> æ–°å»ºé…ç½®æ–‡ä»¶ bootstrap.yml</h4> <p>æ–°å¢ <strong>spring.cloud.nacos.config</strong> èŠ‚ç‚¹é…ç½®ï¼Œå°†æœåŠ¡æŒ‡å‘æ­£ç¡®çš„ nacos æœåŠ¡ç«¯ã€‚</p> <blockquote><p>æ³¨æ„:</p> <p>Spring Cloud Config ä¸€æ ·ï¼Œè¿æ¥é…ç½®ä¸­å¿ƒçš„é…ç½®ä¿¡æ¯ã€<strong>å¿…é¡»</strong>ã€å†™åœ¨ <strong>bootstrap.yml</strong> é…ç½®æ–‡ä»¶ä¸­ï¼Œè€Œä¸æ˜¯ application é…ç½®æ–‡ä»¶ä¸­ã€‚<strong>bootstrap</strong> ä¼˜å…ˆçº§é«˜äºapllication</p> <p>é…ç½®æ–‡ä»¶ä¸­åªä¿ç•™ nacos ç›¸å…³çš„é…ç½®å³å¯ï¼Œå…¶ä»–çš„é…ç½®æ”¾åˆ° nacos ä¸­ç»Ÿä¸€ç®¡ç†ã€‚</p></blockquote> <p><strong>é˜²å‘æŒ‡å—</strong></p> <ul><li>ç«¯å£ è¿˜æ˜¯å†™åœ¨ é¡¹ç›®çš„é…ç½®æ–‡ä»¶é‡Œ å› ä¸ºåœ¨ Nacos é‡Œæ”¹å˜ç«¯å£ä¼šåŠ¨æ€æ›´æ”¹ ä½†æ˜¯ä¸ä¼šæ—¶é¡¹ç›®é‡æ–°å¯åŠ¨</li> <li>ç«¯å£å’Œæ•°æ®åº“åœ¨è¿›è¡ŒåŠ¨æ€ä¿®æ”¹æ—¶ é¡¹ç›®æ˜¯ä¸ä¼šé‡å¯çš„ æ‰€æœ‰è¦ä½¿é…ç½®ç”Ÿæ•ˆè¿˜æ˜¯è¦é‡å¯é¡¹ç›®</li> <li>æŒ‡å®šåœ¨ä¸åŒç¯å¢ƒä¸‹çš„é…ç½® å¦‚: dev  åœ¨Nacosçš„é…ç½®æ–‡ä»¶çš„ ID ä¸€å®šè¦è§„èŒƒ</li> <li>å…±åŒå¼€å‘ åœ¨æ³¨å†Œnacosçš„æ—¶å€™å¯èƒ½å¯¼è‡´æ³¨å†Œçš„ipåœ°å€è¢«å…¶ä»–çš„ä»£ç†è€Œä¸æ˜¯é¡¹ç›®çš„ip æ‰€ä»¥éœ€æŒ‡å®šipå‰ç¼€</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> æœåŠ¡å
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
  	<span class="token comment">## æŒ‡å®š Nacos åœ¨ä¸åŒç¯å¢ƒä¸‹çš„é…ç½®</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token comment">## é…ç½®åˆ†ç»„ã€‚æœªé…ç½®æ—¶ï¼Œé»˜è®¤åˆ†ç»„æ˜¯ DEFAULT_GROUP</span>
        <span class="token key atrule">group</span><span class="token punctuation">:</span> XXX_GROUP  
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.discovery.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>
        <span class="token comment">## nacos é…ç½®æ–‡ä»¶åç¼€ã€‚æ³¨æ„æ˜¯ yamlï¼Œä¸æ˜¯ yml</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml
        
        
<span class="token comment">## å…±åŒå¼€å‘ åœ¨æ³¨å†Œnacosçš„æ—¶å€™å¯èƒ½å¯¼è‡´æ³¨å†Œçš„ipåœ°å€è¢«å…¶ä»–çš„ä»£ç†è€Œä¸æ˜¯é¡¹ç›®çš„ip æ‰€ä»¥éœ€æŒ‡å®šipå‰ç¼€</span>
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.172.0.18<span class="token punctuation">:</span><span class="token number">8848</span>
            <span class="token key atrule">config</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span>spring.cloud.nacos.discovery.server<span class="token punctuation">-</span>addr<span class="token punctuation">}</span>
        <span class="token comment">## æŒ‡å®šæ³¨å†Œåˆ°nacosçš„å‰ç¼€</span>
        <span class="token key atrule">inetutils</span><span class="token punctuation">:</span>
            <span class="token key atrule">preferred-networks</span><span class="token punctuation">:</span> 192.168.10
</code></pre></div><h4 id="åœ¨-nacos-æ·»åŠ é…ç½®"><a href="#åœ¨-nacos-æ·»åŠ é…ç½®" class="header-anchor">#</a> åœ¨ Nacos æ·»åŠ é…ç½®</h4> <blockquote><p>é€šè¿‡é…ç½®åˆ—è¡¨å³ä¾§çš„ <code>+</code> æŒ‰é’®æ·»åŠ é…ç½®æ–‡ä»¶ï¼š</p></blockquote> <p><strong>é˜²å‘æŒ‡å—</strong></p> <ul><li>Data ID: æœåŠ¡å-ç¯å¢ƒå.yaml</li> <li>æœåŠ¡åå.yaml --&gt;  é»˜è®¤çš„ application.yml</li> <li>æœåŠ¡å-dev.yaml  --&gt;  application-dev.yml  |  å¼€å‘ç¯å¢ƒ</li> <li>æœåŠ¡å-test.yaml  --&gt;  application-test.yml    |  æµ‹è¯•ç¯å¢ƒ</li> <li>æœåŠ¡å-proc.yaml  --&gt;  application-proc.yml  |  ç”Ÿäº§ç¯å¢ƒ</li></ul> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/image-20220721183911016.png" alt="image-20220721183911016"></p> <p><code>Data ID</code> æ˜¯è¯¥é…ç½®æ–‡ä»¶åœ¨ Nacos ç³»ç»Ÿå†…çš„å”¯ä¸€æ ‡è¯†ã€‚</p> <p>åœ¨ Nacos Spring Cloud ä¸­ï¼ŒdataId çš„å®Œæ•´æ ¼å¼è¯­æ³•å¦‚ä¸‹ï¼š</p> <div class="language-markup extra-class"><pre class="language-markup"><code>${prefix}-${spring.profile.active}.${file-extension}
</code></pre></div><ul><li><p><strong>prefix</strong> çš„å€¼é»˜è®¤ä¸ <code>spring.application.name</code>  ï¼ˆå³æœåŠ¡åï¼‰çš„å€¼ç›¸åŒã€‚ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®é¡¹ <strong>spring.cloud.nacos.config.prefix</strong> æ¥æ‰‹åŠ¨é…ç½®ï¼ŒæŒ‡å®šä¸€ä¸ªä¸ spring.application.name ä¸ä¸€æ ·çš„å€¼ï¼Œä¸è¿‡ä¸€èˆ¬ä¸ä¼šåŠ¨å®ƒã€‚</p></li> <li><p><strong>spring.profile.active</strong> å³ä¸ºå½“å‰ç¯å¢ƒå¯¹åº”çš„ profile ï¼Œå¦‚ï¼š<code>xxx-service-dev.yml</code> ä¸­çš„ <code>dev</code> å°±æ˜¯æŒ‡å¼€å‘ç¯å¢ƒã€‚</p> <p>**æ³¨æ„ï¼š**å½“ spring.profile.active ä¸ºç©ºæ—¶ï¼Œå¯¹åº”çš„ç¯å¢ƒå®šä¹‰å­—ç¬¦éƒ¨åˆ†å°†ä¸å­˜åœ¨ï¼Œå³ä¸º <strong>xxx-service.yml</strong>ï¼Œè€Œä¸æ˜¯ <em>xxx-service-.yml</em> ã€‚</p></li> <li><p><strong>file-exetension</strong> ä¸ºé…ç½®å†…å®¹çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥é€šè¿‡é…ç½®é¡¹ <strong>spring.cloud.nacos.config.file-extension</strong> æ¥é…ç½®ã€‚</p> <p>æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ã€<strong>æ˜¯ yaml ç±»å‹ï¼Œä¸æ˜¯ yml</strong>ã€ã€‚è™½ç„¶äºŒè€…æ˜¯ä¸€ä¸ªæ„æ€ï¼Œä½†æ˜¯ã€<strong>nacos åªè®¤ yaml</strong>ã€ã€‚</p></li></ul> <p><code>Group</code> çš„å€¼åŒ spring.cloud.nacos.config.group çš„é…ç½®ï¼Œç•Œé¢å¡«å†™çš„å†…å®¹ä¸é¡¹ç›®ä¸­çš„é…ç½®äºŒè€…ã€<strong>ä¸€å®šè¦ç»Ÿä¸€</strong>ã€ï¼Œå¦åˆ™æ— æ³•æ­£ç¡®è¯»å–é…ç½®ï¼ŒGroup èµ·åˆ°é…ç½®ã€éš”ç¦»ã€çš„ä½œç”¨ã€‚</p> <p><strong>æ•°æ®åº“ åŸºæœ¬é…ç½®</strong></p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
        <span class="token key atrule">hikari</span><span class="token punctuation">:</span>
            <span class="token key atrule">idle-timeout</span><span class="token punctuation">:</span> <span class="token number">60000</span>
            <span class="token key atrule">maximum-pool-size</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">minimum-idle</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">username</span><span class="token punctuation">:</span> root
        <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
        <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/licaimoney<span class="token punctuation">?</span>serverTimezone=UTC
</code></pre></div><h3 id="å¾®æœåŠ¡-group-åˆ†ç»„"><a href="#å¾®æœåŠ¡-group-åˆ†ç»„" class="header-anchor">#</a> å¾®æœåŠ¡ group åˆ†ç»„</h3> <p>Nacos çš„å¾®æœåŠ¡åˆ†ç»„æ¦‚å¿µï¼Œæœ‰ä¸¤å±‚å«ä¹‰ï¼š</p> <ul><li>ä¸åŒåˆ†ç»„çš„å¾®æœåŠ¡ï¼Œå½¼æ­¤ä¹‹é—´ä¸èƒ½å‘ç°å¯¹æ–¹ï¼Œä¹Ÿå°±ä¸èƒ½è¿›è¡Œè¿œç¨‹æœåŠ¡è°ƒç”¨ã€‚é€»è¾‘ä¸Šï¼Œä¸åŒçš„åˆ†ç»„æ„å‘³ç€è¿™æ˜¯ä¸¤ä¸ªä¸åŒçš„ç‹¬ç«‹é¡¹ç›®ã€‚å³ï¼Œä½ ï¼ˆå¾®æœåŠ¡ï¼‰ä»é…ç½®ä¸­æ‹‰å–åˆ°çš„æ³¨å†Œè¡¨åªæœ‰å¯èƒ½æ˜¯ä½ æ‰€åœ¨ç»„çš„æ³¨å†Œè¡¨ã€‚</li> <li>å°†å¾®æœåŠ¡åˆ†ç»„ï¼Œæ–¹ä¾¿æˆ‘ä»¬æŸ¥çœ‹ï¼Œä»¥åŠæ–¹ä¾¿é…ç½®ç®¡ç†åˆ†ç±»ã€‚</li></ul> <p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å±æ€§å¯¹å¾®æœåŠ¡æ‰€å±åˆ†ç»„è¿›è¡Œé…ç½®ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span> 
        <span class="token key atrule">group</span><span class="token punctuation">:</span> ç»„å
</code></pre></div><p>ç”±äºå¤šä¸ªé¡¹ç›®å¯èƒ½ã€å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ª nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œ<code>group</code> å°±æ˜¯åŒºåˆ†ä½ æˆ‘çš„æ ‡è¯†ï¼Œæ¯ä¸ªå¾®æœåŠ¡ä» nacos ä¸Šæ‹‰å–çš„åªæœ‰æœ¬ç»„çš„æ³¨å†Œè¡¨ã€‚ å¦‚æœå¾®æœåŠ¡æ²¡æœ‰æŒ‡å®šç»„ï¼Œé»˜è®¤åˆ†ç»„æ˜¯ default_group</p> <h3 id="éªŒè¯å’ŒåŠ¨æ€åˆ·æ–°"><a href="#éªŒè¯å’ŒåŠ¨æ€åˆ·æ–°" class="header-anchor">#</a> éªŒè¯å’ŒåŠ¨æ€åˆ·æ–°</h3> <blockquote><p>åœ¨ è¡¨ç°å±‚ æœ‰è°ƒç”¨é…ç½®æ–‡ä»¶çš„æ•°æ®æ—¶ åŠ ä¸Š -  @RefreshScope  -  å¯è¿›è¡Œæ—¢æ—¶åˆ·æ–°</p></blockquote> <p>æ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡ŒéªŒè¯ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;${xxx.yyy.zzz}&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> zzz<span class="token punctuation">;</span>

<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/demo&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> username<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>å¦‚æœæƒ³è¦å®ç°åŠ¨æ€åˆ·æ–°åŠŸèƒ½ï¼Œé‚£ä¹ˆåœ¨ @Value æ‰€åœ¨çš„ @Componentï¼ˆ@Controllerã€@Serviceã€@Repositoryï¼‰ä¸ŠåŠ ä¸Š <strong>@RefreshScope</strong> å³å¯å®ç°åŠ¨æ€åˆ·æ–°ã€‚</p> <h3 id="nacos-çš„æ•°æ®å­˜å‚¨"><a href="#nacos-çš„æ•°æ®å­˜å‚¨" class="header-anchor">#</a> Nacos çš„æ•°æ®å­˜å‚¨</h3> <h4 id="windos-æ•°æ®åº“å‚¨å­˜ä¿®æ”¹"><a href="#windos-æ•°æ®åº“å‚¨å­˜ä¿®æ”¹" class="header-anchor">#</a> windos æ•°æ®åº“å‚¨å­˜ä¿®æ”¹</h4> <p>Nacos çš„æ•°æ®æ˜¯å­˜å‚¨åœ¨å®ƒè‡ªå¸¦çš„å†…åµŒ derby æ•°æ®åº“ä¸­çš„ï¼Œæ•°æ®æ–‡ä»¶å°±åœ¨ Nacos çš„è§£å‹ç›®å½•ä¸‹çš„ <code>data</code> æ–‡ä»¶å¤¹ä¸­ã€‚</p> <p>ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®ï¼Œè®© Nacos å°†å®ƒçš„æ•°æ®å­˜å‚¨åœ¨ä½ æŒ‡å®šçš„ mysql æ•°æ®åº“ä¸­ã€‚</p> <ul><li>Nacos åœ¨å®ƒçš„ <code>conf</code> ç›®å½•ä¸‹å·²ç»ä¸ºä½ å‡†å¤‡å¥½äº†å»ºè¡¨è„šæœ¬ï¼š<code>nacos-mysql.sql</code> ã€‚ä¸è¿‡è„šæœ¬ä¸­æ²¡æœ‰å»ºåº“è¯­å¥ï¼Œä¸ºäº†åç»­é…ç½®ç®€å•èµ·è§ï¼Œå»ºè®®åˆ›å»ºçš„åº“å‘½åä¸º nacos ã€‚</li></ul> <ul><li>åˆ›å»ºä¸€ä¸ªnacosæ•°æ®åº“ï¼Œç„¶ååœ¨nacosçš„binç›®å½•ä¸‹æ‰¾åˆ°nacos-mysql.sqlæ–‡ä»¶ï¼ŒæŠŠè¯¥æ–‡ä»¶çš„å»ºè¡¨è¯­å¥æ‹·è´mysqlå®¢æˆ·ç«¯ä¸‹æ‰§è¡Œï¼Œæ³¨æ„è¦ä½¿ç”¨ä½ åˆšæ‰åˆ›å»ºçš„nacosæ•°æ®åº“ä¸‹</li></ul> <div class="language-mysql extra-class"><pre class="language-text"><code>create database nacos 
  DEFAULT CHARACTER SET utf8mb4 -- ä¹±ç é—®é¢˜
  DEFAULT COLLATE utf8mb4_bin -- è‹±æ–‡å¤§å°å†™ä¸æ•æ„Ÿé—®é¢˜
;
</code></pre></div><ul><li>åœ¨ conf æ–‡ä»¶å¤¹ä¸‹çš„ <code>application.properties</code> é…ç½®æ–‡ä»¶ã€‚ä» 31 è¡Œå¼€å§‹çš„ä¸€æ®µé…ç½®å°±æ˜¯æ•°æ®åº“è¿æ¥ç›¸å…³é…ç½®ã€‚æŠŠå¦‚ä¸‹è¡Œæ•°å‰é¢çš„æ³¨é‡Šå»æ‰</li></ul> <div class="language-mysql extra-class"><pre class="language-text"><code>spring.datasource.platform=mysql

#### Count of DB:
db.num=1

#### Connect URL of DB:
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC
db.user.0=root
db.password.0=root
</code></pre></div><p>ä¿®æ”¹å®Œ <code>application.properties</code> é…ç½®æ–‡ä»¶ä¹‹åï¼Œé‡å¯ Nacosï¼ŒNacos é‡æ–°ç¼–ç¨‹äº†ä¸€ä¸ªã€å¹²å‡€ã€çš„ç¯å¢ƒã€‚</p> <p><strong>æµ‹è¯•ï¼š</strong></p> <p>ç™»é™†localhostï¼š8848/nacosï¼Œåœ¨é…ç½®ä¸­å¿ƒä¸Šæ–°å»ºä¸€ä¸ªé…ç½®ï¼Œå¦‚ï¼šspring-service-provider-dev.yamlï¼Œå‘ç°è¿™ä¸ªé…ç½®ä¿å­˜åˆ°äº†æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„nacosæ•°æ®åº“é‡Œé¢</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/image-20220721194326682.png" alt="image-20220721194326682"></p> <h4 id="liunx-ç³»ç»Ÿ-ä¿®æ”¹"><a href="#liunx-ç³»ç»Ÿ-ä¿®æ”¹" class="header-anchor">#</a> Liunx ç³»ç»Ÿ ä¿®æ”¹</h4> <blockquote><p>é•œåƒå®¹å™¨:  docker-compose.yml</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">mysql5.7</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">5.7</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> mysql57
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MYSQL_ROOT_PASSWORD</span><span class="token punctuation">:</span> root
      <span class="token key atrule">MYSQL_DATABASE</span><span class="token punctuation">:</span> nacos
      <span class="token key atrule">MYSQL_USER</span><span class="token punctuation">:</span> root
      <span class="token key atrule">MYSQL_PASSWORD</span><span class="token punctuation">:</span> root
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3306<span class="token punctuation">:</span><span class="token number">3306</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span> 
      <span class="token punctuation">-</span> ./docker/mysql/<span class="token punctuation">:</span>/var/lib/mysql/
      <span class="token punctuation">-</span> ./docker/conf/<span class="token punctuation">:</span>/etc/mysql/
  <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nacos/nacos<span class="token punctuation">-</span>server<span class="token punctuation">:</span>1.4.1
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nacos
    <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mysql5.7
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> ./docker/nacos/standalone<span class="token punctuation">-</span>logs/<span class="token punctuation">:</span>/home/nacos/logs
      <span class="token punctuation">-</span> ./docker/nacos/plugins/<span class="token punctuation">:</span>/home/nacos/plugins
      <span class="token punctuation">-</span> ./docker/nacos/conf/application.properties<span class="token punctuation">:</span>/home/nacos/conf/application.properties
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">PREFER_HOST_MODE</span><span class="token punctuation">:</span> hostname <span class="token comment">#å¦‚æœæ”¯æŒä¸»æœºåå¯ä»¥ä½¿ç”¨hostname,å¦åˆ™ä½¿ç”¨ipï¼Œé»˜è®¤ä¹Ÿæ˜¯ip</span>
      <span class="token key atrule">SPRING_DATASOURCE_PLATFORM</span><span class="token punctuation">:</span> mysql <span class="token comment">#æ•°æ®æºå¹³å° ä»…æ”¯æŒmysqlæˆ–ä¸ä¿å­˜empty</span>
      <span class="token key atrule">MODE</span><span class="token punctuation">:</span> standalone
      <span class="token key atrule">MYSQL_SERVICE_HOST</span><span class="token punctuation">:</span> mysql5.7
      <span class="token key atrule">MYSQL_SERVICE_DB_NAME</span><span class="token punctuation">:</span> nacos
      <span class="token key atrule">MYSQL_SERVICE_PORT</span><span class="token punctuation">:</span> <span class="token number">3306</span>
      <span class="token key atrule">MYSQL_SERVICE_USER</span><span class="token punctuation">:</span> root
      <span class="token key atrule">MYSQL_SERVICE_PASSWORD</span><span class="token punctuation">:</span> root
      <span class="token key atrule">NACOS_APPLICATION_PORT</span><span class="token punctuation">:</span> <span class="token number">9999</span>
      <span class="token key atrule">JVM_XMS</span><span class="token punctuation">:</span> 512m
      <span class="token key atrule">JVM_MMS</span><span class="token punctuation">:</span> 320m
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;9999:9999&quot;</span>
</code></pre></div><h3 id="nacos-é›†ç¾¤é…ç½®"><a href="#nacos-é›†ç¾¤é…ç½®" class="header-anchor">#</a> nacos é›†ç¾¤é…ç½®</h3> <p>å®˜ç½‘ï¼šhttps://nacos.io/zh-cn/ ï¼Œç‚¹å‡»æ‰‹å†Œæ‰¾åˆ°è¿ç»´ï¼Œæ‹·è´cluster.conf.exampleæ–‡ä»¶ï¼Œå¹¶æ”¹åä¸ºcluster.conf</p> <div class="language- extra-class"><pre class="language-text"><code>127.0.0.1:8848
127.0.0.1:8849
127.0.0.1:8850
</code></pre></div><p>ç›´æ¥åŒå‡»å¯åŠ¨å¯åŠ¨è„šæœ¬</p> <p>å¾®æœåŠ¡é…ç½®ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>service<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> public
        <span class="token key atrule">password</span><span class="token punctuation">:</span> nacos
        <span class="token key atrule">username</span><span class="token punctuation">:</span> nacos
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span><span class="token punctuation">,</span>localhost<span class="token punctuation">:</span><span class="token number">8849</span><span class="token punctuation">,</span>localhost<span class="token punctuation">:</span><span class="token number">8850</span>
</code></pre></div><h2 id="gateway-æœåŠ¡ç½‘å…³"><a href="#gateway-æœåŠ¡ç½‘å…³" class="header-anchor">#</a> Gateway æœåŠ¡ç½‘å…³</h2> <blockquote><p>Spring Cloud Gateway ä»‹ç»</p></blockquote> <p>Spring Cloud Gateway åŸºäº Spring Boot 2ï¼Œæ˜¯ Spring Cloud çš„å…¨æ–°é¡¹ç›®ã€‚Gateway æ—¨åœ¨æä¾›ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„é€”å¾„æ¥è½¬å‘è¯·æ±‚ï¼Œå¹¶ä¸ºå®ƒä»¬æä¾›æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚</p> <p>Spring Cloud Gateway ä¸­æœ€é‡è¦çš„å‡ ä¸ªæ¦‚å¿µï¼š</p> <ul><li>è·¯ç”± Routeï¼šè·¯ç”±æ˜¯ç½‘å…³æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯ç”±ä¸€ä¸ª ID ã€ä¸€ä¸ªç›®çš„ URL ã€ä¸€ç»„æ–­è¨€å·¥å‚å’Œä¸€ç»„ Filter ç»„æˆã€‚å¦‚æœè·¯ç”±æ–­è¨€ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„ URL å’Œé…ç½®çš„è·¯ç”±åŒ¹é…ã€‚</li> <li>æ–­è¨€ Predicateï¼šJava 8 ä¸­çš„æ–­è¨€å‡½æ•°ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°è¾“å…¥ç±»å‹æ˜¯ Spring 5.0 æ¡†æ¶ä¸­çš„ ServerWebExchange ã€‚Spring Cloud Gateway ä¸­çš„æ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é…æ¥è‡ª Http Request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰ã€‚</li> <li>è¿‡æ»¤å™¨ Filterï¼šä¸€ä¸ªæ ‡å‡†çš„ Spring Web Filterã€‚Spring Cloud Gateway ä¸­çš„ Filter åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šGateway Filter å’Œ Global Filterã€‚è¿‡æ»¤å™¨ Filter å°†ä¼šå¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œä¿®æ”¹å¤„ç†ã€‚</li></ul> <h3 id="gateway-ç½‘å…³åˆ›å»º"><a href="#gateway-ç½‘å…³åˆ›å»º" class="header-anchor">#</a> Gateway ç½‘å…³åˆ›å»º</h3> <p>æ³¨æ„:  æœªé…ç½® å¼€å¯è‡ªåŠ¨æ”¯æŒåˆ° Nacos æ³¨å†Œä¸­å¿ƒ åˆ™é»˜è®¤è‡ªåŠ¨æ³¨å†Œåˆ° 8848 ç«¯å£çš„æ³¨å†Œä¸­å¿ƒ</p> <h4 id="å¯¼å…¥ä¾èµ–"><a href="#å¯¼å…¥ä¾èµ–" class="header-anchor">#</a> å¯¼å…¥ä¾èµ–</h4> <blockquote><p><strong>æ³¨æ„</strong>ï¼šåœ¨åˆ›å»ºé¡¹ç›®æ˜¯ä¸è¦é€‰é”™ä¾èµ– å•çº¯é€‰æ‹© Gateway  | è€Œä¸æ˜¯ é‚£ä¸ªå«æœ‰ alibbçš„ä¾èµ–</p> <p>Gateway è‡ªå·±ä½¿ç”¨äº† netty å®ç°äº† Web æœåŠ¡ï¼Œæ­¤å¤„ã€<strong>ä¸éœ€è¦å¼•å…¥ Spring Web</strong>ã€ï¼Œå¦‚æœå¼•å…¥äº†ï¼Œåè€Œè¿˜ä¼šæŠ¥å†²çªé”™è¯¯ï¼Œæ— æ³•å¯åŠ¨ã€‚</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Gateway æœåŠ¡ç½‘å…³--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Nacos è‡ªåŠ¨æ³¨å†Œä¾èµ–--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="è·¯ç”±é…ç½®"><a href="#è·¯ç”±é…ç½®" class="header-anchor">#</a> è·¯ç”±é…ç½®</h4> <p><strong>æ–¹å¼ä¸€: å¯åŠ¨ç±» é…ç½®è·¯ç”±è½¬å‘ è¿›è¡Œbeanæ³¨å…¥ (ä¸å»ºè®®)</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// å¯åŠ¨ç±» è§£å†³ ä½¿ç”¨äº† mybatis-plus ä½†æ˜¯æ²¡é…ç½® æ•°æ®åº“ä¿¡æ¯åˆ™å¯åŠ¨æŠ¥é”™</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token comment">// å¯ç”¨ nacos çš„æœåŠ¡å‘ç°</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayServerApplication</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">GatewayServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * é…ç½®
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/**return builder.routes()
            .route(r -&gt; r
                .path(&quot;/jd&quot;)
                .uri(&quot;http://www.jd.com/&quot;)
                .id(&quot;jd_route&quot;)
            ).build();*/</span>
         <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PredicateSpec</span><span class="token punctuation">,</span> <span class="token class-name">Route<span class="token punctuation">.</span>AsyncBuilder</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Route<span class="token punctuation">.</span>AsyncBuilder</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">PredicateSpec</span> predicateSpec<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> predicateSpec<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span><span class="token string">&quot;/jd&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.jd.com/&quot;</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;jd_route&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>æ–¹å¼äºŒ: ä½¿ç”¨ yml è¿›è¡Œè·¯ç”±è½¬å‘é…ç½®</strong></p> <p><strong>é˜²å‘æŒ‡å—:</strong></p> <ul><li><p>routes å’Œ predicates ä¸ºå¤æ•°å¯ä»¥è¿›è¡Œå¤šç»„é…ç½® åœ¨é…ç½®å‰æ–¹å¸¦ä¸Š ä¸­åˆ’çº¿å³å¯ '  -  '</p></li> <li><p>routes :  è·¯ç”±è½¬å‘</p></li> <li><p>predicates :  æ–­è¨€å³æ¡ä»¶åˆ¤æ–­ å¯è¿›è¡Œå¤šç»„æ¡ä»¶åˆ¤æ–­ ä¸º  å…¨éƒ¨ä¸ºçœŸåˆ™æ‰§è¡Œè·¯ç”±è½¬å‘</p></li></ul> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
    <span class="token key atrule">application</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> Gateway
    <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
        <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
                <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
            <span class="token key atrule">routes</span><span class="token punctuation">:</span>
                <span class="token comment">## è·¯ç”± IDï¼Œå”¯ä¸€ å¯ä¸­æ–‡</span>
                <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> Nacos<span class="token punctuation">-</span>A<span class="token punctuation">-</span>å¾®æœåŠ¡
                  <span class="token comment">## uri: http://www.163.com è½¬å‘è·¯å¾„å†™æ­»</span>
                  <span class="token comment">## ä½¿ç”¨å¾®æœåŠ¡å å¯è¿›è¡Œè´Ÿè½½å‡è¡¡è°ƒç”¨å¾®æœåŠ¡é›†ç¾¤</span>
                  <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//Nacos<span class="token punctuation">-</span>A
                  <span class="token comment">## æ–­è¨€è§„åˆ™ å¦‚: è¯·æ±‚è·¯å¾„å‰ç¼€</span>
                  <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
                      <span class="token comment">## è¯·æ±‚è·¯å¾„å‰ç¼€ ä¸ä¼šæˆªæ‰å‰ç¼€</span>
                      <span class="token punctuation">-</span> Path=/wuzi/<span class="token important">**</span>

</code></pre></div><h4 id="gateway-è·¯ç”±è½¬å‘è¯¦è§£"><a href="#gateway-è·¯ç”±è½¬å‘è¯¦è§£" class="header-anchor">#</a> Gateway è·¯ç”±è½¬å‘è¯¦è§£</h4> <blockquote><p>Spring Cloud Gateway æ˜¯ç”±å¾ˆå¤šçš„è·¯ç”±æ–­è¨€å·¥å‚ç»„æˆã€‚</p></blockquote> <p>å½“ HTTP Request è¯·æ±‚è¿›å…¥ Spring Cloud Gateway çš„æ—¶å€™ï¼Œç½‘å…³ä¸­çš„è·¯ç”±æ–­è¨€å·¥å‚å°±ä¼šæ ¹æ®é…ç½®çš„è·¯ç”±è§„åˆ™ï¼Œå¯¹ HTTP Request è¯·æ±‚è¿›è¡Œæ–­è¨€åŒ¹é…ã€‚</p> <p><strong>åŒ¹é…æˆåŠŸåˆ™è¿›è¡Œä¸‹ä¸€æ­¥å¤„ç†ï¼Œå¦åˆ™ï¼Œæ–­è¨€å¤±è´¥ç›´æ¥è¿”å›é”™è¯¯ä¿¡æ¯ã€‚</strong></p> <p>æ—©æœŸçš„ Gateway æ–­è¨€çš„é…ç½®æ˜¯é€šè¿‡ä»£ç ä¸­çš„ @Bean è¿›è¡Œé…ç½®ï¼Œåæ¥æ‰æ¨å‡ºé…ç½®æ–‡ä»¶é…ç½®ã€‚</p> <h3 id="gateway-è·¯ç”±æ–­è¨€"><a href="#gateway-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Gateway  è·¯ç”±æ–­è¨€</h3> <p>è·¯ç”±æ–­è¨€çš„æ‰§è¡Œé¡ºåºæ˜¯æ ¹æ® å†™å…¥çš„é¡ºåºä¾æ¬¡å¾€ä¸‹æ‰§è¡Œ</p> <h4 id="path-è·¯ç”±æ–­è¨€"><a href="#path-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Path è·¯ç”±æ–­è¨€</h4> <blockquote><p><strong>Path æ–­è¨€ä¸ä¼šæ”¹å˜è¯·æ±‚çš„ URI ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¸­åªæœ‰ IPã€ç«¯å£éƒ¨åˆ†ä¼šè¢«ã€æ›¿æ¢ã€æ‰</strong></p> <p>è¯·æ±‚çš„è§¦å‘è·¯å¾„ä¸ä¼šè¢«æˆªå–æ‰ è¿™ä¸Zuulç½‘å…³æ­£å¥½ç›¸å</p></blockquote> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å¾®æœåŠ¡åç§°
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//www.163.com 
          <span class="token comment">## è¾“å…¥ /163 è·¯å¾„æ—¶ï¼ŒGateway å°†ä¼šå¯¼å‘åˆ° 163 ç½‘å€</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> Path=/163
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å¾®æœåŠ¡åç§°
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//å¾®æœåŠ¡åç§°
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/xxx/<span class="token important">**</span>     
</code></pre></div><h4 id="after-è·¯ç”±æ–­è¨€"><a href="#after-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> After è·¯ç”±æ–­è¨€</h4> <p>After è·¯ç”±æ–­è¨€ä¼šè¦æ±‚ä½ æä¾›ä¸€ä¸ª UTC æ ¼å¼çš„æ—¶é—´ï¼Œå½“ Gateway æ¥æ”¶åˆ°çš„è¯·æ±‚æ—¶é—´åœ¨é…ç½®çš„ UTC æ—¶é—´ä¹‹åï¼Œåˆ™ä¼šæˆåŠŸåŒ¹é…ï¼Œäºˆä»¥è½¬å‘ï¼Œå¦åˆ™ä¸æˆåŠŸã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ZonedDateTime</span> dateTime <span class="token operator">=</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">atZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">systemDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>dateTime<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.jd.com:80/&quot;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;jd_route&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ç­‰ä»·çš„ <strong>application.yml</strong> é…ç½®ï¼š</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å•†å“å¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//provider<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/users/<span class="token important">**</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å“ç‰Œå¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//www.jd.com
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>       <span class="token comment">#å“ç‰Œå¾®æœåŠ¡æœ‰2ä¸ªæ–­è¨€</span>
            <span class="token punctuation">-</span> Path=/xxx/<span class="token important">**</span>
            <span class="token punctuation">-</span> After=2022<span class="token punctuation">-</span>07<span class="token punctuation">-</span>21T15<span class="token punctuation">:</span>33<span class="token punctuation">:</span>11.009+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre></div><p>è¯´æ˜ï¼šå½“è¯·æ±‚/xxxåœ°å€æ—¶ï¼Œå¦‚æœå½“å‰ç³»ç»Ÿæ—¶é—´å†20227-21ä¹‹åï¼Œåˆ™ä¼šæˆåŠŸï¼Œå¦åˆ™å¤±è´¥</p> <p>UTCæ˜¯æ ¹æ®åŸå­é’Ÿæ¥è®¡ç®—æ—¶é—´ï¼Œè€ŒGMTæ˜¯æ ¹æ®åœ°çƒçš„è‡ªè½¬å’Œå…¬è½¬æ¥è®¡ç®—æ—¶é—´ã€‚UTCæ˜¯ç°åœ¨ç”¨çš„æ—¶é—´æ ‡å‡†ï¼ŒGMTæ˜¯è€çš„æ—¶é—´è®¡é‡æ ‡å‡†ã€‚UTCæ›´åŠ ç²¾ç¡®ï¼Œç”±äºç°åœ¨ä¸–ç•Œä¸Šæœ€ç²¾ç¡®çš„åŸå­é’Ÿ50äº¿å¹´æ‰ä¼šè¯¯å·®1ç§’ï¼Œå¯ä»¥è¯´éå¸¸ç²¾ç¡®ã€‚</p> <p>å¯¹äº UTC çš„æ—¶é—´æ ¼å¼ï¼Œä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ Java ä»£ç ç”Ÿæˆï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> datetime <span class="token operator">=</span> <span class="token class-name">ZonedDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minusHours</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>ISO_DATE_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//å½“å‰ç³»ç»Ÿæ—¶é—´ å‡å»ä¸€ä¸ªå°æ—¶</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>datetime<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="before-è·¯ç”±æ–­è¨€"><a href="#before-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Before è·¯ç”±æ–­è¨€</h4> <p>Before è·¯ç”±æ–­è¨€å’Œä¹‹å‰çš„ After è·¯ç”±æ–­è¨€ç±»ä¼¼ã€‚å®ƒä¼šå–ä¸€ä¸ª UTC æ—¶é—´æ ¼å¼çš„æ—¶é—´å‚æ•°ï¼Œå½“è¯·æ±‚è¿›æ¥çš„å½“å‰æ—¶é—´åœ¨é…ç½®çš„æ—¶é—´ä¹‹å‰ä¼šæˆåŠŸï¼ˆæ”¾è¡Œï¼‰ï¼Œå¦åˆ™ä¸èƒ½æˆåŠŸã€‚</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å“ç‰Œå¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//www.jd.com
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>       <span class="token comment">#å“ç‰Œå¾®æœåŠ¡æœ‰2ä¸ªæ–­è¨€</span>
            <span class="token punctuation">-</span> Path=/xxx/<span class="token important">**</span>
            <span class="token punctuation">-</span> Before=2022<span class="token punctuation">-</span>07<span class="token punctuation">-</span>21T15<span class="token punctuation">:</span>33<span class="token punctuation">:</span>11.009+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre></div><h4 id="between-è·¯ç”±æ–­è¨€"><a href="#between-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Between è·¯ç”±æ–­è¨€</h4> <p>è¿ä¸ªæ—¶é—´ä¹‹é—´ åˆ™æ–­è¨€æˆåŠŸ</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å“ç‰Œå¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//www.jd.com
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/xxx/<span class="token important">**</span>
            <span class="token punctuation">-</span> Between=2020<span class="token punctuation">-</span>07<span class="token punctuation">-</span>21T15<span class="token punctuation">:</span>33<span class="token punctuation">:</span>11.009+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span><span class="token punctuation">,</span>2022<span class="token punctuation">-</span>07<span class="token punctuation">-</span>21T15<span class="token punctuation">:</span>33<span class="token punctuation">:</span>11.009+08<span class="token punctuation">:</span>00<span class="token punctuation">[</span>Asia/Shanghai<span class="token punctuation">]</span>
</code></pre></div><h4 id="cookie-è·¯ç”±æ–­è¨€"><a href="#cookie-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Cookie è·¯ç”±æ–­è¨€</h4> <p>Cooke è·¯ç”±æ–­è¨€ä¼šå–ä¸¤ä¸ªå‚æ•°ï¼šHTTP è¯·æ±‚æ‰€æºå¸¦çš„ Cookie çš„ key å’Œ valueã€‚å½“è¯·æ±‚ä¸­æºå¸¦çš„ <strong>cookie</strong> å’Œ Cookie è·¯ç”±æ–­è¨€ä¸­é…ç½®çš„ <strong>cookie</strong> ä¸€è‡´æ—¶ï¼Œè·¯ç”±æ‰åŒ¹é…æˆåŠŸã€‚</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å“ç‰Œå¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//www.jd.com
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Cookie=username<span class="token punctuation">,</span> tom
            <span class="token punctuation">-</span> Path=/xxx/<span class="token important">**</span>
</code></pre></div><blockquote><p>è¯¥åŠŸèƒ½å¯ä»¥ä½¿ç”¨ Postman è¿›è¡Œæµ‹è¯•ã€‚åœ¨ postman ä¸­ä¸ºè¯·æ±‚æ·»åŠ æºå¸¦çš„ Cookie æœ‰ä¸¤ç§æ–¹å¼ã€‚</p> <ol><li>ç›´æ¥åœ¨ <strong>Headers</strong> ä¸­æ·»åŠ  Cookieå’Œ username=tom</li> <li>åœ¨ <code>Cookies</code> åŠŸèƒ½ä¸­ä½¿ç”¨ <code>Add Cookie</code> æ·»åŠ </li></ol></blockquote> <h4 id="header-è·¯ç”±æ–­è¨€"><a href="#header-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Header è·¯ç”±æ–­è¨€</h4> <p>Header è·¯ç”±æ–­è¨€ç”¨äºæ ¹æ® HTTP è¯·æ±‚çš„ header ä¸­æ˜¯å¦æºå¸¦æ‰€é…ç½®çš„ä¿¡æ¯ä¸å¦ï¼Œæ¥å†³å®šæ˜¯å¦é€šè¿‡æ–­è¨€ã€‚</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å•†å“å¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//provider<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Header=token<span class="token punctuation">,</span> tom
			<span class="token punctuation">-</span> Path=/xxx/<span class="token important">**</span> 
</code></pre></div><h4 id="method-è·¯ç”±æ–­è¨€"><a href="#method-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Method è·¯ç”±æ–­è¨€</h4> <p>Method è·¯ç”±æ–­è¨€ä¼šæ ¹æ®è·¯ç”±ä¿¡æ¯æ‰€é…ç½®çš„ method å¯¹è¯·æ±‚æ–¹å¼æ˜¯ GET æˆ–è€… POST ç­‰è¿›è¡Œæ–­è¨€åŒ¹é…ã€‚</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å•†å“å¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//provider<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Method=GET    <span class="token comment">#å¿…é¡»æ˜¯getè¯·æ±‚</span>
            <span class="token punctuation">-</span> Path=/users/<span class="token important">**</span> 
</code></pre></div><h4 id="query-è·¯ç”±æ–­è¨€"><a href="#query-è·¯ç”±æ–­è¨€" class="header-anchor">#</a> Query è·¯ç”±æ–­è¨€</h4> <p>Query æ–­è¨€ä¼šä»è¯·æ±‚ä¸­è·å–ä¸¤ä¸ªå‚æ•°ï¼Œå°†è¯·æ±‚å‚æ•°å’Œ Query æ–­è¨€ä¸­çš„é…ç½®è¿›è¡ŒåŒ¹é…ã€‚</p> <p>ä¾‹å¦‚ï¼Œ<em>http://localhost:9000/test?username=tom</em> ä¸­çš„ <em>username=tom</em> å’Œ <em>r.query(â€œusernameâ€, â€œtomâ€)</em> åŒ¹é…ã€‚</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å•†å“å¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//provider<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Query=username<span class="token punctuation">,</span> tom  <span class="token comment">#å¿…é¡»æºå¸¦è¯·æ±‚å‚æ•°usernameï¼Œè€Œä¸”å€¼å¿…é¡»æ˜¯tom,ä¸èƒ½æ˜¯å…¶å®ƒçš„å€¼</span>
            <span class="token punctuation">-</span> Path=/users/<span class="token important">**</span>  
</code></pre></div><h4 id="ç»„åˆä½¿ç”¨"><a href="#ç»„åˆä½¿ç”¨" class="header-anchor">#</a> ç»„åˆä½¿ç”¨</h4> <p>å„ç§ Predicates åŒæ—¶å­˜åœ¨äºåŒä¸€ä¸ªè·¯ç”±æ—¶ï¼Œè¯·æ±‚å¿…é¡»ã€<strong>åŒæ—¶æ»¡è¶³æ‰€æœ‰</strong>ã€çš„æ¡ä»¶æ‰è¢«è¿™ä¸ªè·¯ç”±åŒ¹é…ã€‚</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å•†å“å¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//provider<span class="token punctuation">-</span>service
          <span class="token key atrule">order</span><span class="token punctuation">:</span> <span class="token number">0</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span>
            <span class="token punctuation">-</span> Method=GET
            <span class="token punctuation">-</span> Header=X<span class="token punctuation">-</span>Request<span class="token punctuation">-</span>Id<span class="token punctuation">,</span> \d+
            <span class="token punctuation">-</span> Query=name<span class="token punctuation">,</span> zhangsan.    <span class="token comment">#è¯·æ±‚å‚æ•°å¿…é¡»æ˜¯name=zhangsan.  â€ç‚¹â€œ è¡¨ç¤ºåŒ¹é…ä»»åŠ¡ä¸€ä¸ªå­—ç¬¦</span>
</code></pre></div><p><strong>orderä»£è¡¨çš„ä¼˜å…ˆçº§æ˜¯ä»å°å¾€å¤§æ’åºçš„ï¼Œå³æ•°å€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</strong></p> <h3 id="è‡ªå®šä¹‰è·¯ç”±æ–­è¨€"><a href="#è‡ªå®šä¹‰è·¯ç”±æ–­è¨€" class="header-anchor">#</a> è‡ªå®šä¹‰è·¯ç”±æ–­è¨€</h3> <p>è‡ªå®šä¹‰è·¯ç”±æ–­è¨€ï¼Œå°±æ˜¯å…è®¸ä½ è‡ªå®šä¹‰è·¯ç”±çš„è¯„åˆ¤è§„åˆ™ã€‚è‡ªå®šä¹‰è·¯ç”±æ–­è¨€æœ‰å‡ ä¸ªå‰æè¦æ±‚ï¼š</p> <ol><li>è‡ªå®šä¹‰çš„è·¯ç”±æ–­è¨€è¦ç»§æ‰¿ <strong>AbstractRoutePredicateFactory</strong> ç±»ã€‚</li> <li>è‡ªå®šä¹‰çš„è·¯ç”±æ–­è¨€æŒ‰æƒ¯ä¾‹å«ä½œï¼š<strong>XxxRoutePredicateFactory</strong> ï¼Œè¿™æ ·ï¼Œåœ¨æœªæ¥ä½¿ç”¨æ—¶å¯ç›´æ¥ä½¿ç”¨ <strong>Xxx</strong> ä½œä¸ºå…¶åå­—å¼•ç”¨ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥é€šè¿‡ <strong>name()</strong> æ–¹æ³•è‡ªå®šä¹‰åå­—ï¼Œåç»­ä½¿ç”¨æ—¶ï¼Œå°±ä½¿ç”¨ name() è¿”å›çš„å­—ç¬¦ä¸²ã€‚</li> <li>æ¯ä¸ª RoutePredicateFactory éƒ½ä¼šæœ‰ä¸€ä¸ª <strong>Config</strong> ç±»ä¸ä¹‹å¯¹åº”ï¼Œç”±äºå®ƒä»¬å¸¸è§æ˜¯ 1:1 çš„å…³ç³»ï¼Œæ‰€ä»¥ï¼Œé€šå¸¸ä¼šå°† Config ç±»å®šä¹‰æˆ RoutePredicateFactory å†…éƒ¨ç±»çš„å½¢å¼ã€‚</li></ol> <h4 id="è‡ªå®šä¹‰è·¯ç”±æ–­è¨€ç±»"><a href="#è‡ªå®šä¹‰è·¯ç”±æ–­è¨€ç±»" class="header-anchor">#</a> <strong>è‡ªå®šä¹‰è·¯ç”±æ–­è¨€ç±»</strong></h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>predicates</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>predicate<span class="token punctuation">.</span></span><span class="token class-name">AbstractRoutePredicateFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">MultiValueMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Predicate</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰æ–­è¨€ åˆ›å»ºConfigå†…éƒ¨ç±» ç„¶åå¿…é¡»ç»§æ‰¿AbstractRoutePredicateFactory&lt;ç±»å.Config&gt;</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> apaiRoutePredicateFactory <span class="token keyword">extends</span> <span class="token class-name">AbstractRoutePredicateFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">apaiRoutePredicateFactory<span class="token punctuation">.</span></span>Config</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token function">apaiRoutePredicateFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// å¦‚æœç±»åä¸è§„èŒƒ åˆ™è¦åœ¨è¯¥æ–¹æ³•å®šä¹‰é…ç½®è°ƒç”¨å å¦åˆ™å¯çœç•¥</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;é…ç½®è°ƒç”¨å&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">&gt;</span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è¿”å› åˆ›å»ºçš„å®ä¾‹</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Predicate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å†…éƒ¨ç±» å†™å…¥å†…å®¹</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> serverWebExchange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">String</span> path <span class="token operator">=</span> serverWebExchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è·å–è¯·æ±‚çš„å‚æ•°å†…å®¹</span>
                <span class="token class-name">MultiValueMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queryParams <span class="token operator">=</span> serverWebExchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// æ ¹æ® å‚æ•°åç§°è·å–å‚æ•°å†…å®¹ å› ä¸ºå‚æ•°å€¼å¯èƒ½æ˜¯å¤šä¸ª ä½¿ç”¨ç”¨listæ¥æ”¶</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queryNames <span class="token operator">=</span> queryParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> queryPass <span class="token operator">=</span> queryParams<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è°ƒç”¨ Configç±»çš„å±æ€§</span>
                <span class="token class-name">String</span> name <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">String</span> pass <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// è¿›è¡Œåˆ¤æ–­è¾“å‡º å¸ƒå°”å€¼ åœ¨é…ç½®ä¸­è°ƒç”¨ çœŸ-è½¬å‘ å‡-ä¸è½¬å‘</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>queryNames<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> pass<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>queryPass<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç®€å•æƒ…å†µä¸‹ï¼ŒConfig ç±»é‡Œå¯ä»¥ä»€ä¹ˆéƒ½æ²¡æœ‰</span>
    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
        <span class="token comment">// é¢å¯ä»¥è¿›è¡Œè®¾ç½® å±æ€§å€¼å…± GatewayFilter è°ƒç”¨  åœ¨é…ç½®æ–‡ä»¶é‡Œè¿›è¡Œèµ‹å€¼</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="è‡ªå®šä¹‰æ–­è¨€-é…ç½®"><a href="#è‡ªå®šä¹‰æ–­è¨€-é…ç½®" class="header-anchor">#</a> <strong>è‡ªå®šä¹‰æ–­è¨€ é…ç½®</strong></h4> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8084</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token comment">## è·¯ç”± IDï¼Œå”¯ä¸€ å¯ä¸­æ–‡</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> Nacos<span class="token punctuation">-</span>A<span class="token punctuation">-</span>å¾®æœåŠ¡
          <span class="token comment">## uri: http://www.163.com è½¬å‘è·¯å¾„å†™æ­»</span>
          <span class="token comment">## ä½¿ç”¨å¾®æœåŠ¡å å¯è¿›è¡Œè´Ÿè½½å‡è¡¡è°ƒç”¨å¾®æœåŠ¡é›†ç¾¤</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//Nacos<span class="token punctuation">-</span>A
          <span class="token comment">## æ–­è¨€è§„åˆ™ å¦‚: è¯·æ±‚è·¯å¾„å‰ç¼€</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment">## è¯·æ±‚è·¯å¾„å‰ç¼€ ä¸ä¼šæˆªæ‰å‰ç¼€</span>
            <span class="token punctuation">-</span> Path=/wuzi/<span class="token important">**</span>
            <span class="token comment">## è°ƒç”¨è‡ªå®šä¹‰æ–­è¨€ - name: è‡ªå®šä¹‰çš„æ–­è¨€å</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> apai
              <span class="token comment">## æ ¹æ®è‡ªå®šä¹‰çš„æ–­è¨€ç±»çš„Configç±»çš„å±æ€§èµ‹å€¼</span>
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> www
                <span class="token key atrule">password</span><span class="token punctuation">:</span> www
</code></pre></div><h3 id="å†…ç½®-filter-è¿‡æ»¤å™¨"><a href="#å†…ç½®-filter-è¿‡æ»¤å™¨" class="header-anchor">#</a> å†…ç½® Filter è¿‡æ»¤å™¨</h3> <p>Spring Cloud Gateway ä¸­å†…ç½®äº†å¾ˆå¤šçš„è¿‡æ»¤å™¨ï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€æ±‚å®šåˆ¶å¹¶æ·»åŠ è‡ªå·±çš„è·¯ç”±è¿‡æ»¤å™¨ã€‚</p> <p>è·¯ç”±è¿‡æ»¤å™¨å…è®¸ä»¥æŸç§æ–¹å¼ä¿®æ”¹è¯·æ±‚è¿›æ¥çš„ HTTP è¯·æ±‚æˆ–è¿”å›çš„ HTTP å“åº”ã€‚</p> <h4 id="addrequestheader-è¿‡æ»¤å™¨"><a href="#addrequestheader-è¿‡æ»¤å™¨" class="header-anchor">#</a> AddRequestHeader è¿‡æ»¤å™¨</h4> <blockquote><p>AddRequestHeader è¿‡æ»¤å™¨ç”¨äºå¯¹åŒ¹é…ä¸Šçš„è¯·æ±‚åŠ ä¸ŠæŒ‡å®šçš„ header ã€‚</p></blockquote> <p>åœ¨å¦ä¸€ä¸ªç«¯å£ï¼ˆä¾‹å¦‚ 8081ï¼‰è¿è¡Œä¸€ä¸ªæœåŠ¡æä¾›è€…é¡¹ç›®ï¼Œå…¶ä¸­ä»£ç è´Ÿè´£ä»è¯·æ±‚çš„è¯·æ±‚å¤´ä¸­è·å–æ•°æ®ï¼Œç±»ä¼¼å¦‚ä¸‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/user/test&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">header</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestHeader</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;jwtToken&quot;</span><span class="token punctuation">,</span> required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> token<span class="token punctuation">,</span><span class="token class-name">String</span> name<span class="token punctuation">,</span><span class="token class-name">String</span> pass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> username <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">&quot;null&quot;</span> <span class="token operator">:</span> username<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>.yml é…ç½®æ–‡ä»¶é…ç½®</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> route1
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>8081/    <span class="token comment">##uri: lb://eureka-consumer</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span>  
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> AddRequestHeader=jwtToken<span class="token punctuation">,</span> aaaaaaaaaaaa
</code></pre></div><p>å½“æˆ‘ä»¬åœ¨æµè§ˆå™¨è¾“å…¥http://localhost:9000/user/test?username=zhangsan&amp;password=111æ—¶ï¼Œé¦–å…ˆç½‘å…³èƒ½åŒ¹é…åˆ°è¯·æ±‚urlï¼Œç„¶åè½¬å‘ç»™8081ï¼Œå…¶å®æ˜¯æŠŠIPå’Œç«¯å£æ›¿æ¢æ‰ï¼Œåˆ™è¯·æ±‚urlä¸ºhttp://localhost:8081/user/test?username=zhangsan&amp;password=111ï¼Œåœ¨è¯·æ±‚8081ä¹‹å‰ï¼Œè¿‡æ»¤å™¨å¸®æˆ‘ä»¬åœ¨è¯·æ±‚å¤´æ·»åŠ  jwtToken=aaaaaaaaaaaaï¼Œ</p> <h4 id="stripprefix-è¿‡æ»¤-å»æ‰å‰ç¼€"><a href="#stripprefix-è¿‡æ»¤-å»æ‰å‰ç¼€" class="header-anchor">#</a> StripPrefix è¿‡æ»¤ | å»æ‰å‰ç¼€</h4> <blockquote><p>å»é™¤è¯·æ±‚è·¯å¾„å‰ç¼€</p></blockquote> <p><strong>StripPrefixGatewayFilterFactory</strong> æ˜¯ä¸€ä¸ªé’ˆå¯¹è¯·æ±‚ url è¿›è¡Œå¤„ç†çš„ filter å·¥å‚ï¼Œç”¨äºå»é™¤å‰ç¼€ã€‚ä½¿ç”¨æ•°å­—è¡¨ç¤ºè¦æˆªæ–­çš„è·¯å¾„çš„æ•°é‡ã€‚</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> authentication_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">8081</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/user/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1
</code></pre></div><p>8081æœåŠ¡è¯·æ±‚æ–¹æ³•å¦‚ä¸‹</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">xxx</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>è¯·æ±‚urlï¼šhttp://localhost:9000/user/test</p> <p>åˆ™ç½‘å…³è½¬å‘åˆ°8081æ—¶ï¼Œå»æ‰ä¸€ä¸ªå‰ç¼€ï¼ŒçœŸå®urlä¸º:http://localhost:8081/test</p> <h4 id="rewritepath-è¿‡æ»¤å™¨"><a href="#rewritepath-è¿‡æ»¤å™¨" class="header-anchor">#</a> RewritePath è¿‡æ»¤å™¨</h4> <p>RewritePath è¿‡æ»¤å™¨å¯ä»¥é‡å†™ URIï¼Œå»æ‰ URI ä¸­çš„å‰ç¼€ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢å°±æ˜¯å»æ‰æ‰€æœ‰ URI ä¸­çš„ <strong>/xxx/yyy/zzz</strong> éƒ¨åˆ†ï¼Œåªç•™ä¹‹åçš„å†…å®¹ï¼Œå†è¿›è¡Œè½¬å‘ã€‚</p> <p>ä»¥ä¸Š Java ä»£ç é…ç½®ç­‰åŒäº .yml é…ç½®ï¼š</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> 163_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8081</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/xxx/yyy/zzz/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> RewritePath=/xxx/yyy/zzz/(<span class="token punctuation">?</span>&lt;segment<span class="token punctuation">&gt;</span>.<span class="token important">*)</span><span class="token punctuation">,</span> /$\<span class="token punctuation">{</span>segment<span class="token punctuation">}</span>
</code></pre></div><p>å¯¹äºè¯·æ±‚è·¯å¾„ /xxx/yyy/zzz/hello ï¼Œå½“å‰çš„é…ç½®åœ¨è¯·æ±‚åˆ°åˆ°è¾¾å‰ä¼šè¢«é‡å†™ä¸º /hello ï¼Œ</p> <ul><li><p>å‘½ååˆ†ç»„ï¼š<code>(?&lt;name&gt;æ­£åˆ™è¡¨è¾¾å¼)</code></p> <p>ä¸æ™®é€šåˆ†ç»„ä¸€æ ·çš„åŠŸèƒ½ï¼Œå¹¶ä¸”å°†åŒ¹é…çš„å­å­—ç¬¦ä¸²æ•è·åˆ°ä¸€ä¸ªç»„åç§°æˆ–ç¼–å·åç§°ä¸­ã€‚åœ¨è·å¾—åŒ¹é…ç»“æœæ—¶ï¼Œå¯é€šè¿‡åˆ†ç»„åè¿›è¡Œè·å–ã€‚</p> <p><code>(?&lt;segment&gt;.*)</code>ï¼šåŒ¹é… 0 ä¸ªæˆ–å¤šä¸ªä»»æ„å­—ç¬¦ï¼Œå¹¶å°†åŒ¹é…çš„ç»“æœæ•è·åˆ°åç§°ä¸º segment çš„ç»„ä¸­ã€‚</p></li> <li><p>å¼•ç”¨æ•è·æ–‡æœ¬ï¼š<code>${name}</code></p> <p>å°†åç§°ä¸º name çš„å‘½ååˆ†ç»„æ‰€åŒ¹é…åˆ°çš„æ–‡æœ¬å†…å®¹æ›¿æ¢åˆ°æ­¤å¤„ã€‚</p> <p><code>$\{segment}</code>ï¼šå°†å‰é¢æ•è·åˆ° segment ä¸­çš„æ–‡æœ¬ç½®æ¢åˆ°æ­¤å¤„ï¼Œæ³¨æ„ï¼Œ\ çš„å‡ºç°æ˜¯ç”±äºé¿å… YAML è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå˜é‡è€Œä½¿ç”¨çš„è½¬ä¹‰å­—ç¬¦ã€‚</p> <p>å¦‚ï¼šhttp://localhost:9000/xxx/yyy/zzz/test   åˆ™segmentåŒ¹é…åˆ°çš„å†…å®¹ä¸ºtest</p> <p>æœ€ç»ˆè½¬å‘åˆ° http://localhost:8080/test</p></li></ul> <h3 id="è‡ªå®šä¹‰è·¯ç”±å±€éƒ¨-filter"><a href="#è‡ªå®šä¹‰è·¯ç”±å±€éƒ¨-filter" class="header-anchor">#</a> è‡ªå®šä¹‰è·¯ç”±å±€éƒ¨ Filter</h3> <blockquote><p>å’Œè‡ªå®šä¹‰è·¯ç”±æ–­è¨€ä¸€æ ·ï¼Œè‡ªå®šä¹‰è·¯ç”±æœ‰å‡ ä¸ªå‰æè¦æ±‚ï¼š</p></blockquote> <ol><li>è‡ªå®šä¹‰çš„è·¯ç”±è¿‡æ»¤å™¨è¦ç»§æ‰¿ <strong>AbstractGatewayFilterFactory</strong> ã€‚</li> <li>è‡ªå®šä¹‰çš„è·¯ç”±è¿‡æ»¤å™¨æŒ‰æƒ¯ä¾‹å«åšï¼š<strong>XxxGatewayFilterFactory</strong> ï¼Œè¿™æ ·ï¼Œåœ¨æœªæ¥ä½¿ç”¨æ—¶å¯ä»¥ä½¿ç”¨ <strong>Xxx</strong> ä½œä¸ºå…¶åå­—å¼•ç”¨ã€‚å½“ç„¶ï¼Œä½ å¯ä»¥é€šè¿‡ <strong>name()</strong> æ–¹æ³•è‡ªå®šä¹‰åå­—ï¼Œ</li></ol> <blockquote><p>æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰è‡ªå®šä¹‰åå­—ï¼Œåˆ™è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„åå­—å¿…é¡»å«  åå­—+GatewayFilterFactory</p></blockquote> <p>3.æ¯ä¸ª GatewayFilterFactory éƒ½ä¼šæœ‰ä¸€ä¸ª <strong>Config</strong> ç±»ä¸ä¹‹å¯¹åº”ï¼Œç”±äºå®ƒä»¬å¸¸è§æ˜¯ 1:1 çš„å…³ç³»ï¼Œæ‰€ä»¥ï¼Œé€šå¸¸ä¼šå°† Config ç±»å®šä¹‰æˆ GatewayFilterFactory å†…éƒ¨ç±»çš„å½¢å¼ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxxGatewayFilterFactory</span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XxxGatewayFilterFactory<span class="token punctuation">.</span>Config</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">XxxGatewayFilterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// é€»è¾‘ä»£ç  ...</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// æµç¨‹ç»§ç»­å‘ä¸‹ï¼Œèµ°åˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œç›´è‡³è·¯ç”±ç›®æ ‡ã€‚</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦åˆ™æµç¨‹ç»ˆæ­¢ï¼Œæ‹’ç»è·¯ç”±ã€‚</span>
                exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>
        <span class="token comment">// ç®€å•æƒ…å†µä¸‹ï¼ŒConfig ç±»é‡Œå¯ä»¥ä»€ä¹ˆéƒ½æ²¡æœ‰</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¸Šé¢çš„è¿‡æ»¤å™¨çš„é€»è¾‘ç»“æ„æ‰€å®ç°çš„åŠŸèƒ½ï¼šå½“æ¡ä»¶æˆç«‹æ—¶ï¼Œå…è®¸è·¯ç”±ï¼›å¦åˆ™ï¼Œç›´æ¥è¿”å›</p> <blockquote><p>è·¯ç”±å™¨çš„æ‰€æœ‰ä»£ç é€»è¾‘éƒ½æ˜¯åœ¨ã€<strong>è·¯ç”±å‰</strong>ã€æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è½¬å‘çš„å¾®æœåŠ¡å³ä½¿æ²¡æœ‰å¯åŠ¨ä¹Ÿä¼šæ‰§è¡Œã€‚å½“ç„¶ï¼Œè¿™ç§å½¢å¼çš„è¿‡æ»¤å™¨çš„æ›´ç®€å•çš„æƒ…å†µæ˜¯ï¼šæ‰§è¡ŒæŸäº›ä»£ç ï¼Œç„¶åå§‹ç»ˆæ˜¯æ”¾è¡Œã€‚
è¦æ³¨æ„ï¼šå½“è‡ªå®šä¹‰å¤šä¸ªå±€éƒ¨è¿‡æ»¤å™¨æ—¶ï¼Œä¾é é…ç½®æ–‡ä»¶ -name æ¥ä¿è¯æ‰§è¡Œé¡ºåºï¼Œå¦‚ï¼š</p> <p>filters:
-name: Xxx   å…ˆæ‰§è¡Œ   ä¸æ˜¯æŒ‰ç…§Orderçš„å€¼æ¥å†³å®š,@Orderåªå¯¹å…¨å±€è¿‡æ»¤å™¨èµ·ä½œç”¨
-name: Yyy   åæ‰§è¡Œ</p> <p>å¦å¤–å¦‚æœæ—¢æœ‰å±€éƒ¨è¿‡æ»¤å™¨ï¼Œåˆæœ‰å…¨å±€è¿‡æ»¤å™¨ï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œæ‰€æœ‰çš„å±€éƒ¨è¿‡æ»¤å™¨ï¼Œæ ¹æ®å±€éƒ¨è¿‡æ»¤å™¨æ ¹æ®é…ç½®æ–‡ä»¶é…ç½®çš„å…ˆåé¡ºåºï¼ˆé»˜è®¤ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªé¡ºåºçš„ï¼Œä»1å¼€å§‹é€’å¢ï¼‰ï¼Œå†æ‰§è¡Œæ‰€æœ‰çš„å…¨å±€è¿‡æ»¤å™¨ï¼Œå…¨å±€è¿‡æ»¤å™¨çš„é¡ºåºçœ‹@Order çš„å€¼ï¼Œå€¼æœ€å°å…ˆæ‰§è¡Œ</p></blockquote> <p>æ¡ˆä¾‹ï¼šå¯¹ç”¨æˆ·ä¿¡æ¯è¿›è¡Œè®¤è¯</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">XxxGatewayFilterFactory</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">XxxGatewayFilterFactory<span class="token punctuation">.</span>Config</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">XxxGatewayFilterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;yyy&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;aaa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// å¦åˆ™æµç¨‹ç»ˆæ­¢ï¼Œæ‹’ç»è·¯ç”±ã€‚</span>
                exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é…ç½®æ–‡ä»¶ï¼Œæ³¨æ„è¿‡æ»¤å™¨é‡å†™äº†åå­—ä¸º yyy</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> å•†å“å¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//provider<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/test
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yyy
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>æµ‹è¯•ï¼š</p> <p><img src="https://apaiimages.oss-cn-guangzhou.aliyuncs.com/MD/image-20210610161618099.png" alt="image-20210610161618099"></p> <p>è¿˜å¯ä»¥è·å–å…¶å®ƒçš„ä¿¡æ¯</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getQueryParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// Get è¯·æ±‚å‚æ•°</span>

request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}: {}&quot;</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="è‡ªå®šä¹‰-filter-å¼‚å¸¸å¤„ç†"><a href="#è‡ªå®šä¹‰-filter-å¼‚å¸¸å¤„ç†" class="header-anchor">#</a> è‡ªå®šä¹‰ Filter å¼‚å¸¸å¤„ç†</h4> <blockquote><p>æ•è·ç¨‹åºå‡ºç°çš„å¼‚å¸¸ å¹¶è‡ªå®šä¹‰æç¤ºä¿¡æ¯ è¿”å›æµè§ˆå™¨</p></blockquote> <h5 id="é…ç½®-æŒ‡å®š-è‡ªå®šä¹‰å¼‚å¸¸ç±»"><a href="#é…ç½®-æŒ‡å®š-è‡ªå®šä¹‰å¼‚å¸¸ç±»" class="header-anchor">#</a> é…ç½® æŒ‡å®š è‡ªå®šä¹‰å¼‚å¸¸ç±»</h5> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8084</span>

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> Gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token comment">## è·¯ç”± IDï¼Œå”¯ä¸€ å¯ä¸­æ–‡</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> Nacos<span class="token punctuation">-</span>A<span class="token punctuation">-</span>å¾®æœåŠ¡
          <span class="token comment">## uri: http://www.163.com è½¬å‘è·¯å¾„å†™æ­»</span>
          <span class="token comment">## ä½¿ç”¨å¾®æœåŠ¡å å¯è¿›è¡Œè´Ÿè½½å‡è¡¡è°ƒç”¨å¾®æœåŠ¡é›†ç¾¤</span>
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//Nacos<span class="token punctuation">-</span>A
          <span class="token comment">## æ–­è¨€è§„åˆ™ å¦‚: è¯·æ±‚è·¯å¾„å‰ç¼€</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token comment">## è¯·æ±‚è·¯å¾„å‰ç¼€ ä¸ä¼šæˆªæ‰å‰ç¼€</span>
            <span class="token punctuation">-</span> Path=/wuzi/<span class="token important">**</span>
          <span class="token comment">#å±€éƒ¨è¿‡æ»¤å™¨çš„æ‰§è¡Œé¡ºåºï¼ŒæŒ‰é…ç½®æ–‡ä»¶é…ç½®çš„é¡ºåºæ¥åŠ è½½</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token comment">## è¿‡æ»¤å™¨ä½¿æ¯æ¬¡è¯·æ±‚å¸¦ä¸Štoken</span>
            <span class="token punctuation">-</span> AddRequestHeader=token<span class="token punctuation">,</span>bbbbbb
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> guolv
</code></pre></div><h5 id="è‡ªå®šä¹‰è¿‡æ»¤å™¨"><a href="#è‡ªå®šä¹‰è¿‡æ»¤å™¨" class="header-anchor">#</a> è‡ªå®šä¹‰è¿‡æ»¤å™¨</h5> <blockquote><p>è‡ªå®šä¹‰çš„è·¯ç”±è¿‡æ»¤å™¨æŒ‰æƒ¯ä¾‹å«åšï¼š<strong>XxxGatewayFilterFactory</strong> ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ <strong>Xxx</strong> ä½œä¸ºå…¶åå­—å¼•ç”¨ã€‚</p> <p>å½“ç„¶ï¼Œä½ å¯ä»¥é€šè¿‡é‡å†™ <strong>name()</strong> æ–¹æ³•è‡ªå®šä¹‰åå­—ï¼Œ</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>filters</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">ErrorStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">SneakyThrows</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">AbstractGatewayFilterFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">DataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Flux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>

<span class="token comment">// è‡ªå®šä¹‰ å¼‚å¸¸å¤„ç† è¿‡æ»¤å™¨</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> guolvGatewayFilterFactory <span class="token keyword">extends</span>
        <span class="token class-name">AbstractGatewayFilterFactory</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name"><span class="token namespace">guolvGatewayFilterFactory<span class="token punctuation">.</span></span>Config</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token function">guolvGatewayFilterFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token class-name">Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">GatewayFilter</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">Config</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">GatewayFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// è·å– è¯·æ±‚å¤´çš„token</span>
                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ä¸ä¸ºç©ºåˆ™ æ”¾è¡Œ</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è¿‡æ»¤å™¨æ”¾è¡Œ</span>
                    <span class="token comment">// thenæ–¹æ³•å°±æ˜¯åœ¨å¾®æœåŠ¡è¿”å›ä¹‹åæ‰§è¡Œçš„</span>
                    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@SneakyThrows</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment">// è·å– è¯·æ±‚çš„çŠ¶æ€</span>
                            <span class="token class-name">HttpStatus</span> statusCode <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// åˆ›å»ºå¼‚å¸¸ä¿¡æ¯å°è£…å¯¹è±¡</span>
                            <span class="token class-name">ErrorStatus</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// æ ¹æ® è¯·æ±‚çš„çŠ¶æ€å¯¹åº”çš„æ‰§è¡Œå¼‚å¸¸ç±»</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å°è£…</span>
                                error<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                error<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å†…éƒ¨æŠ¥é”™&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// å°†å¼‚å¸¸çš„å°è£…ç±»å¯¹è±¡ è½¬æ¢ å­—ç¬¦ä¸²</span>
                                <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å­—ç¬¦ä¸²å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å°è£…</span>
                                error<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                error<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">&quot;urlåœ°å€ä¸åˆæ³•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// å°†å¼‚å¸¸çš„å°è£…ç±»å¯¹è±¡ è½¬æ¢ å­—ç¬¦ä¸²</span>
                                <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å­—ç¬¦ä¸²å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å°è£…</span>
                                error<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                error<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">&quot;è¯·æ±‚å‚æ•°é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// å°†å¼‚å¸¸çš„å°è£…ç±»å¯¹è±¡ è½¬æ¢ å­—ç¬¦ä¸²</span>
                                <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å­—ç¬¦ä¸²å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>
                                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// ä¸ºç©ºåˆ™è¿”å›æç¤ºä¿¡æ¯</span>
                <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token string">&quot;{\&quot;status\&quot;:\&quot;300\&quot;, \&quot;msg\&quot;:\&quot;ä½ æ²¡æœ‰æºå¸¦token\&quot;}&quot;</span><span class="token punctuation">;</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> jsonStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">DataBuffer</span> dataBuffer <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="å¼‚å¸¸ä¿¡æ¯å°è£…ç±»"><a href="#å¼‚å¸¸ä¿¡æ¯å°è£…ç±»" class="header-anchor">#</a> å¼‚å¸¸ä¿¡æ¯å°è£…ç±»</h5> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorStatus</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> status<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> msg<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="å¼‚å¸¸å¤„ç†ç±»"><a href="#å¼‚å¸¸å¤„ç†ç±»" class="header-anchor">#</a> å¼‚å¸¸å¤„ç†ç±»</h5> <blockquote><p>å®šä¹‰ç»Ÿä¸€å¼‚å¸¸å¤„ç†çš„ç›¸å…³ç±»ï¼Œç»§æ‰¿ErrorWebExceptionHandler</p> <p>å¯¹äºè¿™ç§å¾®æœåŠ¡çš„çŠ¶æ€æ•è·çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯ç½‘å…³åº”è¯¥è·å–æ¯ä¸ªå¾®æœåŠ¡é”™è¯¯çŠ¶æ€ç ï¼Œæ‰€ä»¥ä¸¥æ ¼çš„æ¥è¯´ï¼Œå†™åœ¨å…¨å±€è¿‡æ»¤å™¨æ›´å¥½</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">ResponseResult</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonProcessingException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span>type<span class="token punctuation">.</span></span><span class="token class-name">TypeReference</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>web<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span>error<span class="token punctuation">.</span></span><span class="token class-name">ErrorWebExceptionHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">DataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">DataBufferFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">MediaType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive<span class="token punctuation">.</span></span><span class="token class-name">ServerHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Supplier</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GlobalExceptionConfiguration</span> <span class="token keyword">implements</span> <span class="token class-name">ErrorWebExceptionHandler</span> <span class="token punctuation">{</span>
    <span class="token class-name">ObjectMapper</span> objectMapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//responseæ˜¯æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯è¯·æ±‚çš„ä¸€ä¸ªå“åº”ï¼Œå…¶ä¸­å°è£…äº†å“åº”å¤´ã€çŠ¶æ€ç ã€å†…å®¹ï¼ˆä¹Ÿå°±æ˜¯æœ€ç»ˆè¦åœ¨æµè§ˆå™¨ä¸Šæ˜¾ç¤ºçš„HTML</span>
        <span class="token comment">// ä»£ç æˆ–è€…å…¶ä»–æ•°æ®æ ¼å¼ï¼‰ç­‰ï¼ŒæœåŠ¡ç«¯åœ¨æŠŠresponseæäº¤åˆ°å®¢æˆ·ç«¯ä¹‹å‰ï¼Œä¼šä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶å‘è¯¥ç¼“å†²åŒºå†…å†™å…¥å“åº”å¤´å’Œ</span>
        <span class="token comment">// çŠ¶æ€ç ï¼Œç„¶åå°†æ‰€æœ‰å†…å®¹flushï¼ˆflushåŒ…å«ä¸¤ä¸ªæ­¥éª¤ï¼šå…ˆå°†ç¼“å†²åŒºå†…å®¹å‘é€è‡³å®¢æˆ·ç«¯ï¼Œç„¶åå°†ç¼“å†²åŒºæ¸…ç©ºï¼‰ã€‚è¿™å°±æ ‡å¿—ç€è¯¥</span>
        <span class="token comment">// æ¬¡å“åº”å·²ç»committed(æäº¤)ã€‚å¯¹äºå½“å‰é¡µé¢ä¸­å·²ç»committed(æäº¤)çš„responseï¼Œå°±ä¸èƒ½å†ä½¿ç”¨è¿™ä¸ªresponseå‘ç¼“å†²åŒº</span>
        <span class="token comment">// å†™ä»»ä½•ä¸œè¥¿  ï¼ˆæ³¨ï¼šä»¥ä¸ºJSPä¸­ï¼Œresponseæ˜¯ä¸€ä¸ªJSPé¡µé¢çš„å†…ç½®å¯¹è±¡ï¼Œæ‰€ä»¥åŒä¸€ä¸ªé¡µé¢ä¸­çš„response.XXX()æ˜¯åŒä¸€ä¸ªresponseçš„ä¸åŒæ–¹æ³•ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªå·²ç»å¯¼è‡´äº†committedï¼Œ é‚£ä¹ˆå…¶å®ƒç±»ä¼¼æ–¹å¼çš„è°ƒç”¨éƒ½ä¼šå¯¼è‡´ IllegalStateExceptionå¼‚å¸¸ï¼‰</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">isCommitted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token class-name">MediaType</span><span class="token punctuation">.</span>APPLICATION_JSON<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromSupplier</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DataBuffer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">DataBuffer</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">DataBufferFactory</span> bufferFactory <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ErrorStatus</span> errorStatus <span class="token operator">=</span> objectMapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ErrorStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResponseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> errorStatus<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> errorStatus<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//æ¥å£çµ±ä¸€ç›¸æ‡‰  responseresult</span>
                    <span class="token keyword">return</span> bufferFactory<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>objectMapper<span class="token punctuation">.</span><span class="token function">writeValueAsBytes</span><span class="token punctuation">(</span>responseResult<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;Error writing response&quot;</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> bufferFactory<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="json-å½¢å¼çš„é”™è¯¯è¿”å›"><a href="#json-å½¢å¼çš„é”™è¯¯è¿”å›" class="header-anchor">#</a> JSON å½¢å¼çš„é”™è¯¯è¿”å›</h4> <p>ä¸Šè¿°çš„ã€<strong>æ‹’ç»</strong>ã€æ˜¯ä»¥ HTTP çš„é”™è¯¯å½¢å¼è¿”å›ï¼Œå³ 4xxã€5xx çš„é”™è¯¯ã€‚</p> <p>æœ‰æ—¶ï¼Œæˆ‘ä»¬çš„è¿”å›æ–¹æ¡ˆæ˜¯ä»¥ 200 å½¢å¼çš„ã€æˆåŠŸã€è¿”å›ï¼Œç„¶åå†åœ¨è¿”å›çš„ä¿¡æ¯ä¸­ä»¥è‡ªå®šä¹‰çš„é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯çš„å½¢å¼å‘ŠçŸ¥è¯·æ±‚å‘èµ·è€…è¯·æ±‚å¤±è´¥ã€‚</p> <p>æ­¤æ—¶ï¼Œå°±éœ€è¦ è¿‡æ»¤å™¨ã€<strong>æˆåŠŸ</strong>ã€è¿”å› JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token string">&quot;{\&quot;status\&quot;:\&quot;-1\&quot;, \&quot;msg\&quot;:\&quot;error\&quot;}&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> jsonStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="è·å–-body-ä¸­çš„è¯·æ±‚å‚æ•°"><a href="#è·å–-body-ä¸­çš„è¯·æ±‚å‚æ•°" class="header-anchor">#</a> è·å– Body ä¸­çš„è¯·æ±‚å‚æ•°</h4> <p>ç”±äº Gateway æ˜¯åŸºäº Spring 5 çš„ WebFlux å®ç°çš„ï¼ˆé‡‡ç”¨çš„æ˜¯ Reactor ç¼–ç¨‹æ¨¡å¼ï¼‰ï¼Œå› æ­¤ï¼Œä»è¯·æ±‚ä½“ä¸­è·å–å‚æ•°ä¿¡æ¯æ˜¯ä¸€ä»¶æŒºéº»çƒ¦çš„äº‹æƒ…ã€‚</p> <p>æœ‰ä¸€äº›ç®€å•çš„æ–¹æ¡ˆå¯ä»¥ä» Request çš„è¯·æ±‚ä½“ä¸­è·å–è¯·æ±‚å‚æ•°ï¼Œä¸è¿‡éƒ½æœ‰äº›éšæ‚£å’Œç¼ºé™·ã€‚</p> <p>æœ€ç¨³å¦¥çš„æ–¹æ¡ˆæ˜¯æ¨¡ä»¿ Gateway ä¸­å†…ç½®çš„ ModifyRequestBodyGatewayFilterFactoryï¼Œä¸è¿‡ï¼Œè¿™ä¸ªä»£ç å†™èµ·æ¥å¾ˆå•°å—¦ã€‚</p> <p>å…·ä½“å†…å®¹å¯å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.haoyizebo.com/posts/876ed1e8/" target="_blank" rel="noopener noreferrer">Spring Cloud Gatewayï¼ˆè¯»å–ã€ä¿®æ”¹ Request Bodyï¼‰</a></p> <p>ä¸è¿‡è€ƒè™‘åˆ° Gateway åªæ˜¯åšè¯·æ±‚çš„ã€<strong>è½¬å‘</strong>ã€ï¼Œè€Œä¸ä¼šæ‰¿æ‹…ä¸šåŠ¡è´£ä»»ï¼Œå› æ­¤ï¼Œæ˜¯å¦çœŸçš„éœ€è¦åœ¨ Gateway ä¸­ä»è¯·æ±‚çš„ Body ä¸­è·å–è¯·æ±‚æ•°æ®ï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥æ–Ÿé…Œã€‚</p> <h4 id="è¿‡æ»¤å™¨çš„å¦ä¸€ç§é€»è¾‘å½¢å¼"><a href="#è¿‡æ»¤å™¨çš„å¦ä¸€ç§é€»è¾‘å½¢å¼" class="header-anchor">#</a> è¿‡æ»¤å™¨çš„å¦ä¸€ç§é€»è¾‘å½¢å¼</h4> <p>æœ‰æ—¶ä½ å¯¹è¿‡æ»¤å™¨çš„è¿ç”¨å¹¶éæ˜¯ä¸ºäº†å†³å®šæ˜¯å¦ç»§ç»­è·¯ç”±ï¼Œä¸ºäº†åœ¨æ•´ä¸ªæµç¨‹ä¸­ã€<strong>åµŒå…¥</strong>ã€é¢å¤–çš„ä»£ç ã€é€»è¾‘ï¼šåœ¨è·¯ç”±ä¹‹å‰å’Œä¹‹åæ‰§è¡ŒæŸäº›ä»£ç 
å¦‚æœä»…ä»…æ˜¯åœ¨è·¯ç”±è‡³ç›®æ ‡å¾®æœåŠ¡ä¹‹å‰æ‰§è¡ŒæŸäº›ä»£ç é€»è¾‘ï¼Œé‚£ä¹ˆ Filter çš„å½¢å¼æ¯”è¾ƒç®€å•ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">return</span> <span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> chain<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// é€»è¾‘ä»£ç  ...</span>
    <span class="token comment">// æµç¨‹ç»§ç»­å‘ä¸‹ï¼Œèµ°åˆ°ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œç›´è‡³è·¯ç”±ç›®æ ‡ã€‚</span>
    <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœï¼Œä½ æƒ³åœ¨è·¯ç”±ä¹‹å‰å’Œä¹‹åï¼ˆå³ï¼Œç›®æ ‡å¾®æœåŠ¡è¿”å›ä¹‹åï¼‰éƒ½ã€<strong>åµŒå…¥</strong>ã€ä»£ç ï¼Œé‚£ä¹ˆå…¶å½¢å¼å°±æ˜¯ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>@Override
public GatewayFilter apply(Config config) {
    return ((exchange, chain) -&gt; {
        log.info(&quot;ç›®æ ‡å¾®æœåŠ¡ã€æ‰§è¡Œå‰ã€‘æ‰§è¡Œ&quot;);
        return chain.filter(exchange)
            .then(Mono.fromRunnable(() -&gt; {
                log.info(&quot;ç›®æ ‡å¾®æœåŠ¡ã€æ‰§è¡Œåã€‘æ‰§è¡Œ&quot;);
            }));
    });
}
</code></pre></div><h4 id="è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„å‚æ•°"><a href="#è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„å‚æ•°" class="header-anchor">#</a> è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„å‚æ•°</h4> <p>å’Œè‡ªå®šä¹‰è·¯ç”±æ–­è¨€ä¸€æ ·ï¼Œè‡ªå®šä¹‰çš„è¿‡æ»¤å™¨æ–­è¨€å¯ä»¥è‡ªå®šä¹‰å‚æ•°ã€‚
å®šä¹‰çš„å½¢å¼æ˜¯å†™æˆ Config ç±»çš„å±æ€§ï¼›ä½¿ç”¨çš„å½¢å¼æ˜¯åœ¨é…ç½®ä¸­ä½¿ç”¨ <strong>args</strong> é…ç½®ã€‚</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">filters</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yyy
    <span class="token key atrule">args</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
      <span class="token key atrule">password</span><span class="token punctuation">:</span> world
</code></pre></div><h3 id="è‡ªå®šä¹‰å…¨å±€-filter"><a href="#è‡ªå®šä¹‰å…¨å±€-filter" class="header-anchor">#</a> è‡ªå®šä¹‰å…¨å±€ Filter</h3> <p>è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨æ¯”å±€éƒ¨è¿‡æ»¤å™¨è¦ç®€å•ï¼Œå› ä¸ºå®ƒã€<strong>ä¸éœ€è¦æŒ‡å®šå¯¹å“ªä¸ªè·¯ç”±ç”Ÿæ•ˆï¼Œå®ƒå¯¹æ‰€æœ‰è·¯ç”±éƒ½ç”Ÿæ•ˆ</strong>ã€ã€‚</p> <blockquote><p><strong>@Order</strong> æ³¨è§£æ˜¯ä¸ºäº†å»æ§åˆ¶å…¨å±€è¿‡æ»¤å™¨çš„å…ˆåé¡ºåºï¼Œä¸æ˜¯å±€éƒ¨çš„é¡ºåºï¼Œå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">{</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>æ¡ˆä¾‹ï¼šå¦‚æœipæ˜¯æœ¬æœº å°±ä¸æ”¾è¡Œ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> host <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æ­¤å¤„å†™æ­»äº†ï¼Œæ¼”ç¤ºç”¨ï¼Œå®é™…ä¸­éœ€è¦é‡‡å–é…ç½®çš„æ–¹å¼</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>host<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;localhost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token string">&quot;{\&quot;status\&quot;:\&quot;-1\&quot;, \&quot;msg\&quot;:\&quot;error\&quot;}&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> jsonStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="å…¨å±€è¿‡æ»¤å™¨å¼‚å¸¸å¤„ç†"><a href="#å…¨å±€è¿‡æ»¤å™¨å¼‚å¸¸å¤„ç†" class="header-anchor">#</a> å…¨å±€è¿‡æ»¤å™¨å¼‚å¸¸å¤„ç†</h4> <blockquote><p>è·å–å¾®æœåŠ¡çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¦‚æœé200ï¼Œè¿›è¡Œç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†</p> <p>å…¨å±€çš„è¿‡æ»¤å™¨å¯ä»¥ä¸è¦é…ç½®ç›´æ¥ä½¿ç”¨</p> <p>ä¸‹æ–¹è¿‡æ»¤å™¨é…åˆ å±€éƒ¨çš„å…¶ä»–ç±»é…åˆä½¿ç”¨</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>filters</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">ErrorStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">SneakyThrows</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GlobalFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Order</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">DataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Flux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuanjuGlobalFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å– è¯·æ±‚å¤´çš„token</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> token <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ä¸ä¸ºç©ºåˆ™ æ”¾è¡Œ</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// è¿‡æ»¤å™¨æ”¾è¡Œ</span>
            <span class="token comment">// thenæ–¹æ³•å°±æ˜¯åœ¨å¾®æœåŠ¡è¿”å›ä¹‹åæ‰§è¡Œçš„</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromRunnable</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@SneakyThrows</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// è·å– è¯·æ±‚çš„çŠ¶æ€</span>
                    <span class="token class-name">HttpStatus</span> statusCode <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// åˆ›å»ºå¼‚å¸¸ä¿¡æ¯å°è£…å¯¹è±¡</span>
                    <span class="token class-name">ErrorStatus</span> error <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ErrorStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// æ ¹æ® è¯·æ±‚çš„çŠ¶æ€å¯¹åº”çš„æ‰§è¡Œå¼‚å¸¸ç±»</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">500</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å°è£…</span>
                        error<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        error<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">&quot;æœåŠ¡å™¨å†…éƒ¨æŠ¥é”™&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å°†å¼‚å¸¸çš„å°è£…ç±»å¯¹è±¡ è½¬æ¢ å­—ç¬¦ä¸²</span>
                        <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å­—ç¬¦ä¸²å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å°è£…</span>
                        error<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        error<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">&quot;urlåœ°å€ä¸åˆæ³•&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å°†å¼‚å¸¸çš„å°è£…ç±»å¯¹è±¡ è½¬æ¢ å­—ç¬¦ä¸²</span>
                        <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å­—ç¬¦ä¸²å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å°è£…</span>
                        error<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        error<span class="token punctuation">.</span><span class="token function">setMsg</span><span class="token punctuation">(</span><span class="token string">&quot;è¯·æ±‚å‚æ•°é”™è¯¯&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å°†å¼‚å¸¸çš„å°è£…ç±»å¯¹è±¡ è½¬æ¢ å­—ç¬¦ä¸²</span>
                        <span class="token class-name">String</span> errorMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">// å°†å¼‚å¸¸ä¿¡æ¯å­—ç¬¦ä¸²å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>errorMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ä¸ºç©ºåˆ™è¿”å›æç¤ºä¿¡æ¯</span>
        <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token string">&quot;{\&quot;status\&quot;:\&quot;300\&quot;, \&quot;msg\&quot;:\&quot;ä½ æ²¡æœ‰æºå¸¦token\&quot;}&quot;</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> jsonStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DataBuffer</span> dataBuffer <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>å®šä¹‰å¼‚å¸¸éƒ¨åˆ†åœ¨å‰é¢çš„å±€éƒ¨å¼‚å¸¸å®šä¹‰è¿‡ï¼Œè¿™é‡Œä¸å†è®²è§£</p> <blockquote><p>éœ€è¦è¯´æ˜çš„æ˜¯ï¼šå¦‚æœç½‘å…³è½¬å‘çš„å¾®æœåŠ¡å®•æœºæˆ–è€…æ²¡æœ‰å¯åŠ¨ï¼Œé‚£ä¹ˆå…¨å±€è¿‡æ»¤å™¨æ˜¯ä¸ä¼šæ‰§è¡Œçš„ã€‚</p></blockquote> <h3 id="è·¨åŸŸé…ç½®"><a href="#è·¨åŸŸé…ç½®" class="header-anchor">#</a> è·¨åŸŸé…ç½®</h3> <blockquote><p><strong>è·¨åŸŸ: å³ä¸åŒçš„IP æˆ–è€… ä¸åŒçš„ç«¯å£ å°±æ˜¯è·¨åŸŸ  |  ç›´æ¥è¯·æ±‚è·¨åŸŸçš„æœåŠ¡å™¨æ˜¯æ— æ³•æ­£å¸¸è°ƒç”¨</strong></p></blockquote> <p>é€šè¿‡è‡ªå®šä¹‰ GatewayFilter å®šä¹‰è¿‡æ»¤å™¨,æ‹¦æˆªè¯·æ±‚,ç»Ÿä¸€è®¾ç½®è¯·æ±‚å…è®¸è·¨åŸŸ</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CrossGatewayFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>ACCESS_CONTROL_ALLOW_ORIGIN<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>ACCESS_CONTROL_ALLOW_METHODS<span class="token punctuation">,</span><span class="token string">&quot;POST,GET,PUT,DELETE&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>ACCESS_CONTROL_ALLOW_CREDENTIALS<span class="token punctuation">,</span> <span class="token string">&quot;true&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>ACCESS_CONTROL_ALLOW_HEADERS<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        headers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span>ACCESS_CONTROL_EXPOSE_HEADERS<span class="token punctuation">,</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é‡‡ç”¨é…ç½®çš„æ–¹å¼ï¼ˆæ¨èï¼‰</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> hospital<span class="token punctuation">-</span>gateway1
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>
            <span class="token comment">## å…è®¸æºå¸¦è®¤è¯ä¿¡æ¯</span>
            <span class="token key atrule">allow-credentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token comment">## å…è®¸è·¨åŸŸçš„æº(ç½‘ç«™åŸŸå/ip)ï¼Œè®¾ç½®*ä¸ºå…¨éƒ¨</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
            <span class="token comment">## å…è®¸è·¨åŸŸçš„methodï¼Œ é»˜è®¤ä¸ºGETå’ŒOPTIONSï¼Œè®¾ç½®*ä¸ºå…¨éƒ¨</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
            <span class="token comment">## å…è®¸è·¨åŸŸè¯·æ±‚é‡Œçš„headå­—æ®µï¼Œè®¾ç½®*ä¸ºå…¨éƒ¨</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> sickroomå¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//sickroom<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/sickroom/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1

        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> financeå¾®æœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//finance<span class="token punctuation">-</span>service
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/finance/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> StripPrefix=1

</code></pre></div><h3 id="gatewayç½‘å…³çš„ç†”æ–­é™çº§"><a href="#gatewayç½‘å…³çš„ç†”æ–­é™çº§" class="header-anchor">#</a> Gatewayç½‘å…³çš„ç†”æ–­é™çº§</h3> <p>1.æ·»åŠ springcloudçš„hystrixå¯åŠ¨å™¨</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>2.åœ¨gatewayç½‘å…³å·²ç»å†…ç½®äº†å±€éƒ¨çš„HystrixGatewayFilterFactoryè¿‡æ»¤å™¨ç±»ï¼Œç›´æ¥åœ¨è¦è½¬å‘çš„æŸä¸ªå¾®æœåŠ¡ä¸Šé¢é…ç½®å³å¯</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> spring<span class="token punctuation">-</span>service<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">globalcors</span><span class="token punctuation">:</span>
        <span class="token key atrule">corsConfigurations</span><span class="token punctuation">:</span>
          <span class="token key atrule">'[/**]'</span><span class="token punctuation">:</span>
            <span class="token comment">## å…è®¸æºå¸¦è®¤è¯ä¿¡æ¯</span>
            <span class="token key atrule">allow-credentials</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token comment">## å…è®¸è·¨åŸŸçš„æº(ç½‘ç«™åŸŸå/ip)ï¼Œè®¾ç½®*ä¸ºå…¨éƒ¨</span>
            <span class="token key atrule">allowedOrigins</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
            <span class="token comment">## å…è®¸è·¨åŸŸçš„methodï¼Œ é»˜è®¤ä¸ºGETå’ŒOPTIONSï¼Œè®¾ç½®*ä¸ºå…¨éƒ¨</span>
            <span class="token key atrule">allowedMethods</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
            <span class="token comment">## å…è®¸è·¨åŸŸè¯·æ±‚é‡Œçš„headå­—æ®µï¼Œè®¾ç½®*ä¸ºå…¨éƒ¨</span>
            <span class="token key atrule">allowedHeaders</span><span class="token punctuation">:</span> <span class="token string">&quot;*&quot;</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> bæœåŠ¡
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> lb<span class="token punctuation">:</span>//spring<span class="token punctuation">-</span>service<span class="token punctuation">-</span>b
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/port/<span class="token important">**</span>
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Hystrix
              <span class="token key atrule">args</span><span class="token punctuation">:</span>
                <span class="token key atrule">name</span><span class="token punctuation">:</span> fallbackcmd
                <span class="token key atrule">fallbackUri</span><span class="token punctuation">:</span> forward<span class="token punctuation">:</span>/myfallback
                
<span class="token key atrule">hystrix</span><span class="token punctuation">:</span>
  <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token key atrule">default</span><span class="token punctuation">:</span>
      <span class="token key atrule">execution</span><span class="token punctuation">:</span>
        <span class="token key atrule">isolation</span><span class="token punctuation">:</span>
          <span class="token key atrule">strategy</span><span class="token punctuation">:</span> SEMAPHORE
          <span class="token key atrule">thread</span><span class="token punctuation">:</span>
            <span class="token key atrule">timeoutInMilliseconds</span><span class="token punctuation">:</span> <span class="token number">5000</span>   <span class="token comment">##5såé™çº§</span>
</code></pre></div><blockquote><p>è¯´æ˜ï¼š</p> <p>1.HystrixGatewayFilterFactoryè¿‡æ»¤å™¨å†…ç½®é…ç½®ç±»æœ‰å¾ˆå¤šå‚æ•°ï¼Œname:  fallbackcmd(å›ºå®šå†™æ³•)</p> <p>2.fallbackUriè¡¨ç¤ºç†”æ–­åçš„é™çº§è¯·æ±‚åœ°å€</p></blockquote> <p>3.è¯·æ±‚æ¥å£å®šä¹‰</p> <p>åœ¨gatewayå¾®æœåŠ¡ä¸­ç¼–å†™controllerè¯·æ±‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FallBackController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/myfallback&quot;</span><span class="token punctuation">)</span>  <span class="token comment">//å’Œä¸Šé¢çš„fallbackUriè¦å¯¹åº”</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">myFallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Code&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;fail&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;Message&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;æœåŠ¡æš‚æ—¶ä¸å¯ç”¨,è¯·ç¨å€™è®¿é—®.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="bucket4j-ä»¤ç‰Œ"><a href="#bucket4j-ä»¤ç‰Œ" class="header-anchor">#</a> Bucket4j  ä»¤ç‰Œ</h2> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token comment">&lt;!--Bucket4j ä»¤ç‰Œæ¡¶--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.vladimir-bukhtoyarov<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bucket4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>ã€<strong>ä»¤ç‰Œæ¡¶</strong>ã€æ˜¯ä¸€ç§é™é€Ÿç®—æ³•ï¼Œä¸ä¹‹ç›¸å¯¹çš„æ˜¯ã€<strong>æ¼æ¡¶</strong>ã€ã€‚</p> <p>å½“è¿›è¡Œä»»åŠ¡çš„æ“ä½œæ—¶ï¼Œæ¶ˆè€—ä¸€å®šçš„ä»¤ç‰Œï¼Œåå°ä»¥ä¸€å®šçš„é€Ÿç‡ç”Ÿäº§ä»¤ç‰Œã€‚åœ¨æ²¡æœ‰ä»¤ç‰Œçš„æƒ…å†µä¸‹ï¼Œå°±é˜»å¡ä»»åŠ¡ï¼Œæˆ–è€…æ‹’ç»æœåŠ¡ã€‚ä»¤ç‰Œçš„ç”Ÿäº§é€Ÿç‡ï¼Œä»£è¡¨äº†å¤§éƒ¨åˆ†æƒ…å†µä¸‹çš„å¹³å‡æµé€Ÿã€‚</p> <p>æ¡¶çš„ä½œç”¨å°±æ˜¯å­˜å‚¨ä»¤ç‰Œï¼Œæ¶ˆè€—çš„ä»¤ç‰Œéƒ½æ˜¯ä»æ¡¶ä¸­è·å–ã€‚</p> <p>æ¡¶çš„ä½œç”¨æ˜¯ç”¨æ¥é™åˆ¶æµé€Ÿçš„å³°å€¼ï¼Œå½“æ¡¶ä¸­æœ‰é¢å¤–ä»¤ç‰Œçš„æ—¶å€™ï¼Œå®é™…çš„æµé€Ÿå°±ä¼šé«˜äºé™å®šçš„ä»¤ç‰Œç”Ÿäº§é€Ÿç‡ã€‚</p> <p>ä¸ºäº†ä¿è¯åŠŸèƒ½çš„å®Œæ•´ï¼Œåå°å¿…é¡»ä¿è¯ä»¤ç‰Œç”Ÿäº§ï¼Œè€Œä¸”æ˜¯æŒç»­æœåŠ¡ï¼Œä¸èƒ½ä¸­æ–­ã€‚åŒæ—¶ï¼Œä¸ºäº†æ¡¶åŠŸèƒ½çš„æ­£ç¡®ä½œç”¨ï¼Œå½“æ¡¶æ»¡äº†ä»¥åï¼Œåç»­ç”Ÿäº§çš„ä»¤ç‰Œä¼šæº¢å‡ºï¼Œä¸ä¼šå­˜å‚¨åˆ°æ¡¶å†…éƒ¨ã€‚</p> <p>ä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶çš„åŒºåˆ«ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>l æ¼æ¡¶ç®—æ³•èƒ½å¤Ÿå¼ºè¡Œé™åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•èƒ½å¤Ÿåœ¨é™åˆ¶æ•°æ®çš„å¹³å‡ä¼ è¾“é€Ÿç‡çš„åŒæ—¶è¿˜å…è®¸æŸç§ç¨‹åº¦çš„çªå‘ä¼ è¾“ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ¼æ¡¶ç®—æ³•ä¸èƒ½å¤Ÿæœ‰æ•ˆåœ°ä½¿ç”¨ç½‘ç»œèµ„æºã€‚å› ä¸ºæ¼æ¡¶çš„æ¼å‡ºé€Ÿç‡æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥å³ä½¿ç½‘ç»œä¸­æ²¡æœ‰å‘ç”Ÿæ‹¥å¡ï¼Œæ¼æ¡¶ç®—æ³•ä¹Ÿä¸èƒ½ä½¿æŸä¸€ä¸ªå•ç‹¬çš„æ•°æ®æµè¾¾åˆ°ç«¯å£é€Ÿç‡ã€‚å› æ­¤ï¼Œæ¼æ¡¶ç®—æ³•å¯¹äºå­˜åœ¨çªå‘ç‰¹æ€§çš„æµé‡æ¥è¯´ç¼ºä¹æ•ˆç‡ã€‚è€Œä»¤ç‰Œæ¡¶ç®—æ³•åˆ™èƒ½å¤Ÿæ»¡è¶³è¿™äº›å…·æœ‰çªå‘ç‰¹æ€§çš„æµé‡ã€‚é€šå¸¸ï¼Œæ¼æ¡¶ç®—æ³•ä¸ä»¤ç‰Œæ¡¶ç®—æ³•ç»“åˆèµ·æ¥ä¸ºç½‘ç»œæµé‡æä¾›æ›´é«˜æ•ˆçš„æ§åˆ¶ã€‚æ¼æ¡¶ç®—æ³•æ€è·¯å¾ˆç®€å•ï¼Œæ°´ï¼ˆè¯·æ±‚ï¼‰å…ˆè¿›å…¥åˆ°æ¼æ¡¶é‡Œï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿåº¦å‡ºæ°´ï¼Œå½“æ°´æµå…¥é€Ÿåº¦è¿‡å¤§ä¼šç›´æ¥æº¢å‡ºï¼Œå¯ä»¥çœ‹å‡ºæ¼æ¡¶ç®—æ³•èƒ½å¼ºè¡Œé™åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡
</code></pre></div><h3 id="_1-åŸºæœ¬ä½¿ç”¨"><a href="#_1-åŸºæœ¬ä½¿ç”¨" class="header-anchor">#</a> 1. åŸºæœ¬ä½¿ç”¨</h3> <p>æœ€ç®€å•çš„ bucket4j çš„ä½¿ç”¨éœ€è¦æä¾›ã€æ¶µç›–ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µï¼š</p> <ol><li>æ¡¶å¯¹è±¡ã€‚</li> <li>å¸¦å®½ã€‚å³ï¼Œæ¯ç§’æä¾›å¤šå°‘ä¸ª tokenï¼Œä»¥å…è®¸æ“ä½œã€‚</li> <li>æ¶ˆè´¹ã€‚å³ï¼Œä»æ¡¶ä¸­ä¸€æ¬¡æ€§å–èµ°å¤šå°‘ä¸ª token ã€‚</li></ol> <p>ä»£ç ç¤ºä¾‹ï¼š</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// å¸¦å®½ï¼Œä¹Ÿå°±æ˜¯æ¯ç§’èƒ½å¤Ÿé€šè¿‡çš„æµé‡ï¼Œè‡ªåŠ¨ç»´æŠ¤ä»¤ç‰Œç”Ÿäº§ã€‚ //æ¡¶å¤§å°æ˜¯10 ï¼Œåˆå§‹æœ‰10ä¸ªï¼Œæ¯ç§’ç”Ÿäº§10ä¸ª</span>
<span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">simple</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ¡¶ bucket æ˜¯æˆ‘ä»¬æ“ä½œçš„å…¥å£ã€‚æ¡¶çš„å¤§å°å°±æ˜¯åªèƒ½æ”¾10ä¸ªï¼Œ</span>
<span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// å°è¯•æ¶ˆè´¹ n ä¸ªä»¤ç‰Œï¼Œè¿”å›å¸ƒå°”å€¼ï¼Œè¡¨ç¤ºèƒ½å¤Ÿæ¶ˆè´¹æˆ–è€…ä¸èƒ½å¤Ÿæ¶ˆè´¹ã€‚</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> bucket<span class="token punctuation">.</span><span class="token function">tryConsume</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">&quot;do something&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;do nothing&quot;</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="_2-é˜»å¡å¼æ¶ˆè´¹"><a href="#_2-é˜»å¡å¼æ¶ˆè´¹" class="header-anchor">#</a> 2. é˜»å¡å¼æ¶ˆè´¹</h3> <p>åœ¨ä¸Šé¢çš„åŸºç¡€æ¡ˆä¾‹ä¸­ï¼Œå¦‚æœ bucket ä¸­çš„ä»¤ç‰Œçš„æ•°é‡ä¸å¤Ÿä½ çš„å½“å‰æ¶ˆè´¹æ—¶ï¼Œ<strong>.tryConsume</strong> æ–¹æ³•ä¼šä»¥å¤±è´¥çš„æ–¹å¼è¿”å›ã€‚</p> <p>ä¸è¿‡ï¼Œæœ‰æ—¶æˆ‘ä»¬å¸Œæœ›çš„æ•ˆæœæ˜¯ç­‰å¾…ï¼Œç­‰åˆ° bucket ä¸­æ–°å¢ä»¤ç‰Œåï¼Œå†æ¶ˆè´¹ï¼Œè¿”å›ã€‚</p> <p>è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ <strong>.asScheduler</strong> æ–¹æ³•ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//æ¡¶å¤§å°æ˜¯1ï¼Œåˆå§‹æœ‰1ä¸ªä»¤ç‰Œï¼Œä»¥åæ¯2ç§’ç”Ÿäº§ä¸€ä¸ª</span>
<span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">simple</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// çœ‹è¿™é‡Œï¼Œçœ‹è¿™é‡Œï¼Œçœ‹è¿™é‡Œã€‚</span>
    bucket<span class="token punctuation">.</span><span class="token function">asScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">consume</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//è¯¥æ–¹æ³•ä¼šé˜»å¡ï¼Œå–ä¸åˆ°å°±ç­‰å¾…</span>
    <span class="token class-name">String</span> time <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>ISO_LOCAL_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-æ¢é’ˆ"><a href="#_3-æ¢é’ˆ" class="header-anchor">#</a> 3. æ¢é’ˆ</h3> <p>é€šè¿‡åˆ›å»ºå¹¶ä½¿ç”¨ <strong>ConsumptionProbe</strong> å¯¹è±¡ï¼Œé™¤äº†å¯ä»¥å®ç°æ­£å¸¸çš„æ¶ˆè´¹åŠŸèƒ½ä¹‹å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å®ƒå»æŸ¥è¯¢æ¶ˆè´¹åçš„æ¡¶ä¸­çš„â€œä½™é¢â€ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// æ¢é’ˆ æ¡¶å¤§å°æ˜¯5ï¼Œæ¯ç§’ç”Ÿäº§5ä¸ª</span>
<span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">simple</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è·å–æ¢é’ˆï¼Œæ¶ˆè´¹ä»¤ç‰Œ</span>
    <span class="token class-name">ConsumptionProbe</span> probe <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">tryConsumeAndReturnRemaining</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ¤æ–­ã€ä¸Šä¸€æ­¥ã€‘æ˜¯å¦æ¶ˆè´¹æˆåŠŸ</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>probe<span class="token punctuation">.</span><span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">//è¯¥æ–¹æ³•ä¸ä¼š é˜»å¡</span>
        <span class="token class-name">String</span> time <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>ISO_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// æŸ¥è¯¢å‰©ä½™ä»¤ç‰Œæ•°é‡</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} å‰©ä½™ä»¤ç‰Œ: {}&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> probe<span class="token punctuation">.</span><span class="token function">getRemainingTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;waiting...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><h3 id="_4-refill-å’Œ-classic-æ–¹æ³•"><a href="#_4-refill-å’Œ-classic-æ–¹æ³•" class="header-anchor">#</a> 4. Refill å’Œ classic æ–¹æ³•</h3> <p>åœ¨ä¹‹å‰çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„éƒ½æ˜¯ <strong>Bandwidth.simple</strong> æ–¹æ³•ï¼Œå®é™…ä¸Šï¼Œå®ƒç›¸å½“äºæ˜¯ <strong>Bandwidth.classic</strong> æ–¹æ³•çš„ç®€å†™ã€‚</p> <p><strong>Bandwidth.classic</strong> æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°éœ€è¦ä¸€ä¸ª <strong>Refill</strong> å¯¹è±¡ï¼Œè€Œ <strong>Refill</strong> å¯¹è±¡å°±ä»£è¡¨ç€ä½ å¯¹æ¡¶çš„å¡«å……è§„åˆ™çš„è®¾å®šã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// æ¡¶æ§åˆ¶ã€‚æ¡¶å®¹é‡åˆå§‹åŒ–æ—¶é»˜è®¤æ˜¯æ»¡çš„ ï¼Œåˆå§‹åŒ–æ—¶ æ¡¶æœ‰9ä¸ªï¼Œæ¡¶çš„å¤§å°ä¹Ÿæ˜¯9</span>
<span class="token keyword">long</span> bucketSize <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span> 
<span class="token class-name">Refill</span> filler <span class="token operator">=</span> <span class="token class-name">Refill</span><span class="token punctuation">.</span><span class="token function">greedy</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ¯ç§’ç”Ÿäº§2ä¸ªä»¤ç‰Œ</span>
<span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">classic</span><span class="token punctuation">(</span>bucketSize<span class="token punctuation">,</span> filler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ¡¶çš„åˆå§‹å¤§å°æœ‰9ä¸ªä»¤ç‰Œ</span>
<span class="token comment">//æ¡¶çš„å¤§å°æ˜¯9.ä¹Ÿå°±æ˜¯è¯´ä»¥åæ¯æ¬¡å•ä½æ—¶é—´ç”Ÿäº§çš„ä»¤ç‰Œæœ€å¤šä¹Ÿæ˜¯9ä¸ªï¼Œä¾‹å¦‚ï¼šä¸Šé¢æˆ‘ä»¬æ”¹æˆæ¯ç§’ç”Ÿäº§20ä¸ªï¼Œé‚£ä¹ˆå…¶å®æœ€ç»ˆè¿˜æ˜¯åªèƒ½è£…9ä¸ªï¼Œå¤šä½™çš„æº¢å‡º</span>
<span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConsumptionProbe</span> probe <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">tryConsumeAndReturnRemaining</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>probe<span class="token punctuation">.</span><span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}: å‰©ä½™ä»¤ç‰Œ {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>ISO_TIME<span class="token punctuation">)</span><span class="token punctuation">,</span> probe<span class="token punctuation">.</span><span class="token function">getRemainingTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;waiting...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>åˆå§‹åŒ–æ¡¶æœ‰9ä¸ªä»¤ç‰Œï¼Œæ‰“å°8 7 6 5 4 3 2 1 0 ï¼Œåˆšå¥½æ¶ˆè´¹å®Œï¼Œ   çº¿ç¨‹ä¼‘çœ 2sï¼Œ2sæœŸé—´ï¼Œæ¡¶æ¯ç§’ç”Ÿäº§2ä¸ªä»¤ç‰Œï¼Œ2såˆšå¥½4ä¸ªï¼Œæ•…ç¡é†’å æ‰“å° 3 2 1 0ï¼Œä»¥æ­¤ç±»æ¨</p> <h3 id="_5-åˆå§‹åŒ–ä»¤ç‰Œæ•°é‡"><a href="#_5-åˆå§‹åŒ–ä»¤ç‰Œæ•°é‡" class="header-anchor">#</a> 5. åˆå§‹åŒ–ä»¤ç‰Œæ•°é‡</h3> <p>ã€<strong>æ¡¶çš„å®¹é‡</strong>ã€å’Œæ¡¶ä¸­çš„ã€<strong>ä»¤ç‰Œçš„æ•°é‡</strong>ã€æ˜¯ä¸¤ä¸ªæ¦‚å¿µã€‚</p> <p>é»˜è®¤æƒ…å†µä¸‹ï¼ˆä¸Šè¿°ä¾‹å­ä¸­ï¼‰ï¼Œåœ¨åˆ›å»ºæ¡¶å¯¹è±¡ä¹‹åï¼Œæ¡¶éƒ½æ˜¯æ»¡çš„ã€‚</p> <p>ä¸è¿‡ï¼Œä½ å¯èƒ½ä¸éœ€è¦è¿™ç§æƒ…å†µã€‚è¿™æ—¶ï¼Œä½ éœ€è¦åœ¨åˆ›å»ºæ¡¶æ—¶ä½¿ç”¨ <strong>withInitialTokens</strong> æ–¹æ³•æŒ‡å®šå…¶ä¸­çš„ä»¤ç‰Œæ•°é‡ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">long</span> bucketSize <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token class-name">Refill</span> filler <span class="token operator">=</span> <span class="token class-name">Refill</span><span class="token punctuation">.</span><span class="token function">greedy</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//æ¯ç§’2ä¸ªä»¤ç‰Œï¼Œæ¯ç§’ç”Ÿäº§çš„ä»¤ç‰Œä¸èƒ½å¤§äº9</span>
<span class="token comment">// çœ‹è¿™é‡Œï¼Œçœ‹è¿™é‡Œï¼Œçœ‹è¿™é‡Œã€‚ åˆå§‹åŒ–æ—¶ æ¡¶çš„å¤§å°æ˜¯9ï¼Œè¿™ä¸ªæ—¶å€™æ¡¶é‡Œé¢çš„ä»¤ç‰Œæ•°é‡æ˜¯5ä¸ªï¼Œåˆå§‹åŒ–æ•°é‡ä¸èƒ½å¤§äº9ï¼Œ</span>
<span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">classic</span><span class="token punctuation">(</span>bucketSize<span class="token punctuation">,</span> filler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withInitialTokens</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//åˆå§‹åŒ–æ¡¶çš„æ•°é‡æ˜¯5ä¸ª</span>
<span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ConsumptionProbe</span> probe <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">tryConsumeAndReturnRemaining</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>probe<span class="token punctuation">.</span><span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}: å‰©ä½™ä»¤ç‰Œ {}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>ISO_TIME<span class="token punctuation">)</span><span class="token punctuation">,</span> probe<span class="token punctuation">.</span><span class="token function">getRemainingTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;waiting...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
</code></pre></div><h3 id="_6-éè´ªå©ªå¼åˆ›å»ºä»¤ç‰Œ"><a href="#_6-éè´ªå©ªå¼åˆ›å»ºä»¤ç‰Œ" class="header-anchor">#</a> 6. éè´ªå©ªå¼åˆ›å»ºä»¤ç‰Œ</h3> <p>åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­ï¼Œä»¤ç‰Œçš„åˆ›å»ºæ–¹å¼éƒ½æ˜¯è´ªå©ªå¼çš„ã€‚æ‰€è°“è´ªå©ªå¼ï¼ŒæŒ‡çš„å°±æ˜¯åœ¨æ¯ä¸€æ¬¡çš„æ·»åŠ ä»¤ç‰Œçš„å‘¨æœŸä¸­ï¼Œåªè¦æœ‰åˆ›å»ºäº†ä»¤ç‰Œå°±å¼€å§‹æ¶ˆè´¹ï¼Œæ˜¯éè´ªå©ªå¼å°±æ˜¯è¯´å¿…é¡»ç­‰ä¸€æ¬¡æ€§ç­‰åˆ°æ‰€æœ‰çš„ä»¤ç‰Œéƒ½åˆ›å»ºå®Œæˆä¹‹åæ‰å¼€å§‹æ¶ˆè´¹ï¼Œä¸è¿‡æœ‰æ—¶ï¼Œä½ å¯èƒ½éœ€è¦è¿™ä¸ªæ·»åŠ è¿‡ç¨‹æ›´å‡åŒ€ä¸€äº›ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä½ å°±éœ€è¦ä½¿ç”¨ Refill.intervally æ–¹æ³•ã€‚</p> <p>ä¸è¿‡æœ‰æ—¶ï¼Œä½ å¯èƒ½éœ€è¦è¿™ä¸ªæ·»åŠ è¿‡ç¨‹æ›´å‡åŒ€ä¸€äº›ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä½ å°±éœ€è¦ä½¿ç”¨ <strong>Refill.intervally</strong> æ–¹æ³•ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">long</span> bucketSize <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token class-name">Refill</span> filler <span class="token operator">=</span> <span class="token class-name">Refill</span><span class="token punctuation">.</span><span class="token function">intervally</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">classic</span><span class="token punctuation">(</span>bucketSize<span class="token punctuation">,</span> filler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withInitialTokens</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–æ¢é’ˆ</span>
        <span class="token class-name">ConsumptionProbe</span> probe <span class="token operator">=</span> bucket<span class="token punctuation">.</span><span class="token function">tryConsumeAndReturnRemaining</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// åˆ¤æ–­æ˜¯å¦èƒ½æ¶ˆè€—</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>probe<span class="token punctuation">.</span><span class="token function">isConsumed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> time <span class="token operator">=</span> <span class="token class-name">LocalTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">DateTimeFormatter</span><span class="token punctuation">.</span>ISO_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æŸ¥è¯¢å‰©ä½™ä»¤ç‰Œæ•°é‡</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{} å‰©ä½™ä»¤ç‰Œ: {}&quot;</span><span class="token punctuation">,</span> time<span class="token punctuation">,</span> probe<span class="token punctuation">.</span><span class="token function">getRemainingTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="gateway-é™æµ"><a href="#gateway-é™æµ" class="header-anchor">#</a> Gateway é™æµ</h2> <p>é™æµçš„ç›®çš„æ—¶é€šè¿‡å¯¹å¹¶å‘è®¿é—®æ¥å£æ–¹æ³•ï¼ˆæˆ–å¯¹ä¸€ä¸ªæ—¶é—´çª—å£å†…çš„è¯·æ±‚ï¼‰è¿›è¡Œé™é€Ÿï¼Œä¸€æ—¦è¾¾åˆ°é™åˆ¶é€Ÿç‡åˆ™å¯ä»¥æ‹’ç»æœåŠ¡ã€‚</p> <p>ç½‘å…³å°±è¦é€šè¿‡é™æµæ¥æ‰¿æ‹…ä¿æŠ¤åç«¯åº”ç”¨çš„è´£ä»»ã€‚</p> <h3 id="_1-é™æµç­–ç•¥"><a href="#_1-é™æµç­–ç•¥" class="header-anchor">#</a> 1. é™æµç­–ç•¥</h3> <p>å¸¸è§çš„ç®—æ³•æœ‰ã€<strong>ä»¤ç‰Œæ¡¶</strong>ã€å’Œã€<strong>æ¼æ¡¶</strong>ã€ä¸¤ç§æ–¹æ¡ˆã€‚</p> <p>ã€æ¼æ¡¶ã€çš„æ€è·¯ç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—çš„å·¥ä½œå½¢å¼ï¼Œè¯·æ±‚ï¼ˆç±»æ¯”äºæ°´ï¼‰å…ˆè¿›å…¥åˆ°æ¼æ¡¶çš„ï¼Œæ¼æ¡¶ä»¥ä¸€å®šçš„é€Ÿç‡å‡ºï¼ˆæ¼ï¼‰æ°´ã€‚</p> <p>å½“æ°´æµå…¥çš„é€Ÿåº¦è¿‡å¤§å°±ä¼šç›´æ¥åœ¨æ¡¶ä¸­æœ‰ç§¯æ”’ï¼Œä¸€æ—¦ç§¯æ”’é‡è¶…è¿‡æ¼æ¡¶ä¸Šé™ï¼Œå†æµå…¥çš„æ°´å°±ä¼šæº¢å‡ºã€‚</p> <p>ã€ä»¤ç‰Œæ¡¶ã€çš„æ€è·¯å’Œæ¼æ¡¶ç›¸åã€‚åœ¨ç³»ç»Ÿè¿è¡ŒæœŸé—´ï¼Œç³»ç»ŸæŒ‰ç…§æ’å®šæ—¶é—´é—´éš”å®šæœŸå‘æ¡¶ä¸­åŠ å…¥ä»¤ç‰Œï¼ˆTokenï¼‰ï¼Œå¦‚æœæ¡¶å·²ç»æ»¡äº†ï¼Œå°±ä¸å†å¢åŠ ã€‚</p> <p>å½“æ–°çš„è¯·æ±‚æ¥ä¸´æ—¶ï¼Œä¼šæ‹¿èµ°ä»¤ç‰Œï¼Œæœ‰ä»¤ç‰Œåˆ™æ„å‘³ç€æœ‰èµ„æ ¼è¿›è¡Œè¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰ä»¤ç‰Œå¯èƒ½å°±ä¼šé˜»å¡æˆ–è€…æ‹’ç»ã€‚</p> <h3 id="_2-gateway-è‡ªå®šä¹‰è¿‡æ»¤å™¨é™æµ"><a href="#_2-gateway-è‡ªå®šä¹‰è¿‡æ»¤å™¨é™æµ" class="header-anchor">#</a> 2. Gateway è‡ªå®šä¹‰è¿‡æ»¤å™¨é™æµ</h3> <p>åœ¨ Gateway ä¸­å®ç°é™æµæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ªè¿‡æ»¤å™¨ã€‚</p> <p>RateLimiterï¼ˆGuavaï¼‰ã€Bucket4jã€RateLimitJ éƒ½æ˜¯åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°çš„é™æµå·¥å…·ã€‚</p> <blockquote><p>Bucket4j çš„ä½¿ç”¨è§å¦ä¸€ç¯‡ç¬”è®°ã€ŠBucket4jã€‹</p></blockquote> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--Bucket4j ä»¤ç‰Œæ¡¶--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.vladimir-bukhtoyarov<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bucket4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><blockquote><p>ç¼–å†™è‡ªå®šä¹‰è¿‡æ»¤å™¨ <strong>GatewayRateLimitFilter</strong> å¹¶å®ç° GatewayFilterï¼ˆå’Œ Orderedï¼‰æ¥å£ã€‚</p> <p>å…¨å±€ä¸éœ€è¦åŠ å…¥é…ç½® è‡ªåŠ¨å¯ç”¨</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>apai<span class="token punctuation">.</span>filters</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Bandwidth</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Bucket</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Bucket4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">io<span class="token punctuation">.</span>github<span class="token punctuation">.</span>bucket4j<span class="token punctuation">.</span></span><span class="token class-name">Refill</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span><span class="token class-name">GlobalFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">Ordered</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span></span><span class="token class-name">DataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Flux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher<span class="token punctuation">.</span></span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>function<span class="token punctuation">.</span></span><span class="token class-name">Function</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GatewayRateLimitFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span> <span class="token punctuation">{</span>

    <span class="token comment">// å¦‚æœè¦å¯åŠ¨ç½‘å…³çš„å¤šä¸ªå®ä¾‹ï¼Œé‚£ä¹ˆå°±éœ€è¦å°† ip å’Œæ¡¶çš„é”®å€¼å¯¹ä¿¡æ¯å­˜åˆ° Redis ä¸­ã€‚</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Bucket</span><span class="token punctuation">&gt;</span></span> LOCAL_CACHE <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> capacity<span class="token punctuation">;</span> <span class="token comment">//æ¡¶å®¹é‡</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> refillTokens<span class="token punctuation">;</span><span class="token comment">//  å®šæ—¶æ·»åŠ tokençš„æ•°é‡  å¦‚æ¯ç§’æ·»åŠ å‡ ä¸ªtoken</span>
    <span class="token keyword">private</span> <span class="token class-name">Duration</span> refillDuration<span class="token punctuation">;</span><span class="token comment">//æ·»åŠ å‘¨æœŸ   å‘¨æœŸ ï¼š å¦‚ æ¯ç§’</span>

    <span class="token keyword">public</span> <span class="token class-name">GatewayRateLimitFilter</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">,</span> <span class="token keyword">int</span> refillTokens<span class="token punctuation">,</span> <span class="token class-name">Duration</span> refillDuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>capacity <span class="token operator">=</span> capacity<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refillTokens <span class="token operator">=</span> refillTokens<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>refillDuration <span class="token operator">=</span> refillDuration<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">GatewayRateLimitFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// capacity: åˆå§‹10æ¡¶ | refillTokens: æ—¶é—´å†…ç”Ÿæˆ5ä¸ªæ¡¶ | Duration.ofSeconds(æ—¶é—´)</span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//è·å–è¯·æ±‚çš„ ä¸»æœºip å¦‚: localhost</span>
        <span class="token comment">//String ip = exchange.getRequest().getRemoteAddress().getAddress().getHostAddress();</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// è·å–è¯·æ±‚çš„è·¯å¾„ å¦‚: user/add</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//è·å–url</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//computeIfAbsentï¼š å¦‚æœæ²¡æœ‰æŸä¸ªkeyï¼Œåˆ™æ·»åŠ æŸä¸ªkey-valueï¼Œå¦åˆ™è¿”å›è¯¥keyå¯¹åº”çš„value</span>
        <span class="token comment">//å¯¹åŒä¸€å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œä¸åŒçš„æ¥å£è¯·æ±‚éƒ½åšäº†é™æµ</span>
        <span class="token class-name">Bucket</span> bucket <span class="token operator">=</span> LOCAL_CACHE<span class="token punctuation">.</span><span class="token function">computeIfAbsent</span><span class="token punctuation">(</span>ip <span class="token operator">+</span> url<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Bucket</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Bucket</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">createNewBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;IP:{}ï¼Œä»¤ç‰Œæ¡¶å¯ç”¨çš„ token æ•°é‡ï¼š{}&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">,</span> bucket<span class="token punctuation">.</span><span class="token function">getAvailableTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bucket<span class="token punctuation">.</span><span class="token function">tryConsume</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// å½“ä»¤ç‰Œæ•°é‡ä¸ºé›¶æ—¶ ç½‘å…³ä¼šæ‹’ç»è½¬å‘ å¹¶è¿”å›æç¤ºä¿¡æ¯</span>
            exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>TOO_MANY_REQUESTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> jsonStr <span class="token operator">=</span> <span class="token string">&quot;{\&quot;status\&quot;:\&quot;886\&quot;, \&quot;msg\&quot;:\&quot;è¯·æ±‚è¿‡äºé¢‘ç¹\&quot;}&quot;</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> jsonStr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBuffer</span> dataBuffer <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>dataBuffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// è¯·æ±‚å¤ªé¢‘ç¹äº†  è¯·å°‘ç¨åå†è¯•</span>
            <span class="token comment">// return exchange.getResponse().setComplete();</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//ç”Ÿæˆä¸€ä¸ªæ¡¶</span>
    <span class="token keyword">private</span> <span class="token class-name">Bucket</span> <span class="token function">createNewBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//æ¯ç§’ä¸­ç”Ÿäº§ä¸€ä¸ªtoken</span>
        <span class="token class-name">Refill</span> refill <span class="token operator">=</span> <span class="token class-name">Refill</span><span class="token punctuation">.</span><span class="token function">greedy</span><span class="token punctuation">(</span>refillTokens<span class="token punctuation">,</span> refillDuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Bandwidth</span> limit <span class="token operator">=</span> <span class="token class-name">Bandwidth</span><span class="token punctuation">.</span><span class="token function">classic</span><span class="token punctuation">(</span>capacity<span class="token punctuation">,</span> refill<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Bucket4j</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLimit</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>é€šè¿‡é…ç½®æ–‡ä»¶æˆ–ä»£ç é…ç½®å¹¶ä½¿ç”¨ Filter ã€‚</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaGatewayApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token class-name">RouteLocator</span> <span class="token function">customerRouteLocator</span><span class="token punctuation">(</span><span class="token class-name">RouteLocatorBuilder</span> builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> intercept <span class="token operator">=</span> <span class="token string">&quot;/test&quot;</span><span class="token punctuation">;</span>  <span class="token comment">//  ä¸è¦å†™æˆ String intercept = &quot;/test/&quot;</span>
    <span class="token class-name">String</span> target <span class="token operator">=</span> <span class="token string">&quot;http://localhost:8081&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">GatewayFilter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GatewayRateLimitFilter</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> builder<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">route</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token function">path</span><span class="token punctuation">(</span>intercept<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filters</span><span class="token punctuation">(</span>f <span class="token operator">-&gt;</span> f<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token string">&quot;rateLimit_route&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>é…ç½®æ–‡ä»¶ï¼š</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>gateway
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
      <span class="token key atrule">routes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">id</span><span class="token punctuation">:</span> 163_route
          <span class="token key atrule">uri</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span><span class="token number">8081</span>
          <span class="token key atrule">predicates</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> Path=/test
          <span class="token key atrule">filters</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> yyy
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">locator</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">lower-case-service-id</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10086/eureka
    <span class="token key atrule">registry-fetch-interval-seconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre></div><p>è§‚å¯Ÿè¿è¡Œæ•ˆæœï¼Œå½“å¯ç”¨ä»¤ç‰Œæ•°é‡ä¸º 0 æ—¶ï¼ŒGateway ä¸­çš„è‡ªå®šä¹‰é™æµå™¨ä¼šå¼€å§‹æ‹’ç»æ”¾è¡Œè¯·æ±‚ï¼Œç›´æ¥è¿”å› 429 çŠ¶æ€ç </p> <h2 id="nacos-å¾®æœåŠ¡-æ€»æ±‡"><a href="#nacos-å¾®æœåŠ¡-æ€»æ±‡" class="header-anchor">#</a> ||-&gt; Nacos  å¾®æœåŠ¡ æ€»æ±‡</h2> <h3 id="ä¾èµ–-2"><a href="#ä¾èµ–-2" class="header-anchor">#</a> ä¾èµ–</h3> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>2.3.7.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-boot.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Nacos ç‰ˆæœ¬ç®¡ç†--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>2.2.2.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud-alibaba.version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Nacos è‡ªåŠ¨æ³¨å†Œä¾èµ–--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Nacos é…ç½®ä¸­å¿ƒ é…ç½®æ–‡ä»¶å­˜æ”¾æ³¨å†Œä¸­å¿ƒ--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Gateway æœåŠ¡ç½‘å…³ æ— éœ€webèµ‹å€¼æŠ¥é”™--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-gateway<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Hystrixç†”æ–­ æœåŠ¡é™çº§--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--Bucket4j ä»¤ç‰Œæ¡¶--&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.vladimir-bukhtoyarov<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>bucket4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.10.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--Nacos ç®¡ç†--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud-alibaba.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="nacos-æ³¨è§£-2"><a href="#nacos-æ³¨è§£-2" class="header-anchor">#</a> Nacos  æ³¨è§£</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// ---- å¯åŠ¨ç±» ----</span>
<span class="token comment">// å¯åŠ¨ç±» è§£å†³ ä½¿ç”¨äº† mybatis-plus ä½†æ˜¯æ²¡é…ç½® æ•°æ®åº“ä¿¡æ¯åˆ™å¯åŠ¨æŠ¥é”™ å¦‚æœé…ç½®åœ¨ä½¿ç”¨è¯¥æ³¨è§£æ’é™¤åˆ™æŠ¥é”™</span>
<span class="token annotation punctuation">@SpringBootApplication</span><span class="token punctuation">(</span>exclude <span class="token operator">=</span> <span class="token class-name">DataSourceAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token comment">// å¯ç”¨ nacos çš„æœåŠ¡å‘ç°</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span> 

<span class="token comment">// ---- è¿‡æ»¤å™¨ ----</span>
<span class="token comment">// æ§åˆ¶å…¨å±€è¿‡æ»¤å™¨çš„å…ˆåé¡ºåºï¼Œä¸æ˜¯å±€éƒ¨çš„é¡ºåºï¼Œå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ã€‚</span>
<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span> 
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="pager"><a href="/Welcome/post/2021/07/07/vue-3-%E7%BB%84%E5%90%88%E5%BC%8F-api/" class="next">
    ä¸‹ä¸€ç¯‡<br> <span>
      Vue3 ç»„åˆå¼API
    </span></a> <a href="/Welcome/post/2021/05/07/rabbitmq-%E8%AF%A6%E8%A7%A3/" class="previous">
    ä¸Šä¸€ç¯‡<br> <span>
      RabbitMQ è¯¦è§£
    </span></a></div> <!----></main> <ul class="catalog" style="top:0px !important;" data-v-86932056><li class="level-2 toc-link-é›†ç¾¤ä¸åˆ†å¸ƒå¼" data-v-86932056>é›†ç¾¤ä¸åˆ†å¸ƒå¼</li><li class="level-2 toc-link-boot-å’Œ-config-çš„åŒºåˆ«" data-v-86932056>Boot å’Œ Config çš„åŒºåˆ«</li><li class="level-2 toc-link-eureka-ä¸-nacos-çš„åŒºåˆ«" data-v-86932056>Eureka ä¸ Nacos çš„åŒºåˆ«</li><li class="level-2 toc-link-springcloud-config-å¾®æœåŠ¡" data-v-86932056>Springcloud Config å¾®æœåŠ¡</li><li class="level-3 toc-link-æœåŠ¡è°ƒç”¨æ–¹å¼" data-v-86932056>æœåŠ¡è°ƒç”¨æ–¹å¼</li><li class="level-3 toc-link-httpå®¢æˆ·ç«¯å·¥å…·" data-v-86932056>Httpå®¢æˆ·ç«¯å·¥å…·</li><li class="level-2 toc-link-spring-çš„-resttemplate-è¿œç¨‹è¯·æ±‚" data-v-86932056>Spring çš„ RestTemplate è¿œç¨‹è¯·æ±‚</li><li class="level-3 toc-link-å¸¸ç”¨æ–¹æ³•" data-v-86932056>å¸¸ç”¨æ–¹æ³•</li><li class="level-3 toc-link-å¾®æœåŠ¡å‡†å¤‡" data-v-86932056>å¾®æœåŠ¡å‡†å¤‡:</li><li class="level-3 toc-link-get-è¯·æ±‚" data-v-86932056>Get  è¯·æ±‚</li><li class="level-4 toc-link-_1-å ä½ç¬¦ä¼ å‚" data-v-86932056>1.å ä½ç¬¦ä¼ å‚</li><li class="level-4 toc-link-_2-mapä¼ å‚" data-v-86932056>2.mapä¼ å‚</li><li class="level-4 toc-link-_3-uriæ–¹å¼ä¼ å‚" data-v-86932056>3.urIæ–¹å¼ä¼ å‚</li><li class="level-4 toc-link-_4-restä¼ å‚" data-v-86932056>4.restä¼ å‚</li><li class="level-3 toc-link-post-è¯·æ±‚" data-v-86932056>Post  è¯·æ±‚</li><li class="level-4 toc-link-postforentity" data-v-86932056>postForEntity</li><li class="level-5 toc-link-ä¼ é€’-key-value" data-v-86932056>ä¼ é€’ key-value</li><li class="level-5 toc-link-å•ä¸ª-å¯¹è±¡-ä¼ å‚" data-v-86932056>å•ä¸ª å¯¹è±¡ ä¼ å‚</li><li class="level-5 toc-link-ä¼ é€’jsonå‚æ•°" data-v-86932056>ä¼ é€’JSONå‚æ•°</li><li class="level-4 toc-link-postforobject" data-v-86932056>postForObject</li><li class="level-5 toc-link-ä¼ é€’-javabean" data-v-86932056>ä¼ é€’ javaBean</li><li class="level-4 toc-link-postforlocation" data-v-86932056>postForLocation</li><li class="level-3 toc-link-resttemplateåº•å±‚å®ç°åˆ‡æ¢" data-v-86932056>RestTemplateåº•å±‚å®ç°åˆ‡æ¢</li><li class="level-2 toc-link-eureka-æ³¨å†Œä¸­å¿ƒ-ç»„ä»¶" data-v-86932056>|-- Eureka æ³¨å†Œä¸­å¿ƒ ç»„ä»¶</li><li class="level-3 toc-link-åŸºç¡€æ¶æ„" data-v-86932056>åŸºç¡€æ¶æ„</li><li class="level-3 toc-link-eurekaserver-å®¢æˆ·ç«¯-æœåŠ¡ä¸­å¿ƒ" data-v-86932056>EurekaServer å®¢æˆ·ç«¯ æœåŠ¡ä¸­å¿ƒ</li><li class="level-4 toc-link-pom-ä¾èµ–" data-v-86932056>pom ä¾èµ–</li><li class="level-4 toc-link-application-yml" data-v-86932056>application.yml</li><li class="level-4 toc-link-å¯åŠ¨ç±»" data-v-86932056>å¯åŠ¨ç±»</li><li class="level-3 toc-link-eurekaserver-æœåŠ¡ç«¯-æä¾›ç«¯å£" data-v-86932056>EurekaServer æœåŠ¡ç«¯ æä¾›ç«¯å£</li><li class="level-4 toc-link-pom-ä¾èµ–-2" data-v-86932056>pom ä¾èµ–</li><li class="level-4 toc-link-å¯åŠ¨ç±»-2" data-v-86932056>å¯åŠ¨ç±»</li><li class="level-3 toc-link-eurekaserver-è°ƒç”¨æ–¹-ä½¿ç”¨ç«¯å£" data-v-86932056>EurekaServer è°ƒç”¨æ–¹ ä½¿ç”¨ç«¯å£</li><li class="level-4 toc-link-pom-ä¾èµ–-3" data-v-86932056>pom ä¾èµ–</li><li class="level-4 toc-link-application-yml-2" data-v-86932056>application.yml</li><li class="level-4 toc-link-å¯åŠ¨ç±»-3" data-v-86932056>å¯åŠ¨ç±»</li><li class="level-4 toc-link-è¡¨ç°å±‚-è°ƒç”¨" data-v-86932056>è¡¨ç°å±‚-è°ƒç”¨</li><li class="level-2 toc-link-eureka-server-é«˜å¯ç”¨æ€§" data-v-86932056>Eureka Server é«˜å¯ç”¨æ€§</li><li class="level-3 toc-link-eureka-server-é›†ç¾¤é…ç½®" data-v-86932056>Eureka Server é›†ç¾¤é…ç½®</li><li class="level-4 toc-link-ä¸€-application-yml" data-v-86932056>ä¸€.  application.yml</li><li class="level-4 toc-link-äºŒ-application-yml" data-v-86932056>äºŒ.  application.yml</li><li class="level-3 toc-link-è·å–æœåŠ¡åˆ—è¡¨" data-v-86932056>è·å–æœåŠ¡åˆ—è¡¨</li><li class="level-3 toc-link-å¤±æ•ˆå‰”é™¤å’Œè‡ªæˆ‘ä¿æŠ¤" data-v-86932056>å¤±æ•ˆå‰”é™¤å’Œè‡ªæˆ‘ä¿æŠ¤</li><li class="level-2 toc-link-ribbon-è´Ÿè½½å‡è¡¡-ç»„ä»¶" data-v-86932056>Ribbon  è´Ÿè½½å‡è¡¡ ç»„ä»¶</li><li class="level-3 toc-link-ç®€ä»‹" data-v-86932056>ç®€ä»‹</li><li class="level-3 toc-link-å¼€å¯è´Ÿè½½å‡è¡¡" data-v-86932056>å¼€å¯è´Ÿè½½å‡è¡¡</li><li class="level-3 toc-link-è´Ÿè½½å‡è¡¡ç­–ç•¥" data-v-86932056>è´Ÿè½½å‡è¡¡ç­–ç•¥</li><li class="level-3 toc-link-è´Ÿè½½å‡è¡¡-å†…ç½®ç­–ç•¥" data-v-86932056>è´Ÿè½½å‡è¡¡ å†…ç½®ç­–ç•¥</li><li class="level-3 toc-link-ribbon-çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•" data-v-86932056>Ribbon çš„è¶…æ—¶å’Œè¶…æ—¶é‡è¯•</li><li class="level-3 toc-link-ribbon-çš„é¥¥é¥¿åŠ è½½" data-v-86932056>Ribbon çš„é¥¥é¥¿åŠ è½½</li><li class="level-2 toc-link-hystrix-ç»„ä»¶" data-v-86932056>Hystrix ç»„ä»¶</li><li class="level-3 toc-link-hystrixç†”æ–­-æœåŠ¡é™çº§" data-v-86932056>Hystrixç†”æ–­ æœåŠ¡é™çº§</li><li class="level-4 toc-link-å¼•å…¥ä¾èµ–" data-v-86932056>å¼•å…¥ä¾èµ–</li><li class="level-4 toc-link-å¼€å¯hystrixç†”æ–­" data-v-86932056>å¼€å¯Hystrixç†”æ–­</li><li class="level-3 toc-link-ç¼–å†™é™çº§é€»è¾‘" data-v-86932056>ç¼–å†™é™çº§é€»è¾‘</li><li class="level-3 toc-link-é»˜è®¤-fallback" data-v-86932056>é»˜è®¤ FallBack</li><li class="level-3 toc-link-hystrix-è¶…æ—¶é…ç½®" data-v-86932056>Hystrix è¶…æ—¶é…ç½®</li><li class="level-3 toc-link-æœåŠ¡ç†”æ–­æœºåˆ¶" data-v-86932056>æœåŠ¡ç†”æ–­æœºåˆ¶</li><li class="level-4 toc-link-ç†”æ–­ç­–ç•¥é…ç½®" data-v-86932056>ç†”æ–­ç­–ç•¥é…ç½®</li><li class="level-2 toc-link-open-feign-è¿œç¨‹è°ƒç”¨ç»„ä»¶" data-v-86932056>Open Feign è¿œç¨‹è°ƒç”¨ç»„ä»¶</li><li class="level-3 toc-link-open-feign-åˆ›å»º" data-v-86932056>Open Feign åˆ›å»º</li><li class="level-4 toc-link-å¼•å…¥ä¾èµ–-2" data-v-86932056>å¼•å…¥ä¾èµ–</li><li class="level-4 toc-link-application-yaml" data-v-86932056>application.yaml</li><li class="level-4 toc-link-å¯åŠ¨ç±»-æ³¨è§£" data-v-86932056>å¯åŠ¨ç±» æ³¨è§£</li><li class="level-4 toc-link-åˆ›å»ºfeignçš„å®¢æˆ·ç«¯-æ¥å£" data-v-86932056>åˆ›å»ºFeignçš„å®¢æˆ·ç«¯ æ¥å£</li><li class="level-4 toc-link-è°ƒç”¨æ–¹-è¡¨ç°å±‚" data-v-86932056>è°ƒç”¨æ–¹ è¡¨ç°å±‚</li><li class="level-4 toc-link-æœåŠ¡æ–¹" data-v-86932056>æœåŠ¡æ–¹</li><li class="level-2 toc-link-open-feign-è¯·æ±‚æ³¨è§£" data-v-86932056>Open Feign è¯·æ±‚æ³¨è§£</li><li class="level-3 toc-link-token-é—®é¢˜" data-v-86932056>token é—®é¢˜</li><li class="level-3 toc-link-restful-é£æ ¼è¯·æ±‚" data-v-86932056>Restful é£æ ¼è¯·æ±‚</li><li class="level-3 toc-link-get-è¯·æ±‚-2" data-v-86932056>Get è¯·æ±‚</li><li class="level-3 toc-link-post-è¯·æ±‚-2" data-v-86932056>Post è¯·æ±‚</li><li class="level-2 toc-link-open-feign-å†…ç½®-hystrix-ç†”æ–­" data-v-86932056>Open Feign å†…ç½® Hystrix ç†”æ–­</li><li class="level-3 toc-link-open-feign-ç†”æ–­" data-v-86932056>Open Feign ç†”æ–­</li><li class="level-3 toc-link-open-feign-ç†”æ–­é™çº§" data-v-86932056>Open Feign ç†”æ–­é™çº§</li><li class="level-3 toc-link-è¶…æ—¶å’Œè¶…æ—¶é‡è¯•" data-v-86932056>è¶…æ—¶å’Œè¶…æ—¶é‡è¯•</li><li class="level-3 toc-link-å¦‚ä½•æ›¿æ¢åº•å±‚ç”¨httpå®ç°" data-v-86932056>å¦‚ä½•æ›¿æ¢åº•å±‚ç”¨HTTPå®ç°</li><li class="level-3 toc-link-æ—¥å¿—çº§åˆ«-äº†è§£" data-v-86932056>æ—¥å¿—çº§åˆ«(äº†è§£)</li><li class="level-2 toc-link-zuul-ç½‘å…³ç»„ä»¶" data-v-86932056>Zuul ç½‘å…³ç»„ä»¶</li><li class="level-3 toc-link-zuul-ç½‘å…³ç»„ä»¶-ç®€ä»‹" data-v-86932056>Zuul ç½‘å…³ç»„ä»¶ ç®€ä»‹</li><li class="level-3 toc-link-zuul-æ¶æ„" data-v-86932056>Zuul æ¶æ„</li><li class="level-4 toc-link-pom-æ–‡ä»¶å¯¼å…¥" data-v-86932056>pom  æ–‡ä»¶å¯¼å…¥</li><li class="level-4 toc-link-ç¼–å†™-é…ç½®" data-v-86932056>ç¼–å†™ é…ç½®</li><li class="level-4 toc-link-å¯åŠ¨ç±»-4" data-v-86932056>å¯åŠ¨ç±»</li><li class="level-3 toc-link-å…¶ä»–é…ç½®" data-v-86932056>å…¶ä»–é…ç½®</li><li class="level-4 toc-link-_1ã€è·¯ç”±å‰ç¼€" data-v-86932056>1ã€è·¯ç”±å‰ç¼€</li><li class="level-4 toc-link-_2ã€ä¸å»é™¤æ˜ å°„è·¯å¾„å‰ç¼€" data-v-86932056>2ã€ä¸å»é™¤æ˜ å°„è·¯å¾„å‰ç¼€</li><li class="level-4 toc-link-_3ã€å…³é—­é»˜è®¤é…ç½®è®¿é—®" data-v-86932056>3ã€å…³é—­é»˜è®¤é…ç½®è®¿é—®</li><li class="level-3 toc-link-zuulfilter-è¿‡æ»¤å™¨" data-v-86932056>ZuulFilter  è¿‡æ»¤å™¨</li><li class="level-4 toc-link-zuulfilter" data-v-86932056>ZuulFilter</li><li class="level-4 toc-link-è¿‡æ»¤å™¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ" data-v-86932056>è¿‡æ»¤å™¨æ‰§è¡Œç”Ÿå‘½å‘¨æœŸ</li><li class="level-3 toc-link-å®šä¹‰è¿‡æ»¤å™¨ç±»" data-v-86932056>å®šä¹‰è¿‡æ»¤å™¨ç±»</li><li class="level-3 toc-link-å¸¸ç”¨-è¿‡æ»¤å™¨-æ¨¡æ¿" data-v-86932056>å¸¸ç”¨ è¿‡æ»¤å™¨ æ¨¡æ¿</li><li class="level-4 toc-link-pre-è¿‡æ»¤å™¨-æ£€éªŒ-token" data-v-86932056>pre è¿‡æ»¤å™¨ æ£€éªŒ token</li><li class="level-4 toc-link-post-è¿‡æ»¤å™¨-è·å–å¼‚å¸¸" data-v-86932056>post è¿‡æ»¤å™¨ è·å–å¼‚å¸¸</li><li class="level-3 toc-link-zuul-ä¸-hystrix-ç»“åˆå®ç°ç†”æ–­" data-v-86932056>Zuul ä¸ Hystrix ç»“åˆå®ç°ç†”æ–­</li><li class="level-4 toc-link-zuul-ä¸-hystrix-é™çº§" data-v-86932056>Zuul ä¸ Hystrix é™çº§</li><li class="level-3 toc-link-zuul-ä¸­çš„-eager-load-é…ç½®" data-v-86932056>Zuul ä¸­çš„ Eager Load é…ç½®</li><li class="level-3 toc-link-ç¦ç”¨-zuul-è¿‡æ»¤å™¨" data-v-86932056>ç¦ç”¨ zuul è¿‡æ»¤å™¨</li><li class="level-2 toc-link-eureka-å¾®æœåŠ¡-æ€»æ±‡" data-v-86932056>||-&gt; Eureka å¾®æœåŠ¡ æ€»æ±‡</li><li class="level-3 toc-link-ä¾èµ–" data-v-86932056>ä¾èµ–</li><li class="level-3 toc-link-eureka-æ³¨è§£" data-v-86932056>Eureka æ³¨è§£</li><li class="level-2 toc-link-springconfig-nacos-å¾®æœåŠ¡" data-v-86932056>SpringConfig-Nacos å¾®æœåŠ¡</li><li class="level-3 toc-link-nacos-çš„ä¸‹è½½å’Œå®‰è£…" data-v-86932056>Nacos çš„ä¸‹è½½å’Œå®‰è£…</li><li class="level-2 toc-link-nacos-æ³¨å†Œä¸­å¿ƒ" data-v-86932056>|-- Nacos æ³¨å†Œä¸­å¿ƒ</li><li class="level-3 toc-link-nacos-æ³¨å†Œ-æ­¥éª¤" data-v-86932056>Nacos æ³¨å†Œ æ­¥éª¤</li><li class="level-4 toc-link-nacos-ä¾èµ–" data-v-86932056>Nacos  ä¾èµ–</li><li class="level-4 toc-link-nacos-æ³¨è§£" data-v-86932056>Nacos  æ³¨è§£</li><li class="level-3 toc-link-nacos-é…ç½®ä¸­å¿ƒ" data-v-86932056>Nacos  é…ç½®ä¸­å¿ƒ</li><li class="level-4 toc-link-nacos-é…ç½®ä¸­å¿ƒ-æ³¨è§£" data-v-86932056>Nacos é…ç½®ä¸­å¿ƒ æ³¨è§£</li><li class="level-4 toc-link-æ–°å»ºé…ç½®æ–‡ä»¶-bootstrap-yml" data-v-86932056>æ–°å»ºé…ç½®æ–‡ä»¶ bootstrap.yml</li><li class="level-4 toc-link-åœ¨-nacos-æ·»åŠ é…ç½®" data-v-86932056>åœ¨ Nacos æ·»åŠ é…ç½®</li><li class="level-3 toc-link-å¾®æœåŠ¡-group-åˆ†ç»„" data-v-86932056>å¾®æœåŠ¡ group åˆ†ç»„</li><li class="level-3 toc-link-éªŒè¯å’ŒåŠ¨æ€åˆ·æ–°" data-v-86932056>éªŒè¯å’ŒåŠ¨æ€åˆ·æ–°</li><li class="level-3 toc-link-nacos-çš„æ•°æ®å­˜å‚¨" data-v-86932056>Nacos çš„æ•°æ®å­˜å‚¨</li><li class="level-4 toc-link-windos-æ•°æ®åº“å‚¨å­˜ä¿®æ”¹" data-v-86932056>windos æ•°æ®åº“å‚¨å­˜ä¿®æ”¹</li><li class="level-4 toc-link-liunx-ç³»ç»Ÿ-ä¿®æ”¹" data-v-86932056>Liunx ç³»ç»Ÿ ä¿®æ”¹</li><li class="level-3 toc-link-nacos-é›†ç¾¤é…ç½®" data-v-86932056>nacos é›†ç¾¤é…ç½®</li><li class="level-2 toc-link-gateway-æœåŠ¡ç½‘å…³" data-v-86932056>Gateway æœåŠ¡ç½‘å…³</li><li class="level-3 toc-link-gateway-ç½‘å…³åˆ›å»º" data-v-86932056>Gateway ç½‘å…³åˆ›å»º</li><li class="level-4 toc-link-å¯¼å…¥ä¾èµ–" data-v-86932056>å¯¼å…¥ä¾èµ–</li><li class="level-4 toc-link-è·¯ç”±é…ç½®" data-v-86932056>è·¯ç”±é…ç½®</li><li class="level-4 toc-link-gateway-è·¯ç”±è½¬å‘è¯¦è§£" data-v-86932056>Gateway è·¯ç”±è½¬å‘è¯¦è§£</li><li class="level-3 toc-link-gateway-è·¯ç”±æ–­è¨€" data-v-86932056>Gateway  è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-path-è·¯ç”±æ–­è¨€" data-v-86932056>Path è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-after-è·¯ç”±æ–­è¨€" data-v-86932056>After è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-before-è·¯ç”±æ–­è¨€" data-v-86932056>Before è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-between-è·¯ç”±æ–­è¨€" data-v-86932056>Between è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-cookie-è·¯ç”±æ–­è¨€" data-v-86932056>Cookie è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-header-è·¯ç”±æ–­è¨€" data-v-86932056>Header è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-method-è·¯ç”±æ–­è¨€" data-v-86932056>Method è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-query-è·¯ç”±æ–­è¨€" data-v-86932056>Query è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-ç»„åˆä½¿ç”¨" data-v-86932056>ç»„åˆä½¿ç”¨</li><li class="level-3 toc-link-è‡ªå®šä¹‰è·¯ç”±æ–­è¨€" data-v-86932056>è‡ªå®šä¹‰è·¯ç”±æ–­è¨€</li><li class="level-4 toc-link-è‡ªå®šä¹‰è·¯ç”±æ–­è¨€ç±»" data-v-86932056>è‡ªå®šä¹‰è·¯ç”±æ–­è¨€ç±»</li><li class="level-4 toc-link-è‡ªå®šä¹‰æ–­è¨€-é…ç½®" data-v-86932056>è‡ªå®šä¹‰æ–­è¨€ é…ç½®</li><li class="level-3 toc-link-å†…ç½®-filter-è¿‡æ»¤å™¨" data-v-86932056>å†…ç½® Filter è¿‡æ»¤å™¨</li><li class="level-4 toc-link-addrequestheader-è¿‡æ»¤å™¨" data-v-86932056>AddRequestHeader è¿‡æ»¤å™¨</li><li class="level-4 toc-link-stripprefix-è¿‡æ»¤-å»æ‰å‰ç¼€" data-v-86932056>StripPrefix è¿‡æ»¤ | å»æ‰å‰ç¼€</li><li class="level-4 toc-link-rewritepath-è¿‡æ»¤å™¨" data-v-86932056>RewritePath è¿‡æ»¤å™¨</li><li class="level-3 toc-link-è‡ªå®šä¹‰è·¯ç”±å±€éƒ¨-filter" data-v-86932056>è‡ªå®šä¹‰è·¯ç”±å±€éƒ¨ Filter</li><li class="level-4 toc-link-è‡ªå®šä¹‰-filter-å¼‚å¸¸å¤„ç†" data-v-86932056>è‡ªå®šä¹‰ Filter å¼‚å¸¸å¤„ç†</li><li class="level-5 toc-link-é…ç½®-æŒ‡å®š-è‡ªå®šä¹‰å¼‚å¸¸ç±»" data-v-86932056>é…ç½® æŒ‡å®š è‡ªå®šä¹‰å¼‚å¸¸ç±»</li><li class="level-5 toc-link-è‡ªå®šä¹‰è¿‡æ»¤å™¨" data-v-86932056>è‡ªå®šä¹‰è¿‡æ»¤å™¨</li><li class="level-5 toc-link-å¼‚å¸¸ä¿¡æ¯å°è£…ç±»" data-v-86932056>å¼‚å¸¸ä¿¡æ¯å°è£…ç±»</li><li class="level-5 toc-link-å¼‚å¸¸å¤„ç†ç±»" data-v-86932056>å¼‚å¸¸å¤„ç†ç±»</li><li class="level-4 toc-link-json-å½¢å¼çš„é”™è¯¯è¿”å›" data-v-86932056>JSON å½¢å¼çš„é”™è¯¯è¿”å›</li><li class="level-4 toc-link-è·å–-body-ä¸­çš„è¯·æ±‚å‚æ•°" data-v-86932056>è·å– Body ä¸­çš„è¯·æ±‚å‚æ•°</li><li class="level-4 toc-link-è¿‡æ»¤å™¨çš„å¦ä¸€ç§é€»è¾‘å½¢å¼" data-v-86932056>è¿‡æ»¤å™¨çš„å¦ä¸€ç§é€»è¾‘å½¢å¼</li><li class="level-4 toc-link-è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„å‚æ•°" data-v-86932056>è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„å‚æ•°</li><li class="level-3 toc-link-è‡ªå®šä¹‰å…¨å±€-filter" data-v-86932056>è‡ªå®šä¹‰å…¨å±€ Filter</li><li class="level-4 toc-link-å…¨å±€è¿‡æ»¤å™¨å¼‚å¸¸å¤„ç†" data-v-86932056>å…¨å±€è¿‡æ»¤å™¨å¼‚å¸¸å¤„ç†</li><li class="level-3 toc-link-è·¨åŸŸé…ç½®" data-v-86932056>è·¨åŸŸé…ç½®</li><li class="level-3 toc-link-gatewayç½‘å…³çš„ç†”æ–­é™çº§" data-v-86932056>Gatewayç½‘å…³çš„ç†”æ–­é™çº§</li><li class="level-2 toc-link-bucket4j-ä»¤ç‰Œ" data-v-86932056>Bucket4j  ä»¤ç‰Œ</li><li class="level-3 toc-link-_1-åŸºæœ¬ä½¿ç”¨" data-v-86932056>1. åŸºæœ¬ä½¿ç”¨</li><li class="level-3 toc-link-_2-é˜»å¡å¼æ¶ˆè´¹" data-v-86932056>2. é˜»å¡å¼æ¶ˆè´¹</li><li class="level-3 toc-link-_3-æ¢é’ˆ" data-v-86932056>3. æ¢é’ˆ</li><li class="level-3 toc-link-_4-refill-å’Œ-classic-æ–¹æ³•" data-v-86932056>4. Refill å’Œ classic æ–¹æ³•</li><li class="level-3 toc-link-_5-åˆå§‹åŒ–ä»¤ç‰Œæ•°é‡" data-v-86932056>5. åˆå§‹åŒ–ä»¤ç‰Œæ•°é‡</li><li class="level-3 toc-link-_6-éè´ªå©ªå¼åˆ›å»ºä»¤ç‰Œ" data-v-86932056>6. éè´ªå©ªå¼åˆ›å»ºä»¤ç‰Œ</li><li class="level-2 toc-link-gateway-é™æµ" data-v-86932056>Gateway é™æµ</li><li class="level-3 toc-link-_1-é™æµç­–ç•¥" data-v-86932056>1. é™æµç­–ç•¥</li><li class="level-3 toc-link-_2-gateway-è‡ªå®šä¹‰è¿‡æ»¤å™¨é™æµ" data-v-86932056>2. Gateway è‡ªå®šä¹‰è¿‡æ»¤å™¨é™æµ</li><li class="level-2 toc-link-nacos-å¾®æœåŠ¡-æ€»æ±‡" data-v-86932056>||-&gt; Nacos  å¾®æœåŠ¡ æ€»æ±‡</li><li class="level-3 toc-link-ä¾èµ–-2" data-v-86932056>ä¾èµ–</li><li class="level-3 toc-link-nacos-æ³¨è§£-2" data-v-86932056>Nacos  æ³¨è§£</li></ul></div> <div class="search-page" data-v-60b9a85e><span class="search-close"><svg aria-hidden="true" width="34.56" height="34.56" viewBox="-75.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon" style="font-size:2.16em;"><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg></span> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="menu-btn-container" data-v-413dbfb4 data-v-60b9a85e><div class="menu-btn-wrapper" data-v-413dbfb4><div class="menu-btn" data-v-413dbfb4><div class="menu-btn-icon" style="display:;" data-v-413dbfb4><span data-v-413dbfb4></span> <span data-v-413dbfb4></span> <span data-v-413dbfb4></span></div> <div class="menu-text" style="display:none;" data-v-413dbfb4>
        0
      </div> <svg class="menu-svg" data-v-413dbfb4><circle cx="50%" cy="50%" r="48%" class="menu-border" style="stroke-dasharray:0% 314.15926%;" data-v-413dbfb4></circle></svg></div> <div class="menu-btn-child-wrapper" data-v-413dbfb4><a role="button" aria-label="Toggle light" title="Toggle light" class="toggle-mode menu-btn-child" data-v-413dbfb4><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon" style="font-size:1.2em;"><path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38C411.53 3.12 403.34 0 395.15 0c-8.19 0-16.38 3.12-22.63 9.38L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c6.25 6.25 14.44 9.37 22.62 9.37 8.19 0 16.38-3.12 22.63-9.37l363.14-363.15c12.5-12.48 12.5-32.75 0-45.24zM359.45 203.46l-50.91-50.91 86.6-86.6 50.91 50.91-86.6 86.6z"/></svg></a> <div class="menu-btn-child" data-v-413dbfb4><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-75.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon" style="font-size:1.2em;" data-v-413dbfb4><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg></div> <div class="menu-btn-child" data-v-413dbfb4><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-75.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon" style="font-size:1.2em;" data-v-413dbfb4><path d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"/></svg></div> <div class="menu-btn-child menu-toc-btn" data-v-413dbfb4><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-43.52 -43.52 599.04 599.04" fill="currentColor" class="ov-icon" style="font-size:1.2em;" data-v-413dbfb4><path d="M48 48a48 48 0 1048 48 48 48 0 00-48-48zm0 160a48 48 0 1048 48 48 48 0 00-48-48zm0 160a48 48 0 1048 48 48 48 0 00-48-48zm448 16H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16z"/></svg></div> <div class="menu-btn-child menu-btn-sidebar" data-v-413dbfb4><svg aria-hidden="true" width="19.2" height="19.2" viewBox="-1.6 -1.6 19.2 19.2" fill="currentColor" class="ov-icon" style="font-size:1.2em;" data-v-413dbfb4><path d="M14 2a1 1 0 011 1v10a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1h12zM2 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2H2z"/><path d="M3 4a1 1 0 011-1h2a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/></svg></div></div></div></div> <div class="footer-wrapper footer" data-v-2f609db5 data-v-60b9a85e><span data-v-2f609db5>
      &copy; <a href="https://lujunandapai.github.io/" target="_blank">æ˜¯é˜¿æ´¾å•Š! </a> 2000 - 2024
      <br>
      ç¥æˆ‘ä»¬ - <a href="https://gitee.com/LuisApai" target="_blank">å¹³å®‰å–œä¹</a> &
      <a href="https://github.com/LuJunandapai" target="_blank">ä¸‡äº‹é¡ºé‚</a>
    </span></div></div><div class="global-ui"></div></div>
    <script src="/Welcome/assets/js/app.516fe79a.js" defer></script><script src="/Welcome/assets/js/8.d7055a2e.js" defer></script><script src="/Welcome/assets/js/1.ed48a7ee.js" defer></script><script src="/Welcome/assets/js/2.9a3f7cc9.js" defer></script><script src="/Welcome/assets/js/45.2c55d04e.js" defer></script>
  </body>
</html>
